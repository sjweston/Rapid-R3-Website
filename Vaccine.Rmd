---
title: "Vaccine March 2021"
author: "Sihong"
date: "3/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include = FALSE}
library(here)
library(knitr)
library(readr)
library(haven)
library(tidyverse)
library(lavaan)
```


```{r, echo=FALSE, message = FALSE}
#Define functions
moe.p = function(p, n){
  q = 1-p
  moe = 1.96*sqrt((p*q)/n)
  return(moe)
}

moe.m = function(sd,n){
  moe = 1.96*sd/sqrt(n)
  return(moe)}

combine.cat = function(x, cols, id, newvar.name){
  subset = x[,c(id, "Week", cols)]
  names(subset) = c("id", "Week", paste0("X",1:length(cols)))
  subset = suppressWarnings(gather(subset, "key", "value", -id, -Week))
  subset = filter(subset, !is.na(value))
  subset$key = gsub("X", "", subset$key)
  subset = group_by(subset, id, Week)
  subset = summarise(subset, newvar = paste(key, collapse = ",")) %>% ungroup()
  names(subset) = c(id,"Week", newvar.name)
  x = suppressMessages(full_join(x, subset))
  return(x)
}

find_items = function(string, data2){
  items = names(data2)
  locations = which(grepl(string, items))
  final = items[locations]
  return(final)
}

my.max = function(x) ifelse (!all(is.na(x)), max(x,na.rm = TRUE), NA)
my.min = function(x) ifelse (!all(is.na(x)), min(x,na.rm = TRUE), NA)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE, include=FALSE}
master_2020 <- read_sav(here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2020.sav"))
master_2021 <- read_sav(here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2021.sav"))

master <- full_join (master_2020, master_2021)

# Remove cases should be excluded
master <- master %>%
  filter ( CaregiverID != "" & is.na(Exclude) == T)

master = master %>%
  group_by(CaregiverID, Week) %>%
  filter(row_number() == max(row_number())) %>%
  ungroup()

total_week <- my.max(master$Week)

```


```{r, echo=FALSE, message = FALSE, warning = FALSE}
#Code demographics
master <- master %>%
  mutate (month = case_when(
                  Week == 0 ~ "Pre-COVID",
                  Week >0 & Week <= 4 ~ "April",
                  Week >=5 & Week <=8 ~ "May",
                  Week >=9 & Week <=13 ~ "June",
                  Week >=14 & Week <=17 ~ "July",
                  Week >=18 & Week <=21 ~ "August",
                  Week >=22 & Week <=26 ~ "September",
                  Week >=27 ~ "October"), 
           baseline = case_when (Week - BaselineWeek == 1 ~ 1, 
                                 Week - BaselineWeek > 1 ~ 0))

##Race/ethnicity - 1 = black, 2 = latinx, 3 = white

master <- master %>%
  mutate (RaceGroup = na_if (RaceGroup, 99))%>%
    mutate(
      minority = ifelse(RaceGroup != 5, 1, 0),
      black = ifelse(RaceGroup == 3, 1, 0),
      native = ifelse(RaceGroup == 1, 1, 0),
      asian = ifelse(RaceGroup == 2, 1, 0),
      hawaii = ifelse(RaceGroup == 4, 1, 0),
      white = ifelse(RaceGroup == 5, 1, 0),
      other_race = ifelse(RaceGroup %in% c(6, 7), 1, 0))

master <- master %>%
      mutate(latinx = case_when(
        DEMO.008 == 1 ~ 1,
        DEMO.008 == 0 ~ 0,
        DEMO.008.2 == 0 ~ 0,
        DEMO.008.2 == 1 ~ 1,
        DEMO.008.2 == 2 ~ 1,
        TRUE ~ NA_real_))

master <- master %>%
mutate (race_ethnic = case_when(
      black == 1 ~ "1",
      latinx == 1 ~ "2",
      !is.na(black) ~ "3",
      !is.na(latinx) ~ "3",
      TRUE ~ NA_character_))  

##Povertyline - 0 = high income, 1 = low income
master <- master %>%
  mutate (poverty_cat = FPL.2019.UM.150)

#Material hardship
master <- master %>%
  combine.cat(cols = find_items("FSTR.002_.{1}$", master), 
              id = "CaregiverID",
              newvar.name = "FSTR.002_cat")
  

master <- master %>%
  mutate (diff_pay_food = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("1", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_), 
          diff_pay_utilities = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("3", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_house = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("2", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_healthcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("4", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_social = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("5", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_emotional = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("6", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_childcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("7", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_other = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("8", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_))

master <- master %>%
  rowwise() %>%
  mutate(material_hardship = case_when(
    Week == 0 ~ NA_real_,
    TRUE ~ sum(c_across(starts_with("diff_pay_")), na.rm=T))) %>%
  ungroup() %>%
  mutate(num_hardship = material_hardship,
    material_hardship = ifelse(material_hardship > 0, 1, 0)) 

## Children with special needs
master <- combine.cat(x = master, 
                       cols = find_items("HEALTH.005_[0-9]{1}$", master), 
                       id = "CaregiverID",
                       newvar.name = "HEALTH.005_cat")
master <- master %>%
   mutate (disability = case_when (HEALTH.005_1 == 1 ~ 1,
                                   HEALTH.005_2 == 1 ~ 1,
                                   HEALTH.005_3 == 1 ~ 1,
                                   HEALTH.005_4 == 1 ~ 1,
                                   HEALTH.005_5 == 1 ~ 0,
                                   HEALTH.005_6 == 1 ~ 1,
                                   TRUE ~ NA_real_))


## Single parent status
master <- master %>%
  mutate (single = case_when (
                   DEMO.002 %in% c(3,4,5,7,8)~1, 
                   DEMO.011 %in% c(2,4)~1,
                   !is.na(DEMO.002)~0,
                   !is.na(DEMO.011)~0,
                   TRUE ~ NA_real_))
                     
## Employment status
master <- combine.cat (x = master,
                       cols = find_items ("JOB.010_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.010_cat")
  
master$JOB.010_cat = gsub("10", "0", master$JOB.010_cat)
master$working_pre = ifelse (grepl("[1,2,6]", master$JOB.010_cat), 1, 0)
master = combine.cat (x = master,
                       cols = find_items ("JOB.008_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.008_cat")
master$JOB.008_cat = gsub("10", "0", master$JOB.008_cat)
master <- master %>%
  mutate (work_status = case_when(
                        grepl ("1", JOB.008_cat) ~ "1", 
                        grepl ("2", JOB.008_cat) ~ "1", 
                        grepl ("3", JOB.008_cat) ~ "0", 
                        grepl ("4", JOB.008_cat) ~ "0", 
                        grepl ("5", JOB.008_cat) ~ "1", 
                        JOB.008.2 == 1 ~ "1",
                        JOB.008.2 %in% c(2,3) ~ "0",
                        TRUE~NA_character_),
          work_status_pre = case_when(
                        grepl ("1", JOB.010_cat) ~ "1", 
                        grepl ("2", JOB.010_cat) ~ "1", 
                        grepl ("3", JOB.010_cat) ~ "0", 
                        grepl ("4", JOB.010_cat) ~ "0", 
                        grepl ("5", JOB.010_cat) ~ "1", 
                        TRUE~NA_character_))
#1 = stable employed 2 = became unemployed 3 = became employed4 = stable unemployed

# Region
master <- master %>%
  mutate (region = na_if (DEMO.001.b, 5))

master_dem <- master %>%
  group_by (CaregiverID) %>%
  summarise (BaselineWeek = my.max (BaselineWeek),
             race_ethnic = my.max(race_ethnic),
             poverty_cat = my.max(poverty_cat),
             disability = my.max (disability),
             single = my.max (single),
             work_status = my.max (work_status),
             work_status_pre = my.max (work_status_pre), 
             region = my.max(region), 
             gender = my.min(DEMO.006))%>%
  mutate ( ep_change = case_when(
                        work_status == 1 & work_status_pre == 1 ~ "1", 
                        work_status == 1 & work_status_pre == 0 ~ "2", 
                        work_status == 0 & work_status_pre == 1 ~ "3", 
                        work_status == 0 & work_status_pre == 0 ~ "4", 
                        TRUE~NA_character_))%>%
  mutate (race_ethnic = case_when (
                        race_ethnic == 1 ~ "Black", 
                        race_ethnic == 2 ~ "Latinx", 
                        race_ethnic == 3 ~ "White", 
                        TRUE~NA_character_),
          poverty_cat = case_when (
                        poverty_cat == 1 ~ "Below 150%FPL", 
                        poverty_cat == 0 ~ "Above 150%FPL", 
                        TRUE~NA_character_),
          disability = case_when (
                        disability == 1 ~ "With disability", 
                        disability == 0 ~ "Without disability", 
                        TRUE~NA_character_),
          single = case_when (
                        single == 1 ~ "Single parent", 
                        single == 0 ~ "Dual parent", 
                        TRUE~NA_character_),
          work_status = case_when (
                        work_status == 1 ~ "Employed", 
                        work_status == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          work_status_pre = case_when (
                        work_status_pre == 1 ~ "Employed", 
                        work_status_pre == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          ep_change = case_when (
                        ep_change == 1 ~ "Stable employed", 
                        ep_change == 2 ~ "Became employed", 
                        ep_change == 3 ~ "Became unemployed",
                        ep_change == 4 ~ "Stable unemployed",
                        TRUE~NA_character_), 
          region = case_when (
                        region == 1 ~ "Northeast", 
                        region == 2 ~ "Midwest", 
                        region == 3 ~ "South", 
                        region == 4 ~ "West",
                        TRUE~NA_character_))
```



```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine <- master %>%
  select (CaregiverID, StartDate, Week, contains ("HEALTH.016"), contains ("HEALTH.017"), contains ("HEALTH.020"), contains("HEALTH.021"), HEALTH.022, HEALTH.023, HEALTH.025, HEALTH.026, HEALTH.027, contains ("HEALTH.028") ,  contains ("HEALTH.029"))%>%
  filter (Week %in% c(25,27,29,31,33,35,41,43,45,49))

vaccine <- merge (x = vaccine, y = master_dem, by.x = "CaregiverID", by.y = "CaregiverID", all.x = T)

num_responses = function(x){length(which(!is.na(x)))}
vaccine.num <- vaccine %>%
  group_by(Week) %>%
  summarize_all(num_responses) %>%
  gather("Variable", "num_responses",-Week) %>%
  mutate(week = paste0("Week", Week),
         week = factor(Week, levels = paste0("Week", c(1:total_week)))) %>%
  spread(Week, num_responses)

vaccine_rct <- vaccine %>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup()
```

# 0. Sample Disclaimer
  * This set of analyses on vaccine is based on responses collected from 4,076 caregivers between the dates of September 21st, 2020 and March 19th, 2021. These caregivers represent a range of voices: 6.80% are Black/African American, 11.93% are Latinx, and 26.60% live at or below 1.5 times the federal poverty line.  Proportions/percentages are calculated based on the item-level response rates, not out of the total sample size. The data for these analyses are not weighted. \


# 1. COVID Vaccine
  * Survey question: How likely are you to get the first generation COVID-19 vaccine, as soon as it's available? - very likely/somewhat likely/not very likely/not at all likely/already vaccinated\
  * How likely are you to get your child the first generation COVID-19 vaccine, as soon as it's available?- very likely/somewhat likely/not very likely/not at all likely/already vaccinated\
  * Note that "already vaccinated" option was added from week 43 (early February), so the % of participants reporting on this option before week 43 were all 0. \

```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.show='hide'}

## 1.1 Most recent responses
### 1.1.1 Overall

vaccine_parent <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.022 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.022 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.022 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.022 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.022 == 5, 1, 0))%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")
   
vaccine_child <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.023 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.023 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.023 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.023 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.023 == 5, 1, 0))%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
   
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = rsp)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -2,hjust = 0.5, size = 3, color = "black",  position = position_dodge(1))+
  facet_wrap(~who, ncol = 2)+
  theme(axis.text.x = element_text(angle = 90))


```


```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.show='hide'}
### 1.1.2 By race/ethnicity
vaccine_parent <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.022 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.022 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.022 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.022 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.022 == 5, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")
   
vaccine_child <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.023 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.023 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.023 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.023 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.023 == 5, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
   
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = rsp)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(who~race_ethnic, ncol = 3)+
  theme(axis.text.x = element_blank())


```


```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.show='hide'}
### 1.1.3 By poverty level
vaccine_parent <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.022 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.022 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.022 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.022 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.022 == 5, 1, 0))%>%
  filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")
   
vaccine_child <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.023 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.023 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.023 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.023 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.023 == 5, 1, 0))%>%
  filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n,
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
   
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1,hjust = 0.5, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap(~who, ncol = 2)+
  theme(axis.text.x = element_text(angle = 90))


```


```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.show='hide'}
### 1.1.4 By poverty level & race/ethnicity
vaccine_parent <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.022 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.022 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.022 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.022 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.022 == 5, 1, 0))%>%
  filter (poverty_cat!= "NA" & race_ethnic!= "NA")%>%
  group_by (poverty_cat, race_ethnic)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n,
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")
   
vaccine_child <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   group_by (CaregiverID)%>%
   filter (Week == max (Week))%>%
   ungroup ()%>%
   mutate (a.very_likely = ifelse (HEALTH.023 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.023 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.023 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.023 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.023 == 5, 1, 0))%>%
  filter (poverty_cat!= "NA" & race_ethnic!= "NA")%>%
  group_by (poverty_cat, race_ethnic)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n,
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n)%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
   
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         

vaccine_smy %>%
  ggplot(mapping = aes (x =  rsp, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = ci_low*100, 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,0)),vjust = -2,hjust = 0.5, size = 2, color = "black",  position = position_dodge(1))+
  facet_wrap(who~race_ethnic, ncol = 3)+
  theme(axis.text.x = element_text(angle = 90))
```

## 1.1 How Likely to Get COVID-19 Vaccine
### 1.1.1 Overall
```{r, echo=FALSE, message = FALSE, warning = FALSE}

vaccine_parent <- vaccine %>%
   filter (Week != 25 & Week != 27 & Week != 49)%>%
   mutate (a.very_likely = ifelse (HEALTH.022 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.022 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.022 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.022 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.022 == 5, 1, 0))%>%
  group_by (Week)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n,
              date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")
   
vaccine_child <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   mutate (a.very_likely = ifelse (HEALTH.023 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.023 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.023 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.023 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.023 == 5, 1, 0))%>%
  group_by (Week)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n,
              date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
   
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         
date <- vaccine %>%
  group_by (Week)%>%
  summarise (date = min (StartDate))%>%
  ungroup()


vaccine_smy %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = rsp)) +
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle(label = "Trend of changes")+
  facet_wrap(~who, nrow = 2)

```

### 1.1.2 By race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}

vaccine_parent <- vaccine %>%
   filter (Week != 25 & Week != 27 & Week != 49)%>%
   mutate (a.very_likely = ifelse (HEALTH.022 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.022 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.022 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.022 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.022 == 5, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (Week, race_ethnic)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n,
              date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")
   
vaccine_child <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   mutate (a.very_likely = ifelse (HEALTH.023 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.023 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.023 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.023 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.023 == 5, 1, 0))%>%
   filter (race_ethnic!= "NA")%>%
  group_by (Week, race_ethnic)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n,
              date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
   
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         
date <- vaccine %>%
  group_by (Week)%>%
  summarise (date = min (StartDate))%>%
  ungroup()


vaccine_smy %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = rsp)) +
  #geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle(label = "Trend of changes")+
  facet_wrap(who~race_ethnic, nrow = 2)

```

### 1.1.3 By poverty level
```{r, echo=FALSE, message = FALSE, warning = FALSE}

vaccine_parent <- vaccine %>%
   filter (Week != 25 & Week != 27 & Week != 49)%>%
   mutate (a.very_likely = ifelse (HEALTH.022 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.022 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.022 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.022 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.022 == 5, 1, 0))%>%
  filter (poverty_cat!= "NA")%>%
  group_by (Week, poverty_cat)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n,
              date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "caregiver")
   
vaccine_child <- vaccine %>%
   filter (Week != 25 & Week != 27)%>%
   mutate (a.very_likely = ifelse (HEALTH.023 == 1, 1, 0),
           b.somewhat_likely = ifelse (HEALTH.023 == 2, 1, 0),
           c.not_very_likely = ifelse (HEALTH.023 == 3, 1, 0),
           d.not_at_all_likely = ifelse (HEALTH.023 == 4, 1, 0), 
           e.already_vaccinated = ifelse (HEALTH.023 == 5, 1, 0))%>%
   filter (poverty_cat!= "NA")%>%
  group_by (Week, poverty_cat)%>%
   summarise (n = n(),
              a.very_likely = sum(a.very_likely, na.rm = T)/n,
              b.somewhat_likely = sum(b.somewhat_likely, na.rm = T)/n,
              c.not_very_likely = sum(c.not_very_likely, na.rm = T)/n, 
              d.not_at_all_likely = sum(d.not_at_all_likely, na.rm = T)/n, 
              e.already_vaccinated = sum(e.already_vaccinated, na.rm = T)/n,
              date = as.Date(min (StartDate)))%>%
   pivot_longer (cols = c("a.very_likely", "b.somewhat_likely", "c.not_very_likely", "d.not_at_all_likely", "e.already_vaccinated"), names_to = "rsp", values_to = "prop")%>%
   mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          who = "child")
   
vaccine_smy <- rbind (vaccine_parent, vaccine_child)         
date <- vaccine %>%
  group_by (Week)%>%
  summarise (date = min (StartDate))%>%
  ungroup()


vaccine_smy %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = rsp)) +
  #geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle(label = "Trend of changes")+
  facet_wrap(who~poverty_cat, nrow = 2)

```

## 1.2 Parent Have Got Vaccine
  * Survey question:  Have you received the COVID-19 vaccine? - yes/no\
  * Why have you not yet received the COVID-19 vaccine? \
    + I am not eligible yet, based on my age, type of job, etc.\
    + I am eligible but I haven't gotten vaccinated because I have not been able to get an appointment\
    + I am eligible but I haven't gotten vaccinated because I don't know how to get an appointment to get vaccinated\
    + I am eligible but I haven't gotten vaccinated because I can't get to a vaccination site due to where I live, time off from work, etc.\
    + I am eligible but I haven't gotten vaccinated because I am planning to ?wait and see? the vaccine is safe and effective\
    + I am eligible but I haven't gotten vaccinated because I do not believe the vaccine is safe/effective\
    + Other\

```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_49 <- vaccine %>%
  filter (Week == 49)%>%
  mutate (a.have_received_vaccine = ifelse (HEALTH.025 == 1, 1, 0), 
          b.havent_not_eligible = ifelse (HEALTH.025 == 2 & HEALTH.026 == 1, 1, 0), 
          b.havent_cannot_get_appointment = ifelse (HEALTH.025 == 2 & HEALTH.026 == 2, 1, 0), 
          b.havent_dont_know_how_get_appointment = ifelse (HEALTH.025 == 2 & HEALTH.026 == 3, 1, 0), 
          b.havent_cannot_get_to_vaccine_site = ifelse (HEALTH.025 == 2 & HEALTH.026 == 4, 1, 0), 
          b.havent_wait_see_safe_effective = ifelse (HEALTH.025 == 2 & HEALTH.026 == 5, 1, 0), 
          b.havent_not_believe_safe_effective = ifelse (HEALTH.025 == 2 & HEALTH.026 == 6, 1, 0), 
          b.havent_other = ifelse (HEALTH.025 == 2 & HEALTH.026 == 7, 1, 0))

vaccine_smy <- vaccine_49 %>%
  summarise (n = n (),
             a.have_received_vaccine = sum (a.have_received_vaccine, na.rm = T)/n, 
             b.havent_not_eligible = sum (b.havent_not_eligible, na.rm = T)/n, 
             b.havent_cannot_get_appointment = sum (b.havent_cannot_get_appointment, na.rm = T)/n, 
             b.havent_dont_know_how_get_appointment = sum (b.havent_dont_know_how_get_appointment, na.rm = T)/n, 
             b.havent_cannot_get_to_vaccine_site = sum (b.havent_cannot_get_to_vaccine_site, na.rm = T)/n, 
             b.havent_wait_see_safe_effective = sum (b.havent_wait_see_safe_effective, na.rm = T)/n, 
             b.havent_not_believe_safe_effective = sum (b.havent_not_believe_safe_effective, na.rm = T)/n, 
             b.havent_other = sum (b.havent_other, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.have_received_vaccine", "b.havent_not_eligible", "b.havent_cannot_get_appointment", "b.havent_dont_know_how_get_appointment", "b.havent_cannot_get_to_vaccine_site", "b.havent_wait_see_safe_effective", "b.havent_not_believe_safe_effective", "b.havent_other"), names_to = "condition", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          have_receive = case_when (condition == "a.have_received_vaccine" ~ "Have received", 
                                    condition != "a.have_received_vaccine" ~ "Have not received"))

vaccine_smy %>%
  ggplot(mapping = aes (y = reorder (condition, -prop), x = prop*100, fill = condition)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position =  position_dodge(1))+ 
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +           # stacked bar chart: position = "stack"
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position =  position_dodge(1))+
  facet_wrap (~have_receive)+
  theme(legend.position = "none")
  
```

### 1.2.1 By race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_smy <- vaccine_49 %>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n (),
             a.have_received_vaccine = sum (a.have_received_vaccine, na.rm = T)/n, 
             b.havent_not_eligible = sum (b.havent_not_eligible, na.rm = T)/n, 
             b.havent_cannot_get_appointment = sum (b.havent_cannot_get_appointment, na.rm = T)/n, 
             b.havent_dont_know_how_get_appointment = sum (b.havent_dont_know_how_get_appointment, na.rm = T)/n, 
             b.havent_cannot_get_to_vaccine_site = sum (b.havent_cannot_get_to_vaccine_site, na.rm = T)/n, 
             b.havent_wait_see_safe_effective = sum (b.havent_wait_see_safe_effective, na.rm = T)/n, 
             b.havent_not_believe_safe_effective = sum (b.havent_not_believe_safe_effective, na.rm = T)/n, 
             b.havent_other = sum (b.havent_other, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.have_received_vaccine", "b.havent_not_eligible", "b.havent_cannot_get_appointment", "b.havent_dont_know_how_get_appointment", "b.havent_cannot_get_to_vaccine_site", "b.havent_wait_see_safe_effective", "b.havent_not_believe_safe_effective", "b.havent_other"), names_to = "condition", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          have_receive = case_when (condition == "a.have_received_vaccine" ~ "Have received", 
                                    condition != "a.have_received_vaccine" ~ "Have not received"))

vaccine_smy %>%
  ggplot(mapping = aes (y = reorder (condition, -prop), x = prop*100, fill = condition)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position =  position_dodge(1))+ 
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +           # stacked bar chart: position = "stack"
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position =  position_dodge(1))+
  facet_wrap (race_ethnic~have_receive, nrow = 3)+
  theme(legend.position = "none")
  
```

### 1.2.2 By poverty level
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_smy <- vaccine_49 %>%
  filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
  summarise (n = n (),
             a.have_received_vaccine = sum (a.have_received_vaccine, na.rm = T)/n, 
             b.havent_not_eligible = sum (b.havent_not_eligible, na.rm = T)/n, 
             b.havent_cannot_get_appointment = sum (b.havent_cannot_get_appointment, na.rm = T)/n, 
             b.havent_dont_know_how_get_appointment = sum (b.havent_dont_know_how_get_appointment, na.rm = T)/n, 
             b.havent_cannot_get_to_vaccine_site = sum (b.havent_cannot_get_to_vaccine_site, na.rm = T)/n, 
             b.havent_wait_see_safe_effective = sum (b.havent_wait_see_safe_effective, na.rm = T)/n, 
             b.havent_not_believe_safe_effective = sum (b.havent_not_believe_safe_effective, na.rm = T)/n, 
             b.havent_other = sum (b.havent_other, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.have_received_vaccine", "b.havent_not_eligible", "b.havent_cannot_get_appointment", "b.havent_dont_know_how_get_appointment", "b.havent_cannot_get_to_vaccine_site", "b.havent_wait_see_safe_effective", "b.havent_not_believe_safe_effective", "b.havent_other"), names_to = "condition", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          have_receive = case_when (condition == "a.have_received_vaccine" ~ "Have received", 
                                    condition != "a.have_received_vaccine" ~ "Have not received"))

vaccine_smy %>%
  ggplot(mapping = aes (y = reorder (condition, -prop), x = prop*100, fill = condition)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position =  position_dodge(1))+ 
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +           # stacked bar chart: position = "stack"
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position =  position_dodge(1))+
  facet_wrap (poverty_cat~have_receive, nrow = 2)+
  theme(legend.position = "none")
  
```

## 1.3 People's Changed Feelings for the Vaccine
  * Survey question: Have your feelings about getting the COVID-19 vaccine changed since it became available?\
    + No change in my overall feelings\
    + I'm more likely to get it than I was at first\
    + I'm less likely to get it than I was at first\
  * If you have become less likely to get the vaccine than you originally were, what are your reasons? Select all that apply. \
    + I have heard from friends/relatives that it is unsafe\
    + I have heard from TV or the internet that it is unsafe\
    + I no longer think I need it\
    + Other\

```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_49 <- vaccine_49 %>%
  mutate (no_change = ifelse (HEALTH.027 == 0, 1, 0), 
          more_likely_get = ifelse (HEALTH.027 == 1, 1, 0),
          less_likely_get = ifelse (HEALTH.027 == 2, 1, 0), 
          unsafe_friends_relatives = ifelse (HEALTH.027 == 2 & HEALTH.028_1 == 1, 1, 0), 
          unsafe_tv = ifelse (HEALTH.027 == 2 & HEALTH.028_2 == 1, 1, 0), 
          no_longer_need = ifelse (HEALTH.027 == 2 & HEALTH.028_3 == 1, 1, 0), 
          other = ifelse (HEALTH.027 == 2 & HEALTH.028_4 == 1, 1, 0))

vaccine_smy <- vaccine_49 %>%
  summarise (n = n (),
             no_change = sum (no_change, na.rm = T)/n, 
             more_likely_get = sum (more_likely_get, na.rm = T)/n, 
             less_likely_get = sum (less_likely_get, na.rm = T)/n)%>%
  pivot_longer (cols = c("no_change", "more_likely_get", "less_likely_get"), names_to = "condition", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

vaccine_smy %>%
  ggplot(mapping = aes (y = condition, x = prop*100, fill = condition)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position =  position_dodge(1))+ 
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +           # stacked bar chart: position = "stack"
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position =  position_dodge(1))+
  theme(legend.position = "none")

vaccine_smy <- vaccine_49 %>%
  filter (less_likely_get == 1)%>%
  summarise (n = n (),
             unsafe_friends_relatives = sum (unsafe_friends_relatives, na.rm = T)/n, 
             unsafe_tv = sum (unsafe_tv, na.rm = T)/n, 
             no_longer_need = sum (no_longer_need, na.rm = T)/n, 
             other = sum (other, na.rm = T)/n)%>%
  pivot_longer (cols = c("unsafe_friends_relatives", "unsafe_tv", "no_longer_need", "other"), names_to = "condition", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

vaccine_smy %>%
  ggplot(mapping = aes (y = reorder(condition, -prop), x = prop*100, fill = condition)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position =  position_dodge(1))+ 
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +           # stacked bar chart: position = "stack"
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position =  position_dodge(1))+
  theme(legend.position = "none")+
  ggtitle(label = "Only among 41 who reported less likely to get vaccinated")

```

### 1.3.1 By race/ethnicity
  * Group analyses only conducted for the general attitude change. Reasons for participants reporting less likely to get vaccinated were not included because of the small sample size.\
  
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_smy <- vaccine_49 %>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n (),
             no_change = sum (no_change, na.rm = T)/n, 
             more_likely_get = sum (more_likely_get, na.rm = T)/n, 
             less_likely_get = sum (less_likely_get, na.rm = T)/n)%>%
  pivot_longer (cols = c("no_change", "more_likely_get", "less_likely_get"), names_to = "condition", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

vaccine_smy %>%
  ggplot(mapping = aes (y = condition, x = prop*100, fill = condition)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position =  position_dodge(1))+ 
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +           # stacked bar chart: position = "stack"
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position =  position_dodge(1))+
  theme(legend.position = "none")+
  facet_wrap (~race_ethnic, nrow = 3)



```


### 1.3.2 By poverty level
  
```{r, echo=FALSE, message = FALSE, warning = FALSE}
vaccine_smy <- vaccine_49 %>%
  filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
  summarise (n = n (),
             no_change = sum (no_change, na.rm = T)/n, 
             more_likely_get = sum (more_likely_get, na.rm = T)/n, 
             less_likely_get = sum (less_likely_get, na.rm = T)/n)%>%
  pivot_longer (cols = c("no_change", "more_likely_get", "less_likely_get"), names_to = "condition", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

vaccine_smy %>%
  ggplot(mapping = aes (y = condition, x = prop*100, fill = condition)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position =  position_dodge(1))+ 
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +           # stacked bar chart: position = "stack"
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position =  position_dodge(1))+
  theme(legend.position = "none")+
  facet_wrap (~poverty_cat, nrow = 2)
```
