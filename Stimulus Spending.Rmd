---
title: "Stimulus Spending"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, include = FALSE}
library(here)
library(knitr)
library(readr)
library(haven)
library(tidyverse)
library(lavaan)
```


```{r, echo=FALSE, message = FALSE}
#Define functions
moe.p = function(p, n){
  q = 1-p
  moe = 1.96*sqrt((p*q)/n)
  return(moe)
}

moe.m = function(sd,n){
  moe = 1.96*sd/sqrt(n)
  return(moe)}

combine.cat = function(x, cols, id, newvar.name){
  subset = x[,c(id, "Week", cols)]
  names(subset) = c("id", "Week", paste0("X",1:length(cols)))
  subset = suppressWarnings(gather(subset, "key", "value", -id, -Week))
  subset = filter(subset, !is.na(value))
  subset$key = gsub("X", "", subset$key)
  subset = group_by(subset, id, Week)
  subset = summarise(subset, newvar = paste(key, collapse = ",")) %>% ungroup()
  names(subset) = c(id,"Week", newvar.name)
  x = suppressMessages(full_join(x, subset))
  return(x)
}

find_items = function(string, data2){
  items = names(data2)
  locations = which(grepl(string, items))
  final = items[locations]
  return(final)
}

my.max = function(x) ifelse (!all(is.na(x)), max(x,na.rm = TRUE), NA)
my.min = function(x) ifelse (!all(is.na(x)), min(x,na.rm = TRUE), NA)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE, include=FALSE}
#OR load master data file
master_2020 <- read_sav(here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2020.sav"))
master_2021 <- read_sav(here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2021.sav"))

master <- full_join (master_2020, master_2021)

# Remove cases should be excluded
master <- master %>%
  filter ( CaregiverID != "" & is.na(Exclude) == T)

master = master %>%
  group_by(CaregiverID, Week) %>%
  filter(row_number() == max(row_number())) %>%
  ungroup()

total_week <- my.max(master$Week)


```


```{r, echo=FALSE, message = FALSE, warning = FALSE}
#Code demographics
master <- master %>%
  mutate (month = case_when(
                  Week == 0 ~ "Pre-COVID",
                  Week >0 & Week <= 4 ~ "April",
                  Week >=5 & Week <=8 ~ "May",
                  Week >=9 & Week <=13 ~ "June",
                  Week >=14 & Week <=17 ~ "July",
                  Week >=18 & Week <=21 ~ "August",
                  Week >=22 & Week <=26 ~ "September",
                  Week >=27 ~ "October"), 
           baseline = case_when (Week - BaselineWeek == 1 ~ 1, 
                                 Week - BaselineWeek > 1 ~ 0))

##Race/ethnicity - 1 = black, 2 = latinx, 3 = white

master <- master %>%
  mutate (RaceGroup = na_if (RaceGroup, 99))%>%
    mutate(
      minority = ifelse(RaceGroup != 5, 1, 0),
      black = ifelse(RaceGroup == 3, 1, 0),
      native = ifelse(RaceGroup == 1, 1, 0),
      asian = ifelse(RaceGroup == 2, 1, 0),
      hawaii = ifelse(RaceGroup == 4, 1, 0),
      white = ifelse(RaceGroup == 5, 1, 0),
      other_race = ifelse(RaceGroup %in% c(6, 7), 1, 0))

master <- master %>%
      mutate(latinx = case_when(
        DEMO.008 == 1 ~ 1,
        DEMO.008 == 0 ~ 0,
        DEMO.008.2 == 0 ~ 0,
        DEMO.008.2 == 1 ~ 1,
        DEMO.008.2 == 2 ~ 1,
        TRUE ~ NA_real_))

master <- master %>%
mutate (race_ethnic = case_when(
      black == 1 ~ "1",
      latinx == 1 ~ "2",
      !is.na(black) ~ "3",
      !is.na(latinx) ~ "3",
      TRUE ~ NA_character_))  

##Povertyline - 0 = high income, 1 = low income
master <- master %>%
  mutate (poverty_100 = FPL.2019.UM.100, 
          poverty_200 = FPL.2019.UM.200, 
          poverty_3c = case_when (FPL.2019.UM == 1 ~ 1,
                                  FPL.2019.UM %in% c(2,3,4)~ 2,
                                  FPL.2019.UM == 5 ~ 3))

master <- master %>%
  mutate (FPL_line = case_when (STATE_CODED == 1 & JOB.002 == 1 ~ 12760,
                                STATE_CODED == 1 & JOB.002 == 2 ~ 17240,
                                STATE_CODED == 1 & JOB.002 == 3 ~ 21720,
                                STATE_CODED == 1 & JOB.002 == 4 ~ 26200,
                                STATE_CODED == 1 & JOB.002 == 5 ~ 30680,
                                STATE_CODED == 1 & JOB.002 == 6 ~ 35160,
                                STATE_CODED == 1 & JOB.002 == 7 ~ 39640,
                                STATE_CODED == 1 & JOB.002 == 8 ~ 44120,
                                STATE_CODED == 1 & JOB.002 == 9 ~ 48600,
                                STATE_CODED == 1 & JOB.002 == 10 ~ 53080,
                                STATE_CODED == 1 & JOB.002 == 11 ~ 57560,
                                STATE_CODED == 1 & JOB.002 == 12 ~ 62040,
                                STATE_CODED == 1 & JOB.002 == 13 ~ 66520,
                                STATE_CODED == 1 & JOB.002 == 14 ~ 71000,
                                STATE_CODED == 1 & JOB.002 == 15 ~ 75480,
                                STATE_CODED == 1 & JOB.002 == 16 ~ 79960,
                                STATE_CODED == 1 & JOB.002 == 17 ~ 84440,
                                STATE_CODED == 1 & JOB.002 == 18 ~ 88920,
                                STATE_CODED == 1 & JOB.002 == 19 ~ 93400,
                                STATE_CODED == 1 & JOB.002 == 20 ~ 97880,
                                STATE_CODED == 1 & JOB.002 == 21 ~ 102360, 
                                STATE_CODED == 2 & JOB.002 == 1 ~ 15950,
                                STATE_CODED == 2 & JOB.002 == 2 ~ 21550,
                                STATE_CODED == 2 & JOB.002 == 3 ~ 27150,
                                STATE_CODED == 2 & JOB.002 == 4 ~ 32750,
                                STATE_CODED == 2 & JOB.002 == 5 ~ 38350,
                                STATE_CODED == 2 & JOB.002 == 6 ~ 43950,
                                STATE_CODED == 2 & JOB.002 == 7 ~ 49550,
                                STATE_CODED == 2 & JOB.002 == 8 ~ 55150,
                                STATE_CODED == 2 & JOB.002 == 9 ~ 60750,
                                STATE_CODED == 2 & JOB.002 == 10 ~ 66350,
                                STATE_CODED == 2 & JOB.002 == 11 ~ 71950,
                                STATE_CODED == 2 & JOB.002 == 12 ~ 77550,
                                STATE_CODED == 2 & JOB.002 == 13 ~ 83150,
                                STATE_CODED == 2 & JOB.002 == 14 ~ 88750,
                                STATE_CODED == 2 & JOB.002 == 15 ~ 94350,
                                STATE_CODED == 2 & JOB.002 == 16 ~ 99950,
                                STATE_CODED == 2 & JOB.002 == 17 ~ 105550,
                                STATE_CODED == 2 & JOB.002 == 18 ~ 111150,
                                STATE_CODED == 2 & JOB.002 == 19 ~ 116750,
                                STATE_CODED == 2 & JOB.002 == 20 ~ 122350,
                                STATE_CODED == 2 & JOB.002 == 21 ~ 127950,
                                STATE_CODED == 3 & JOB.002 == 1 ~ 14680,
                                STATE_CODED == 3 & JOB.002 == 2 ~ 19830,
                                STATE_CODED == 3 & JOB.002 == 3 ~ 24980,
                                STATE_CODED == 3 & JOB.002 == 4 ~ 30130,
                                STATE_CODED == 3 & JOB.002 == 5 ~ 35280,
                                STATE_CODED == 3 & JOB.002 == 6 ~ 40430,
                                STATE_CODED == 3 & JOB.002 == 7 ~ 45580,
                                STATE_CODED == 3 & JOB.002 == 8 ~ 50730,
                                STATE_CODED == 3 & JOB.002 == 9 ~ 55880,
                                STATE_CODED == 3 & JOB.002 == 10 ~ 61030,
                                STATE_CODED == 3 & JOB.002 == 11 ~ 66180,
                                STATE_CODED == 3 & JOB.002 == 12 ~ 71330,
                                STATE_CODED == 3 & JOB.002 == 13 ~ 76480,
                                STATE_CODED == 3 & JOB.002 == 14 ~ 81630,
                                STATE_CODED == 3 & JOB.002 == 15 ~ 86780,
                                STATE_CODED == 3 & JOB.002 == 16 ~ 91930,
                                STATE_CODED == 3 & JOB.002 == 17 ~ 97080,
                                STATE_CODED == 3 & JOB.002 == 18 ~ 102230,
                                STATE_CODED == 3 & JOB.002 == 19 ~ 107380,
                                STATE_CODED == 3 & JOB.002 == 20 ~ 112530,
                                STATE_CODED == 3 & JOB.002 == 21 ~ 117680))

#Material hardship
master <- master %>%
  combine.cat(cols = find_items("FSTR.002_.{1}$", master), 
              id = "CaregiverID",
              newvar.name = "FSTR.002_cat")
  

master <- master %>%
  mutate (diff_pay_food = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("1", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_), 
          diff_pay_utilities = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("3", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_house = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("2", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_healthcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("4", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_social = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("5", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_emotional = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("6", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_childcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("7", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_other = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("8", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_))

master <- master %>%
  rowwise() %>%
  mutate(material_hardship = case_when(
    Week == 0 ~ NA_real_,
    TRUE ~ sum(c_across(starts_with("diff_pay_")), na.rm=T))) %>%
  ungroup() %>%
  mutate(num_hardship = material_hardship,
    material_hardship = ifelse(material_hardship > 0, 1, 0)) 

## Children with special needs
master <- combine.cat(x = master, 
                       cols = find_items("HEALTH.005_[0-9]{1}$", master), 
                       id = "CaregiverID",
                       newvar.name = "HEALTH.005_cat")
master <- master %>%
   mutate (disability = case_when (HEALTH.005_1 == 1 ~ 1,
                                   HEALTH.005_2 == 1 ~ 1,
                                   HEALTH.005_3 == 1 ~ 1,
                                   HEALTH.005_4 == 1 ~ 1,
                                   HEALTH.005_5 == 1 ~ 0,
                                   HEALTH.005_6 == 1 ~ 1,
                                   TRUE ~ NA_real_))


## Single parent status
master <- master %>%
  mutate (single = case_when (
                   DEMO.002 %in% c(3,4,5,7,8)~1, 
                   DEMO.011 %in% c(2,4)~1,
                   !is.na(DEMO.002)~0,
                   !is.na(DEMO.011)~0,
                   TRUE ~ NA_real_))
                     
## Employment status
master <- combine.cat (x = master,
                       cols = find_items ("JOB.010_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.010_cat")
  
master$JOB.010_cat = gsub("10", "0", master$JOB.010_cat)
master$working_pre = ifelse (grepl("[1,2,6]", master$JOB.010_cat), 1, 0)
master = combine.cat (x = master,
                       cols = find_items ("JOB.008_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.008_cat")
master$JOB.008_cat = gsub("10", "0", master$JOB.008_cat)
master <- master %>%
  mutate (work_status = case_when(
                        grepl ("1", JOB.008_cat) ~ "1", 
                        grepl ("2", JOB.008_cat) ~ "1", 
                        grepl ("3", JOB.008_cat) ~ "0", 
                        grepl ("4", JOB.008_cat) ~ "0", 
                        grepl ("5", JOB.008_cat) ~ "1", 
                        JOB.008.2 == 1 ~ "1",
                        JOB.008.2 %in% c(2,3) ~ "0",
                        TRUE~NA_character_),
          work_status_pre = case_when(
                        grepl ("1", JOB.010_cat) ~ "1", 
                        grepl ("2", JOB.010_cat) ~ "1", 
                        grepl ("3", JOB.010_cat) ~ "0", 
                        grepl ("4", JOB.010_cat) ~ "0", 
                        grepl ("5", JOB.010_cat) ~ "1", 
                        TRUE~NA_character_))
#1 = stable employed 2 = became unemployed 3 = became employed4 = stable unemployed

# Region
master <- master %>%
  mutate (region = na_if (DEMO.001.b, 5))

master_dem <- master %>%
  group_by (CaregiverID) %>%
  summarise (BaselineWeek = my.max (BaselineWeek),
             race_ethnic = my.max(race_ethnic),
             poverty_100 = my.max(poverty_100),
             poverty_200 = my.max(poverty_200),
             poverty_3c = my.min(poverty_3c),
             income19 = my.min (allyearly2019),
             FPL_line = my.min (FPL_line),
             disability = my.max (disability),
             num_hm = my.max (JOB.002),
             num_cd = my.max (DEMO.003),
             single = my.max (single),
             work_status = my.max (work_status),
             work_status_pre = my.max (work_status_pre), 
             region = my.max(region))%>%
  mutate ( ep_change = case_when(
                        work_status == 1 & work_status_pre == 1 ~ "1", 
                        work_status == 1 & work_status_pre == 0 ~ "2", 
                        work_status == 0 & work_status_pre == 1 ~ "3", 
                        work_status == 0 & work_status_pre == 0 ~ "4", 
                        TRUE~NA_character_), 
           num_adult = num_hm - num_cd, 
           FPL_pct = income19/FPL_line)%>%
  mutate (race_ethnic = case_when (
                        race_ethnic == 1 ~ "Black", 
                        race_ethnic == 2 ~ "Latinx", 
                        race_ethnic == 3 ~ "White", 
                        TRUE~NA_character_),
          poverty_100 = case_when (
                        poverty_100 == 1 ~ "Below 100%FPL", 
                        poverty_100 == 0 ~ "Above 100%FPL", 
                        TRUE~NA_character_),
          poverty_200 = case_when (
                        poverty_200 == 1 ~ "Below 200%FPL", 
                        poverty_200 == 0 ~ "Above 200%FPL", 
                        TRUE~NA_character_),
          poverty_3c = case_when (
                        poverty_3c == 1 ~ "1.Below 100%FPL", 
                        poverty_3c == 2 ~ "2.100-200%FPL", 
                        poverty_3c == 3 ~ "3.Above 200%FPL", 
                        TRUE~NA_character_),
          disability = case_when (
                        disability == 1 ~ "With disability", 
                        disability == 0 ~ "Without disability", 
                        TRUE~NA_character_),
          single = case_when (
                        single == 1 ~ "Single parent", 
                        single == 0 ~ "Dual parent", 
                        TRUE~NA_character_),
          work_status = case_when (
                        work_status == 1 ~ "Employed", 
                        work_status == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          work_status_pre = case_when (
                        work_status_pre == 1 ~ "Employed", 
                        work_status_pre == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          ep_change = case_when (
                        ep_change == 1 ~ "Stable employed", 
                        ep_change == 2 ~ "Became employed", 
                        ep_change == 3 ~ "Became unemployed",
                        ep_change == 4 ~ "Stable unemployed",
                        TRUE~NA_character_), 
          region = case_when (
                        region == 1 ~ "Northeast", 
                        region == 2 ~ "Midwest", 
                        region == 3 ~ "South", 
                        region == 4 ~ "West",
                        TRUE~NA_character_))
```


```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus <- master %>%
  select (CaregiverID, Week, contains ("STIM."))%>%
  filter (Week %in% c(43, 45))

stimulus <- merge (x = stimulus, y = master_dem, by.x = "CaregiverID", by.y = "CaregiverID", all.x = T)

num_responses = function(x){length(which(!is.na(x)))}
stimulus.num <- stimulus %>%
  group_by(Week) %>%
  summarize_all(num_responses) %>%
  gather("Variable", "num_responses",-Week) %>%
  mutate(week = paste0("Week", Week),
         week = factor(Week, levels = paste0("Week", c(1:total_week)))) %>%
  spread(Week, num_responses)

stimulus_rct <- stimulus %>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup()
```

# 0. Sample Disclaimer
  * This set of analyses on stimulus spending is based on responses collected from 1,630 caregivers between the dates of February 2nd and February 20th, 2021. These caregivers represent a range of voices: 8.47% are Black/African American, 11.60% are Latinx, and 24.02% live at or below 1.5 times the federal poverty line.  Proportions/percentages are calculated based on the item-level response rates, not out of the total sample size. The data for these analyses are not weighted. \
  
# 1. Receiving Stimulus Check 

## Overall

```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  mutate (a.received = ifelse (STIM.001 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.001 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.001 == 3, 1, 0),
          d.unsure = ifelse (STIM.001 == 4, 1, 0), 
          e.other = ifelse (STIM.001 == 5, 1, 0))%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             d.unsure = sum (d.unsure, na.rm = T)/n, 
             e.other = sum (e.other, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect", "d.unsure", "e.other"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.002 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.002 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.002 == 3, 1, 0),
          d.unsure = ifelse (STIM.002 == 4, 1, 0), 
          e.other = ifelse (STIM.002 == 5, 1, 0))%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             d.unsure = sum (d.unsure, na.rm = T)/n, 
             e.other = sum (e.other, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect", "d.unsure", "e.other"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.003 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.003 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.003 == 3, 1, 0),
          d.unsure = ifelse (STIM.003 == 4, 1, 0), 
          e.other = ifelse (STIM.003 == 5, 1, 0))%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             d.unsure = sum (d.unsure, na.rm = T)/n, 
             e.other = sum (e.other, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect", "d.unsure", "e.other"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment bonus")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = stimulus, x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (~which, nrow = 3)
```

## By race/ethnicity

```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  mutate (a.received = ifelse (STIM.001 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.001 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.001 == 3, 1, 0)
          )%>%
  filter (race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.002 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.002 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.002 == 3, 1, 0)
          )%>%
  filter (race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.003 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.003 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.003 == 3, 1, 0),
          )%>%
  filter (race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             )%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment bonus")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = race_ethnic, x = prop*100, fill = race_ethnic)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, ncol = 3)


```

## By poverty level

### By 100%FPL

```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  mutate (a.received = ifelse (STIM.001 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.001 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.001 == 3, 1, 0)
          )%>%
  filter (poverty_100 != "NA")%>%
  group_by (poverty_100)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.002 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.002 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.002 == 3, 1, 0)
          )%>%
  filter (poverty_100 != "NA")%>%
  group_by (poverty_100)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.003 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.003 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.003 == 3, 1, 0),
          )%>%
  filter (poverty_100 != "NA")%>%
  group_by (poverty_100)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             )%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment bonus")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = poverty_100, x = prop*100, fill = poverty_100)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)


```

### By 200%FPL

```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  mutate (a.received = ifelse (STIM.001 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.001 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.001 == 3, 1, 0)
          )%>%
  filter (poverty_200 != "NA")%>%
  group_by (poverty_200)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.002 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.002 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.002 == 3, 1, 0)
          )%>%
  filter (poverty_200 != "NA")%>%
  group_by (poverty_200)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.003 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.003 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.003 == 3, 1, 0),
          )%>%
  filter (poverty_200 != "NA")%>%
  group_by (poverty_200)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             )%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment bonus")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = poverty_200, x = prop*100, fill = poverty_200)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)


```


```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.show='hide'}

### Three categories: Below 100%FPL, 100-200%FPL, and above 200%FPL
stimulus_1 <- stimulus_rct %>%
  mutate (a.received = ifelse (STIM.001 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.001 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.001 == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.002 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.002 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.002 == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.003 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.003 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.003 == 3, 1, 0),
          )%>%
  filter (poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             )%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment bonus")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = poverty_3c, x = prop*100, fill = poverty_3c)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)


```

```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.show='hide'}

## By poverty level (3 categories) & race/ethnicity

stimulus_1 <- stimulus_rct %>%
  mutate (a.received = ifelse (STIM.001 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.001 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.001 == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA" & race_ethnic != "NA")%>%
  group_by (poverty_3c, race_ethnic)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.002 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.002 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.002 == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA" & race_ethnic != "NA")%>%
  group_by (poverty_3c, race_ethnic)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
   mutate (a.received = ifelse (STIM.003 == 1, 1, 0), 
          b.not_but_expect = ifelse (STIM.003 == 2, 1, 0), 
          c.not_donot_expect = ifelse (STIM.003 == 3, 1, 0),
          )%>%
  filter (poverty_3c != "NA" & race_ethnic != "NA")%>%
  group_by (poverty_3c, race_ethnic)%>%
  summarise (n = n(),
             a.received = sum (a.received, na.rm = T)/n, 
             b.not_but_expect = sum (b.not_but_expect, na.rm = T)/n, 
             c.not_donot_expect = sum (c.not_donot_expect, na.rm = T)/n, 
             )%>%
  pivot_longer (cols = c("a.received", "b.not_but_expect", "c.not_donot_expect"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment bonus")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = race_ethnic, x = prop*100, fill = poverty_3c)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = 0,hjust = -0.5, size = 2, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)


```

# 2. What people do after getting the stimulus check (% out of people who received the stimulus check)

## Overall
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = stimulus, x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (~which, nrow = 3)
```

## By race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  filter (race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  filter (race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
    filter (race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)


stimulus_smy %>%
  ggplot(mapping = aes (y = race_ethnic, x = prop*100, fill = race_ethnic)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)
```

## By poverty level
### By 100%FPL
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  filter (poverty_100 != "NA")%>%
  group_by (poverty_100)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  filter (poverty_100 != "NA")%>%
  group_by (poverty_100)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
  filter (poverty_100 != "NA")%>%
  group_by (poverty_100)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = poverty_100, x = prop*100, fill = poverty_100)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)
```

### By 200%FPL
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  filter (poverty_200 != "NA")%>%
  group_by (poverty_200)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  filter (poverty_200 != "NA")%>%
  group_by (poverty_200)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
  filter (poverty_200 != "NA")%>%
  group_by (poverty_200)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = poverty_200, x = prop*100, fill = poverty_200)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE, , fig.show='hide'}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = poverty_3c, x = prop*100, fill = poverty_3c)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE, fig.show='hide'}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA" & race_ethnic != "NA")%>%
  group_by (poverty_3c, race_ethnic)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA" & race_ethnic != "NA")%>%
  group_by (poverty_3c, race_ethnic)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (a.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          b.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
  filter (poverty_3c != "NA" & race_ethnic != "NA")%>%
  group_by (poverty_3c, race_ethnic)%>%
  summarise (n = n(),
             a.mostly_spent = sum (a.mostly_spent, na.rm = T)/n, 
             b.mostly_saved = sum (b.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_spent", "b.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)

stimulus_smy %>%
  ggplot(mapping = aes (y = race_ethnic, x = prop*100, fill = poverty_3c)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = 0, hjust = -0.5, size = 2, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  facet_wrap (stimulus~which, nrow = 3)
```

### Explore: Where most people start putting money into saving
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_rct <- stimulus_rct %>%
  mutate (FPL_pct_c = case_when (FPL_pct < 1 ~ "1.Below 100%FPL",
                                 FPL_pct >= 1 & FPL_pct < 2 ~ "2.100-200%FPL",
                                 FPL_pct >= 2 & FPL_pct < 3 ~ "3.200-300%FPL",
                                 FPL_pct >= 3 & FPL_pct < 4 ~ "4.300-400%FPL",
                                 FPL_pct >= 4 & FPL_pct < 5 ~ "5.400-500%FPL",
                                 FPL_pct >= 5 & FPL_pct < 8 ~ "6.500-800%FPL",
                                 FPL_pct >= 8  ~ "7.Above 800%FPL"))

stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (b.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          a.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA")%>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             b.mostly_spent = sum (b.mostly_spent, na.rm = T)/n, 
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("b.mostly_spent", "a.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (b.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          a.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA")%>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             b.mostly_spent = sum (b.mostly_spent, na.rm = T)/n, 
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("b.mostly_spent", "a.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (b.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          a.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA")%>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             b.mostly_spent = sum (b.mostly_spent, na.rm = T)/n, 
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("b.mostly_spent", "a.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)


stimulus_smy %>%
  ggplot(mapping = aes (x = FPL_pct_c, y = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = "stack")+
  geom_text(aes(label = round(prop*100,2)),size = 2, color = "black",  position = "stack")+
  labs (y = "Percentage")+
  facet_wrap (~which, nrow = 3)+ 
  theme(axis.text.x = element_text(angle = 30))+
  ggtitle (label = "Accounting for All Three Conditions")
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}

stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (b.mostly_spent = ifelse (STIM.001.a == 1, 1, 0), 
          a.mostly_saved = ifelse (STIM.001.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.001.a == 3, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA" & b.mostly_spent != 1)%>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (b.mostly_spent = ifelse (STIM.002.a == 1, 1, 0), 
          a.mostly_saved = ifelse (STIM.002.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.002.a == 3, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA" & b.mostly_spent != 1)%>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (b.mostly_spent = ifelse (STIM.003.a == 1, 1, 0), 
          a.mostly_saved = ifelse (STIM.003.a == 2, 1, 0), 
          c.mostly_pay_off_debt = ifelse (STIM.003.a == 3, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA"& b.mostly_spent != 1) %>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n, 
             c.mostly_pay_off_debt = sum (c.mostly_pay_off_debt, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.mostly_saved", "c.mostly_pay_off_debt"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)


stimulus_smy %>%
  ggplot(mapping = aes (x = FPL_pct_c, y = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = "stack")+
  geom_text(aes(label = round(prop*100,2)),size = 2, color = "black",  position = "stack")+
  labs (y = "Percentage")+
  facet_wrap (~which, nrow = 3)+ 
  theme(axis.text.x = element_text(angle = 30))+
  ggtitle (label = "Excluding Mostly Spent Category")
```


```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (b.mostly_spent_paydebt = ifelse (STIM.001.a == 1 | STIM.001.a == 3, 1, 0), 
          a.mostly_saved = ifelse (STIM.001.a == 2, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA")%>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             b.mostly_spent_paydebt = sum (b.mostly_spent_paydebt, na.rm = T)/n, 
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n)%>%
  pivot_longer (cols = c("b.mostly_spent_paydebt", "a.mostly_saved"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (b.mostly_spent_paydebt = ifelse (STIM.002.a == 1 | STIM.002.a == 3, 1, 0), 
          a.mostly_saved = ifelse (STIM.002.a == 2, 1, 0))%>%
  filter (FPL_pct_c != "NA")%>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             b.mostly_spent_paydebt = sum (b.mostly_spent_paydebt, na.rm = T)/n, 
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n)%>%
  pivot_longer (cols = c("b.mostly_spent_paydebt", "a.mostly_saved"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (b.mostly_spent_paydebt = ifelse (STIM.003.a == 1| STIM.003.a == 3, 1, 0), 
          a.mostly_saved = ifelse (STIM.003.a == 2, 1, 0)
          )%>%
  filter (FPL_pct_c != "NA") %>%
  group_by (FPL_pct_c)%>%
  summarise (n = n(),
             b.mostly_spent_paydebt = sum (b.mostly_spent_paydebt, na.rm = T)/n, 
             a.mostly_saved = sum (a.mostly_saved, na.rm = T)/n)%>%
  pivot_longer (cols = c("b.mostly_spent_paydebt", "a.mostly_saved"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_smy <- rbind (stimulus_1, stimulus_2, unemployment)


stimulus_smy %>%
  ggplot(mapping = aes (x = FPL_pct_c, y = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = "stack")+
  geom_text(aes(label = round(prop*100,2)),size = 2, color = "black",  position = "stack")+
  labs (y = "Percentage")+
  facet_wrap (~which, nrow = 3)+ 
  theme(axis.text.x = element_text(angle = 30))+
  ggtitle (label = "Aggregating spent & pay off debt")
```

# 3. What the families spent stimulus check on

## Overall - a detailed breakdown
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (food = ifelse (STIM.001.b_1 == 1, 1, 0),
          clothing = ifelse (STIM.001.b_2 == 1, 1, 0),
          supplies_personal_care = ifelse (STIM.001.b_3 == 1, 1, 0),
          household_items = ifelse (STIM.001.b_4 == 1, 1, 0),
          recreational = ifelse (STIM.001.b_5 == 1, 1, 0),
          rent = ifelse (STIM.001.b_6 == 1, 1, 0),
          mortgage = ifelse (STIM.001.b_7 == 1, 1, 0),
          utilities = ifelse (STIM.001.b_8 == 1, 1, 0),
          vehicle_pay = ifelse (STIM.001.b_9 == 1, 1, 0),
          credit_card_loans = ifelse (STIM.001.b_10 == 1, 1, 0),
          donations = ifelse (STIM.001.b_11 == 1, 1, 0),
          saving_investment = ifelse (STIM.001.b_12 == 1, 1, 0),
          other = ifelse (STIM.001.b_13 == 1, 1, 0),
          )%>%
  summarise (n = n(),
             food = sum (food, na.rm = T)/n, 
             clothing = sum (clothing, na.rm = T)/n, 
             supplies_personal_care = sum (supplies_personal_care, na.rm = T)/n,
             household_items = sum (household_items, na.rm = T)/n, 
             recreational = sum (recreational, na.rm = T)/n, 
             rent = sum (rent, na.rm = T)/n, 
             mortgage = sum (mortgage, na.rm = T)/n, 
             utilities = sum (utilities, na.rm = T)/n, 
             vehicle_pay = sum (vehicle_pay, na.rm = T)/n, 
             credit_card_loans = sum (credit_card_loans, na.rm = T)/n, 
             donations = sum (donations, na.rm = T)/n, 
             saving_investment = sum (saving_investment, na.rm = T)/n, 
             other = sum (other, na.rm = T)/n)%>%
  pivot_longer (cols = c("food", "clothing", "supplies_personal_care", "household_items", "recreational", "rent", "mortgage", "utilities", "vehicle_pay", "credit_card_loans", "donations", "saving_investment", "other"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (food = ifelse (STIM.002.b_1 == 1, 1, 0),
          clothing = ifelse (STIM.002.b_2 == 1, 1, 0),
          supplies_personal_care = ifelse (STIM.002.b_3 == 1, 1, 0),
          household_items = ifelse (STIM.002.b_4 == 1, 1, 0),
          recreational = ifelse (STIM.002.b_5 == 1, 1, 0),
          rent = ifelse (STIM.002.b_6 == 1, 1, 0),
          mortgage = ifelse (STIM.002.b_7 == 1, 1, 0),
          utilities = ifelse (STIM.002.b_8 == 1, 1, 0),
          vehicle_pay = ifelse (STIM.002.b_9 == 1, 1, 0),
          credit_card_loans = ifelse (STIM.002.b_10 == 1, 1, 0),
          donations = ifelse (STIM.002.b_11 == 1, 1, 0),
          saving_investment = ifelse (STIM.002.b_12 == 1, 1, 0),
          other = ifelse (STIM.002.b_13 == 1, 1, 0),
          )%>%
  summarise (n = n(),
             food = sum (food, na.rm = T)/n, 
             clothing = sum (clothing, na.rm = T)/n, 
             supplies_personal_care = sum (supplies_personal_care, na.rm = T)/n,
             household_items = sum (household_items, na.rm = T)/n, 
             recreational = sum (recreational, na.rm = T)/n, 
             rent = sum (rent, na.rm = T)/n, 
             mortgage = sum (mortgage, na.rm = T)/n, 
             utilities = sum (utilities, na.rm = T)/n, 
             vehicle_pay = sum (vehicle_pay, na.rm = T)/n, 
             credit_card_loans = sum (credit_card_loans, na.rm = T)/n, 
             donations = sum (donations, na.rm = T)/n, 
             saving_investment = sum (saving_investment, na.rm = T)/n, 
             other = sum (other, na.rm = T)/n) %>%
  pivot_longer (cols = c("food", "clothing", "supplies_personal_care", "household_items", "recreational", "rent", "mortgage", "utilities", "vehicle_pay", "credit_card_loans", "donations", "saving_investment", "other"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (food = ifelse (STIM.003.b_1 == 1, 1, 0),
          clothing = ifelse (STIM.003.b_2 == 1, 1, 0),
          supplies_personal_care = ifelse (STIM.003.b_3 == 1, 1, 0),
          household_items = ifelse (STIM.003.b_4 == 1, 1, 0),
          recreational = ifelse (STIM.003.b_5 == 1, 1, 0),
          rent = ifelse (STIM.003.b_6 == 1, 1, 0),
          mortgage = ifelse (STIM.003.b_7 == 1, 1, 0),
          utilities = ifelse (STIM.003.b_8 == 1, 1, 0),
          vehicle_pay = ifelse (STIM.003.b_9 == 1, 1, 0),
          credit_card_loans = ifelse (STIM.003.b_10 == 1, 1, 0),
          donations = ifelse (STIM.003.b_11 == 1, 1, 0),
          saving_investment = ifelse (STIM.003.b_12 == 1, 1, 0),
          other = ifelse (STIM.003.b_13 == 1, 1, 0),
          )%>%
  summarise (n = n(),
             food = sum (food, na.rm = T)/n, 
             clothing = sum (clothing, na.rm = T)/n, 
             supplies_personal_care = sum (supplies_personal_care, na.rm = T)/n,
             household_items = sum (household_items, na.rm = T)/n, 
             recreational = sum (recreational, na.rm = T)/n, 
             rent = sum (rent, na.rm = T)/n, 
             mortgage = sum (mortgage, na.rm = T)/n, 
             utilities = sum (utilities, na.rm = T)/n, 
             vehicle_pay = sum (vehicle_pay, na.rm = T)/n, 
             credit_card_loans = sum (credit_card_loans, na.rm = T)/n, 
             donations = sum (donations, na.rm = T)/n, 
             saving_investment = sum (saving_investment, na.rm = T)/n, 
             other = sum (other, na.rm = T)/n) %>%
  pivot_longer (cols = c("food", "clothing", "supplies_personal_care", "household_items", "recreational", "rent", "mortgage", "utilities", "vehicle_pay", "credit_card_loans", "donations", "saving_investment", "other"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")


stimulus_1 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -0.5, size = 2, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("first stimulus check")+
  theme(legend.position = "none")

stimulus_2 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -0.5, size = 2, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("second stimulus check")+
  theme(legend.position = "none")

unemployment %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -0.5, size = 2, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("unemployment")+
  theme(legend.position = "none")
```

## Overall - categorized into 4 groups
  * Four categories:
    + Basic needs: food, rent, mortgage, utilities & telecommunications\
    + Other essentials: Vehicle payments, paying down credit card, student loans, or other debts, clothing, household supplies and personal care, household items (TV, electronics, furniture, appliances)\
    + Recreational activities\
    + Savings or other investments\
    
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (basic_need = ifelse (STIM.001.b_1 == 1 |STIM.001.b_6 == 1 |STIM.001.b_7 == 1 |STIM.001.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.001.b_9 == 1 |STIM.001.b_10 == 1|STIM.001.b_2 == 1 | STIM.001.b_3 == 1|STIM.001.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.001.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.001.b_12 == 1, 1, 0))%>%
  summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
   mutate (basic_need = ifelse (STIM.002.b_1 == 1 |STIM.002.b_6 == 1 |STIM.002.b_7 == 1 |STIM.002.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.002.b_9 == 1 |STIM.002.b_10 == 1|STIM.002.b_2 == 1 | STIM.002.b_3 == 1|STIM.002.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.002.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.002.b_12 == 1, 1, 0))%>%
  summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
   mutate (basic_need = ifelse (STIM.003.b_1 == 1 |STIM.003.b_6 == 1 |STIM.003.b_7 == 1 |STIM.003.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.003.b_9 == 1 |STIM.003.b_10 == 1|STIM.003.b_2 == 1 | STIM.003.b_3 == 1|STIM.003.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.003.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.003.b_12 == 1, 1, 0))%>%
  summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")


stimulus_1 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 3, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("first stimulus check")+
  theme(legend.position = "none")

stimulus_2 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 3, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("second stimulus check")+
  theme(legend.position = "none")

unemployment %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 3, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("unemployment")+
  theme(legend.position = "none")
```


## By race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
  mutate (basic_need = ifelse (STIM.001.b_1 == 1 |STIM.001.b_6 == 1 |STIM.001.b_7 == 1 |STIM.001.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.001.b_9 == 1 |STIM.001.b_10 == 1|STIM.001.b_2 == 1 | STIM.001.b_3 == 1|STIM.001.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.001.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.001.b_12 == 1, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
   summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (basic_need = ifelse (STIM.002.b_1 == 1 |STIM.002.b_6 == 1 |STIM.002.b_7 == 1 |STIM.002.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.002.b_9 == 1 |STIM.002.b_10 == 1|STIM.002.b_2 == 1 | STIM.002.b_3 == 1|STIM.002.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.002.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.002.b_12 == 1, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (basic_need = ifelse (STIM.003.b_1 == 1 |STIM.003.b_6 == 1 |STIM.003.b_7 == 1 |STIM.003.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.003.b_9 == 1 |STIM.003.b_10 == 1|STIM.003.b_2 == 1 | STIM.003.b_3 == 1|STIM.003.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.003.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.003.b_12 == 1, 1, 0))%>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
   summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_1 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("first stimulus check")+
  facet_wrap (~race_ethnic, ncol = 3)+
  theme(legend.position = "none")

stimulus_2 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size =2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("second stimulus check")+
  facet_wrap (~race_ethnic, ncol = 3)+
  theme(legend.position = "none")

unemployment %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("unemployment")+
  facet_wrap (~race_ethnic, ncol = 3)+
  theme(legend.position = "none")
```

## By poverty level
### By Full Spectrum of Poverty Level
  * Note that "above 800%FPL has very small sample size (n < 40)\
  
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
   mutate (basic_need = ifelse (STIM.001.b_1 == 1 |STIM.001.b_6 == 1 |STIM.001.b_7 == 1 |STIM.001.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.001.b_9 == 1 |STIM.001.b_10 == 1|STIM.001.b_2 == 1 | STIM.001.b_3 == 1|STIM.001.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.001.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.001.b_12 == 1, 1, 0))%>%
  filter (FPL_pct_c!= "NA")%>%
  group_by (FPL_pct_c)%>%
   summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (basic_need = ifelse (STIM.002.b_1 == 1 |STIM.002.b_6 == 1 |STIM.002.b_7 == 1 |STIM.002.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.002.b_9 == 1 |STIM.002.b_10 == 1|STIM.002.b_2 == 1 | STIM.002.b_3 == 1|STIM.002.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.002.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.002.b_12 == 1, 1, 0))%>%
  filter (FPL_pct_c!= "NA")%>%
  group_by (FPL_pct_c)%>%
   summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (basic_need = ifelse (STIM.003.b_1 == 1 |STIM.003.b_6 == 1 |STIM.003.b_7 == 1 |STIM.003.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.003.b_9 == 1 |STIM.003.b_10 == 1|STIM.003.b_2 == 1 | STIM.003.b_3 == 1|STIM.003.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.003.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.003.b_12 == 1, 1, 0))%>%
  filter (FPL_pct_c!= "NA")%>%
  group_by (FPL_pct_c)%>%
   summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_1 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -2, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("first stimulus check")+
  facet_wrap (~FPL_pct_c, ncol =7)+
  theme(legend.position = "none") 

stimulus_2 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -2, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("second stimulus check")+
  facet_wrap (~FPL_pct_c, ncol = 7)+
 theme(legend.position = "none") 

unemployment %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -2, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("unemployment")+
  facet_wrap (~FPL_pct_c, ncol = 7)+
  theme(legend.position = "none") 
```

#### Line graphs
  * Note that "above 800%FPL has very small sample size (n < 40)\
  * X axis indicates %of FPL in the order of: below 100%FPL, 100-200%FPL, 200-300%FPL, 300-400%FPL, 400-500%FPL, 500-800%FPL, and above 800%FPL\
  
```{r, echo=FALSE, message = FALSE, warning = FALSE}

stimulus_1 %>%
  mutate (FPL_pct_cn = as.numeric(case_when (FPL_pct_c == "1.Below 100%FPL" ~ 1,
                                             FPL_pct_c == "2.100-200%FPL" ~ 2,
                                             FPL_pct_c == "3.200-300%FPL" ~ 3,
                                             FPL_pct_c == "4.300-400%FPL" ~ 4,
                                             FPL_pct_c == "5.400-500%FPL" ~ 5,
                                             FPL_pct_c == "6.500-800%FPL" ~ 6,
                                             FPL_pct_c == "7.Above 800%FPL" ~ 7)))%>%
  ggplot(mapping = aes (x = FPL_pct_cn, y = prop*100, fill = stimulus)) +
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle("first stimulus check")+
  scale_x_discrete('FPL_pct_cn', 
                   c("1", "2", "3", "4", "5", "6", "7"), 
                   c("Below 100%FPL", "100-200%FPL", "200-300%FPL", "300-400%FPL", "400-500%FPL", "500-800%FPL", "Above 800%FPL"))+
  facet_wrap(~stimulus, ncol = 5)+
  theme(legend.position = "none")

stimulus_2 %>%
  mutate (FPL_pct_cn = as.numeric(case_when (FPL_pct_c == "1.Below 100%FPL" ~ 1,
                                             FPL_pct_c == "2.100-200%FPL" ~ 2,
                                             FPL_pct_c == "3.200-300%FPL" ~ 3,
                                             FPL_pct_c == "4.300-400%FPL" ~ 4,
                                             FPL_pct_c == "5.400-500%FPL" ~ 5,
                                             FPL_pct_c == "6.500-800%FPL" ~ 6,
                                             FPL_pct_c == "7.Above 800%FPL" ~ 7)))%>%
  ggplot(mapping = aes (x = FPL_pct_cn, y = prop*100, fill = stimulus)) +
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle("second stimulus check")+
  scale_x_discrete(breaks=stimulus_2$FPL_pct_cn, labels=stimulus_2$FPL_pct_c)+
  facet_wrap(~stimulus, ncol = 5)+
  theme(legend.position = "none")

unemployment %>%
  mutate (FPL_pct_cn = as.numeric(case_when (FPL_pct_c == "1.Below 100%FPL" ~ 1,
                                             FPL_pct_c == "2.100-200%FPL" ~ 2,
                                             FPL_pct_c == "3.200-300%FPL" ~ 3,
                                             FPL_pct_c == "4.300-400%FPL" ~ 4,
                                             FPL_pct_c == "5.400-500%FPL" ~ 5,
                                             FPL_pct_c == "6.500-800%FPL" ~ 6,
                                             FPL_pct_c == "7.Above 800%FPL" ~ 7)))%>%
  ggplot(mapping = aes (x = FPL_pct_cn, y = prop*100, fill = stimulus)) +
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  labs (y = "Percentage")+
  ggtitle("unemployment")+
  scale_x_discrete(breaks=unemployment$FPL_pct_cn, labels=unemployment$FPL_pct_c)+
  facet_wrap(~stimulus, ncol = 5)+
  theme(legend.position = "none")
  


```


### By Three Categories: Below 200%FPL, 200-400%FPL, above 400%FPL
```{r, echo=FALSE, message = FALSE, warning = FALSE}
stimulus_rct <- stimulus_rct %>%
  mutate (FPL.3c = case_when (FPL_pct <= 2 ~ "a.Below 200%FPL", 
                              FPL_pct > 2 & FPL_pct <= 4 ~ "b.200-400%FPL", 
                              FPL_pct > 4 ~ "c.Above 400%FPL"))

stimulus_1 <- stimulus_rct %>%
  filter (STIM.001==1)%>%
   mutate (basic_need = ifelse (STIM.001.b_1 == 1 |STIM.001.b_6 == 1 |STIM.001.b_7 == 1 |STIM.001.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.001.b_9 == 1 |STIM.001.b_10 == 1|STIM.001.b_2 == 1 | STIM.001.b_3 == 1|STIM.001.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.001.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.001.b_12 == 1, 1, 0))%>%
  filter (FPL.3c!= "NA")%>%
  group_by (FPL.3c)%>%
  summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "first stimulus check")

stimulus_2 <- stimulus_rct %>%
  filter (STIM.002==1)%>%
  mutate (basic_need = ifelse (STIM.002.b_1 == 1 |STIM.002.b_6 == 1 |STIM.002.b_7 == 1 |STIM.002.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.002.b_9 == 1 |STIM.002.b_10 == 1|STIM.002.b_2 == 1 | STIM.002.b_3 == 1|STIM.002.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.002.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.002.b_12 == 1, 1, 0))%>%
  filter (FPL.3c!= "NA")%>%
  group_by (FPL.3c)%>%
  summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "second stimulus check")

unemployment <- stimulus_rct %>%
  filter (STIM.003==1)%>%
  mutate (basic_need = ifelse (STIM.003.b_1 == 1 |STIM.003.b_6 == 1 |STIM.003.b_7 == 1 |STIM.003.b_8 == 1, 1, 0), 
          other_essentials = ifelse (STIM.003.b_9 == 1 |STIM.003.b_10 == 1|STIM.003.b_2 == 1 | STIM.003.b_3 == 1|STIM.003.b_4 == 1, 1, 0), 
          recreational_activities = ifelse (STIM.003.b_5 == 1, 1, 0),
          saving_investment = ifelse (STIM.003.b_12 == 1, 1, 0))%>%
  filter (FPL.3c!= "NA")%>%
  group_by (FPL.3c)%>%
   summarise (n = n(),
             basic_need = sum (basic_need, na.rm = T)/n, 
             other_essentials = sum (other_essentials, na.rm = T)/n,
             recreational_activities = sum (recreational_activities, na.rm = T)/n,
             saving_investment = sum (saving_investment, na.rm = T)/n)%>%
  pivot_longer (cols = c("basic_need", "other_essentials","recreational_activities", "saving_investment"), names_to = "stimulus", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          which = "unemployment")

stimulus_1 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("first stimulus check")+
  facet_wrap (~FPL.3c, ncol =3)+
  theme(legend.position = "none") 

stimulus_2 %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("second stimulus check")+
  facet_wrap (~FPL.3c, ncol = 3)+
 theme(legend.position = "none") 

unemployment %>%
  ggplot(mapping = aes (y =  reorder(stimulus, -prop), x = prop*100, fill = stimulus)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(xmin = ci_low*100, 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1.5, size = 2.5, color = "black",  position = position_dodge(1))+
  labs (y = "Percentage")+
  ggtitle("unemployment")+
  facet_wrap (~FPL.3c, ncol = 3)+
  theme(legend.position = "none") 
```