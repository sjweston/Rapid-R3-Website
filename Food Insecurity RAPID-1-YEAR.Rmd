---
title: "Food Insecurity"
author: "Sihong"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include = FALSE}
library(here)
library(knitr)
library(readr)
library(haven)
library(tidyverse)
```


```{r, echo=FALSE, message = FALSE}
#Define functions
moe.p = function(p, n){
  q = 1-p
  moe = 1.96*sqrt((p*q)/n)
  return(moe)
}

moe.m = function(sd,n){
  moe = 1.96*sd/sqrt(n)
  return(moe)}

combine.cat = function(x, cols, id, newvar.name){
  subset = x[,c(id, "Week", cols)]
  names(subset) = c("id", "Week", paste0("X",1:length(cols)))
  subset = suppressWarnings(gather(subset, "key", "value", -id, -Week))
  subset = filter(subset, !is.na(value))
  subset$key = gsub("X", "", subset$key)
  subset = group_by(subset, id, Week)
  subset = summarise(subset, newvar = paste(key, collapse = ",")) %>% ungroup()
  names(subset) = c(id,"Week", newvar.name)
  x = suppressMessages(full_join(x, subset))
  return(x)
}

find_items = function(string, data2){
  items = names(data2)
  locations = which(grepl(string, items))
  final = items[locations]
  return(final)
}

my.max = function(x) ifelse (!all(is.na(x)), max(x,na.rm = TRUE), NA)
my.min = function(x) ifelse (!all(is.na(x)), min(x,na.rm = TRUE), NA)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
master_2020 <- read_sav(here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2020.sav"))
master_2021 <- read_sav(here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2021.sav"))

master <- full_join (master_2020, master_2021)

# Remove cases should be excluded
master <- master %>%
  filter ( CaregiverID != "" & is.na(Exclude) == T)

master = master %>%
  group_by(CaregiverID, Week) %>%
  filter(row_number() == max(row_number())) %>%
  ungroup()

total_week <- my.max(master$Week)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
#Code demographics
master <- master %>%
  mutate (month = case_when(
                  Week == 0 ~ "Pre-COVID",
                  Week >0 & Week <= 4 ~ "April",
                  Week >=5 & Week <=8 ~ "May",
                  Week >=9 & Week <=13 ~ "June",
                  Week >=14 & Week <=17 ~ "July",
                  Week >=18 & Week <=21 ~ "August",
                  Week >=22 & Week <=26 ~ "September",
                  Week >=27 ~ "October"), 
           baseline = case_when (Week - BaselineWeek == 1 ~ 1, 
                                 Week - BaselineWeek > 1 ~ 0))

##Race/ethnicity - 1 = black, 2 = latinx, 3 = white

master <- master %>%
  mutate (RaceGroup = na_if (RaceGroup, 99))%>%
    mutate(
      minority = ifelse(RaceGroup != 5, 1, 0),
      black = ifelse(RaceGroup == 3, 1, 0),
      native = ifelse(RaceGroup == 1, 1, 0),
      asian = ifelse(RaceGroup == 2, 1, 0),
      hawaii = ifelse(RaceGroup == 4, 1, 0),
      white = ifelse(RaceGroup == 5, 1, 0),
      other_race = ifelse(RaceGroup %in% c(6, 7), 1, 0))

master <- master %>%
      mutate(latinx = case_when(
        DEMO.008 == 1 ~ 1,
        DEMO.008 == 0 ~ 0,
        DEMO.008.2 == 0 ~ 0,
        DEMO.008.2 == 1 ~ 1,
        DEMO.008.2 == 2 ~ 1,
        TRUE ~ NA_real_))

master <- master %>%
mutate (race_ethnic = case_when(
      black == 1 ~ "1",
      latinx == 1 ~ "2",
      !is.na(black) ~ "3",
      !is.na(latinx) ~ "3",
      TRUE ~ NA_character_))  

##Povertyline - 0 = high income, 1 = low income
master <- master %>%
  mutate (poverty_cat = FPL.2019.UM.150)

#Material hardship
master <- master %>%
  combine.cat(cols = find_items("FSTR.002_.{1}$", master), 
              id = "CaregiverID",
              newvar.name = "FSTR.002_cat")
  

master <- master %>%
  mutate (diff_pay_food = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("1", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_), 
          diff_pay_utilities = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("3", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_house = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("2", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_healthcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("4", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_social = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("5", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_emotional = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("6", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_childcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("7", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_other = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("8", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_))

master <- master %>%
  rowwise() %>%
  mutate(material_hardship = case_when(
    Week == 0 ~ NA_real_,
    TRUE ~ sum(c_across(starts_with("diff_pay_")), na.rm=T))) %>%
  ungroup() %>%
  mutate(num_hardship = material_hardship,
    material_hardship = ifelse(material_hardship > 0, 1, 0)) 

## Children with special needs
master <- combine.cat(x = master, 
                       cols = find_items("HEALTH.005_[0-9]{1}$", master), 
                       id = "CaregiverID",
                       newvar.name = "HEALTH.005_cat")
master <- master %>%
   mutate (disability = case_when (HEALTH.005_1 == 1 ~ 1,
                                   HEALTH.005_2 == 1 ~ 1,
                                   HEALTH.005_3 == 1 ~ 1,
                                   HEALTH.005_4 == 1 ~ 1,
                                   HEALTH.005_5 == 1 ~ 0,
                                   HEALTH.005_6 == 1 ~ 1,
                                   TRUE ~ NA_real_))


## Single parent status
master <- master %>%
  mutate (single = case_when (
                   DEMO.002 %in% c(3,4,5,7,8)~1, 
                   DEMO.011 %in% c(2,4)~1,
                   !is.na(DEMO.002)~0,
                   !is.na(DEMO.011)~0,
                   TRUE ~ NA_real_))
                     
## Employment status
master <- combine.cat (x = master,
                       cols = find_items ("JOB.010_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.010_cat")
  
master$JOB.010_cat = gsub("10", "0", master$JOB.010_cat)
master$working_pre = ifelse (grepl("[1,2,6]", master$JOB.010_cat), 1, 0)
master = combine.cat (x = master,
                       cols = find_items ("JOB.008_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.008_cat")
master$JOB.008_cat = gsub("10", "0", master$JOB.008_cat)
master <- master %>%
  mutate (work_status = case_when(
                        grepl ("1", JOB.008_cat) ~ "1", 
                        grepl ("2", JOB.008_cat) ~ "1", 
                        grepl ("3", JOB.008_cat) ~ "0", 
                        grepl ("4", JOB.008_cat) ~ "0", 
                        grepl ("5", JOB.008_cat) ~ "1", 
                        JOB.008.2 == 1 ~ "1",
                        JOB.008.2 %in% c(2,3) ~ "0",
                        TRUE~NA_character_),
          work_status_pre = case_when(
                        grepl ("1", JOB.010_cat) ~ "1", 
                        grepl ("2", JOB.010_cat) ~ "1", 
                        grepl ("3", JOB.010_cat) ~ "0", 
                        grepl ("4", JOB.010_cat) ~ "0", 
                        grepl ("5", JOB.010_cat) ~ "1", 
                        TRUE~NA_character_))
#1 = stable employed 2 = became unemployed 3 = became employed4 = stable unemployed

# Region
master <- master %>%
  mutate (region = na_if (DEMO.001.b, 5))

master_dem <- master %>%
  group_by (CaregiverID) %>%
  summarise (BaselineWeek = my.max (BaselineWeek),
             race_ethnic = my.max(race_ethnic),
             poverty_cat = my.max(poverty_cat),
             disability = my.max (disability),
             single = my.max (single),
             work_status = my.max (work_status),
             work_status_pre = my.max (work_status_pre), 
             region = my.max(region), 
             gender = my.min(DEMO.006))%>%
  mutate ( ep_change = case_when(
                        work_status == 1 & work_status_pre == 1 ~ "1", 
                        work_status == 1 & work_status_pre == 0 ~ "2", 
                        work_status == 0 & work_status_pre == 1 ~ "3", 
                        work_status == 0 & work_status_pre == 0 ~ "4", 
                        TRUE~NA_character_))%>%
  mutate (race_ethnic = case_when (
                        race_ethnic == 1 ~ "Black", 
                        race_ethnic == 2 ~ "Latinx", 
                        race_ethnic == 3 ~ "White", 
                        TRUE~NA_character_),
          poverty_cat = case_when (
                        poverty_cat == 1 ~ "Below 150%FPL", 
                        poverty_cat == 0 ~ "Above 150%FPL", 
                        TRUE~NA_character_),
          disability = case_when (
                        disability == 1 ~ "With disability", 
                        disability == 0 ~ "Without disability", 
                        TRUE~NA_character_),
          single = case_when (
                        single == 1 ~ "Single parent", 
                        single == 0 ~ "Dual parent", 
                        TRUE~NA_character_),
          work_status = case_when (
                        work_status == 1 ~ "Employed", 
                        work_status == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          work_status_pre = case_when (
                        work_status_pre == 1 ~ "Employed", 
                        work_status_pre == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          ep_change = case_when (
                        ep_change == 1 ~ "Stable employed", 
                        ep_change == 2 ~ "Became employed", 
                        ep_change == 3 ~ "Became unemployed",
                        ep_change == 4 ~ "Stable unemployed",
                        TRUE~NA_character_), 
          region = case_when (
                        region == 1 ~ "Northeast", 
                        region == 2 ~ "Midwest", 
                        region == 3 ~ "South", 
                        region == 4 ~ "West",
                        TRUE~NA_character_))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
# Extract food insecurity data and calculate for sum scores- from followup data in 19, 21, 23, 25, 27, 31
fi <- master %>%
  select (CaregiverID, Week, StartDate, starts_with ("FI"))%>%
  filter (Week %in% c(19, 21, 23, 25, 27, 31, 33, 35, 39, 41, 45, 49))%>%
  mutate (FI.001.a = na_if(FI.001.a, 4),
          FI.001.b = na_if(FI.001.b, 4),
          FI.002.a = na_if(FI.002.a, 4),
          FI.002.b = na_if(FI.002.b, 4),
          FI.003.a = na_if(FI.003.a, 3),
          FI.003.b = na_if(FI.003.b, 3),
          FI.004.a = na_if(FI.004.a, 4),
          FI.004.b = na_if(FI.004.b, 4),
          FI.005.a = na_if(FI.005.a, 3),
          FI.005.b = na_if(FI.005.b, 3),
          FI.006.a = na_if(FI.006.a, 3),
          FI.006.b = na_if(FI.006.b, 3))%>%
  mutate (FI.001.a_r = case_when (FI.001.a %in% c(1, 2) ~ 1, 
                                  FI.001.a == 3 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.001.b_r = case_when (FI.001.b %in% c(1, 2) ~ 1, 
                                  FI.001.b == 3 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.002.a_r = case_when (FI.002.a %in% c(1, 2) ~ 1, 
                                  FI.002.a == 3 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.002.b_r = case_when (FI.002.b %in% c(1, 2) ~ 1, 
                                  FI.002.b == 3 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.003.a_r = case_when (FI.003.a == 1 ~ 1, 
                                  FI.003.a == 2 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.003.b_r = case_when (FI.003.b == 1 ~ 1, 
                                  FI.003.b == 2 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.004.a_r = case_when (FI.004.a %in% c(1, 2) ~ 1, 
                                  FI.004.a == 3 ~ 0,
                                  FI.003.a_r == 0 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.004.b_r = case_when (FI.004.b %in% c(1, 2) ~ 1, 
                                  FI.004.b == 3 ~ 0,
                                  FI.003.b_r == 0 ~ 0,
                                  TRUE ~ NA_real_),
          FI.005.a_r = case_when (FI.005.a == 1 ~ 1, 
                                  FI.005.a == 2 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.005.b_r = case_when (FI.005.b == 1 ~ 1, 
                                  FI.005.b == 2 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.006.a_r = case_when (FI.006.a == 1 ~ 1, 
                                  FI.006.a == 2 ~ 0,
                                  TRUE ~ NA_real_), 
          FI.006.b_r = case_when (FI.006.b == 1 ~ 1, 
                                  FI.006.b == 2 ~ 0,
                                  TRUE ~ NA_real_)) %>%
  rowwise%>%
  mutate (fi_raw_pre = sum(FI.001.a_r,FI.002.a_r,FI.003.a_r,FI.004.a_r,FI.005.a_r,FI.006.a_r, na.rm = T), 
          fi_raw_crt = sum(FI.001.b_r,FI.002.b_r,FI.003.b_r,FI.004.b_r,FI.005.b_r,FI.006.b_r, na.rm = T),
          fi_cg_raw = fi_raw_crt-fi_raw_pre) %>%
  ungroup()%>%
  mutate (fi_cat3_pre = case_when (fi_raw_pre %in% c(0,1) ~ 1, #high security/low food insecurity
                                  fi_raw_pre %in% c(2, 3, 4) ~ 2, # low security/high food insecurity
                                  fi_raw_pre %in% c(5, 6) ~ 3, # very low security/extremely high food insecurity
                                  TRUE ~ NA_real_), 
          fi_cat3_crt = case_when (fi_raw_crt %in% c(0,1) ~ 1, 
                                  fi_raw_crt %in% c(2, 3, 4) ~ 2, 
                                  fi_raw_crt %in% c(5, 6) ~ 3,
                                  TRUE ~ NA_real_), 
          fi_cat2_pre = case_when (fi_raw_pre %in% c(0,1) ~ 0, #secure
                                  fi_raw_pre %in% c(2, 3, 4, 5, 6) ~ 1, # insecure
                                  TRUE ~ NA_real_), 
          fi_cat2_crt = case_when (fi_raw_crt %in% c(0,1) ~ 0, 
                                  fi_raw_crt %in% c(2, 3, 4, 5, 6) ~ 1,
                                  TRUE ~ NA_real_), 
          fi_cat_cg = case_when (fi_cat2_pre == 0 & fi_cat2_crt == 1 ~ 1, # 1= became insecure
                                 fi_cat2_pre == 0 & fi_cat2_crt == 0 ~ 2, # 2 = stay secure,
                                 fi_cat2_pre == 1 & fi_cat2_crt == 1 ~ 3, # 3 = stay insecure
                                 fi_cat2_pre == 1 & fi_cat2_crt == 0 ~ 4))# 4 = became secure

fi <- fi %>%
  select(CaregiverID, Week, StartDate,starts_with ("fi_"), contains ("FI.") )

fi <- merge (x = master_dem, y = fi, by.x = c("CaregiverID"), by.y = c("CaregiverID"), all.y = T)
fi_rct <- fi%>%
  group_by (CaregiverID) %>%
  filter (Week == max (Week))%>%
  ungroup()

num_responses = function(x){length(which(!is.na(x)))}
fi.num <- fi %>%
  group_by(Week) %>%
  summarize_all(num_responses) %>%
  gather("Variable", "num_responses",-Week) %>%
  mutate(week = paste0("Week", Week),
         week = factor(Week, levels = paste0("Week", c(1:total_week)))) %>%
  spread(Week, num_responses)


```


# 0. Sample Disclaimer
  * This set of analyses on food insecurity is based on responses collected from 4,325 caregivers between the dates of August 11th 2020 and March 20th 2021. These caregivers represent a range of voices: 7.06% are non-Latinx Black/African American, 13.17% are Latinx, and 27.39% live at or below 1.5 times the federal poverty line.  Proportions/percentages are calculated based on the item-level response rates, not out of the total sample size. The data for these analyses are not weighted. \
  
```{r, echo=FALSE, message = FALSE, warning = FALSE}
min(fi_rct$StartDate)
max(fi_rct$StartDate)
library(janitor)
tabyl(fi_rct$race_ethnic)
tabyl(fi_rct$poverty_cat)
```

# 1. Prevalence of Food Insecurity
  * Survey Questions: For these following statements, please indicate whether the statement was often true, sometimes true, or never true for your household prior to/since the coronavirus (COVID-19) pandemic:\
    + I1. The food that we bought just didn't last, and we didn't have money to get more (often true/sometimes true/never true)\
    + I2. We couldn't afford to eat balanced meals (often true/sometimes true/never true)\
    + I3. Did you or other adult in your household ever cut the size of your meal or skip meals because there wasn't enough money for food? (yes/no) 
    + I4. if yes (I3), how often did this happen? (almost every month/some months but not every month/in only 1 or 2 months)\
    + I5. Did you ever eat less than you felt you should because there wasn't enough money for food? (yes/no)\
    + I6. Were you ever hungry but didn't eat because there wasn't enough money for food? (yes/no)\
  * Note. \
    + Food insecurity data were collected on weeks 19, 21, 23, 25, 27, 31, 33, 35, 39, 41, 45, 49 follow-up surveys. \
    + Total scores of the six items were calculated, and families were considered in the "food insecurity" category if their total score was at or above 2. \
  

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
  summarise (n = n(),
             a.pre_covid = sum(fi_cat2_pre, na.rm = T)/n, 
             b.current = sum(fi_cat2_crt, na.rm = T)/n) %>%
  pivot_longer (cols = c("a.pre_covid", "b.current"), names_to = "time", values_to = "prop")%>%
  mutate (count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

fi_pct %>%
  ggplot(mapping = aes (x = time, y = prop*100, fill = time)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Based on FI Total Score")+
  theme(legend.position = "none")
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi %>%
  group_by (Week)%>%
  summarise (n = n(),
             prop = sum(fi_cat2_crt, na.rm = T)/n, 
             date = as.Date(min (StartDate))) %>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

fi_pct %>%
  ggplot(mapping = aes (x = date, y = prop*100)) +   
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  ggtitle (label = "Food Insecurity Trend during COVID-19")+
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
  summarise (n = n(),
             I1_food_not_last_pre = sum(FI.001.a_r, na.rm = T)/n, 
             I1_food_not_last_crt = sum(FI.001.b_r, na.rm = T)/n,
             I2_not_balanced_meal_pre = sum(FI.002.a_r, na.rm = T)/n, 
             I2_not_balanced_meal_crt = sum(FI.002.b_r, na.rm = T)/n,
             I3_cut_skip_meal_pre = sum(FI.003.a_r, na.rm = T)/n, 
             I3_cut_skip_meal_crt = sum(FI.003.b_r, na.rm = T)/n,
             I4_freq_cut_skip_pre = sum(FI.004.a_r, na.rm = T)/n, 
             I4_freq_cut_skip_crt = sum(FI.004.b_r, na.rm = T)/n,
             I5_eat_less_pre = sum(FI.005.a_r, na.rm = T)/n, 
             I5_eat_less_crt = sum(FI.005.b_r, na.rm = T)/n,
             I6_hungry_pre = sum(FI.006.a_r, na.rm = T)/n, 
             I6_hungry_crt = sum(FI.006.b_r, na.rm = T)/n) 

fi_pre <- fi_pct %>%
  select (n, ends_with ("pre"))%>%
  rename(I1_food_not_last = I1_food_not_last_pre,
         I2_not_balanced_meal = I2_not_balanced_meal_pre,
         I3_cut_skip_meal = I3_cut_skip_meal_pre,
         I4_freq_cut_skip = I4_freq_cut_skip_pre,
         I5_eat_less = I5_eat_less_pre,
         I6_hungry = I6_hungry_pre)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "a.pre_COVID",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))
  

fi_crt <- fi_pct %>%
  select (n, ends_with ("crt"))%>%
  rename(I1_food_not_last = I1_food_not_last_crt,
         I2_not_balanced_meal = I2_not_balanced_meal_crt,
         I3_cut_skip_meal = I3_cut_skip_meal_crt,
         I4_freq_cut_skip = I4_freq_cut_skip_crt,
         I5_eat_less = I5_eat_less_crt,
         I6_hungry = I6_hungry_crt)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "b.Current",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

  
fi_item_pct <- rbind (fi_pre, fi_crt)

fi_item_pct %>%
  ggplot(mapping = aes (x = items, y = prop*100, fill = time)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Item-Level Frequency")+
  facet_wrap (~time, ncol = 2) +
  theme(legend.position = "none")+                            # Remove legend or change legend position
  theme(axis.text.x = element_text(angle = 45))
```

## 1.1 By race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
  filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.pre_covid = sum(fi_cat2_pre, na.rm = T)/n, 
             b.current = sum(fi_cat2_crt, na.rm = T)/n) %>%
  pivot_longer (cols = c("a.pre_covid", "b.current"), names_to = "time", values_to = "prop")%>%
  mutate (count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

fi_pct %>%
  ggplot(mapping = aes (x = race_ethnic, y = prop*100, fill = race_ethnic)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Based on FI Total Score")+
  theme(legend.position = "none")+
  facet_wrap (~time, ncol = 2)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi %>%
  filter (race_ethnic!= "NA")%>%
  group_by (Week, race_ethnic)%>%
  summarise (n = n(),
             prop = sum(fi_cat2_crt, na.rm = T)/n, 
             date = as.Date(min (StartDate))) %>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

fi_pct %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = race_ethnic)) +   
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  ggtitle (label = "Food Insecurity Trend during COVID-19")+
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
   filter (race_ethnic!= "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             I1_food_not_last_pre = sum(FI.001.a_r, na.rm = T)/n, 
             I1_food_not_last_crt = sum(FI.001.b_r, na.rm = T)/n,
             I2_not_balanced_meal_pre = sum(FI.002.a_r, na.rm = T)/n, 
             I2_not_balanced_meal_crt = sum(FI.002.b_r, na.rm = T)/n,
             I3_cut_skip_meal_pre = sum(FI.003.a_r, na.rm = T)/n, 
             I3_cut_skip_meal_crt = sum(FI.003.b_r, na.rm = T)/n,
             I4_freq_cut_skip_pre = sum(FI.004.a_r, na.rm = T)/n, 
             I4_freq_cut_skip_crt = sum(FI.004.b_r, na.rm = T)/n,
             I5_eat_less_pre = sum(FI.005.a_r, na.rm = T)/n, 
             I5_eat_less_crt = sum(FI.005.b_r, na.rm = T)/n,
             I6_hungry_pre = sum(FI.006.a_r, na.rm = T)/n, 
             I6_hungry_crt = sum(FI.006.b_r, na.rm = T)/n) 

fi_pre <- fi_pct %>%
  select (n, race_ethnic, ends_with ("pre"))%>%
  rename(I1_food_not_last = I1_food_not_last_pre,
         I2_not_balanced_meal = I2_not_balanced_meal_pre,
         I3_cut_skip_meal = I3_cut_skip_meal_pre,
         I4_freq_cut_skip = I4_freq_cut_skip_pre,
         I5_eat_less = I5_eat_less_pre,
         I6_hungry = I6_hungry_pre)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "a.pre_COVID",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))
  

fi_crt <- fi_pct %>%
  select (n,race_ethnic, ends_with ("crt"))%>%
  rename(I1_food_not_last = I1_food_not_last_crt,
         I2_not_balanced_meal = I2_not_balanced_meal_crt,
         I3_cut_skip_meal = I3_cut_skip_meal_crt,
         I4_freq_cut_skip = I4_freq_cut_skip_crt,
         I5_eat_less = I5_eat_less_crt,
         I6_hungry = I6_hungry_crt)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "b.Current",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

  
fi_item_pct <- rbind (fi_pre, fi_crt)

fi_item_pct %>%
  ggplot(mapping = aes (x = race_ethnic, y = prop*100, fill = race_ethnic)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Item-Level Frequency")+
  facet_wrap (time~items, ncol = 6) +
  theme(legend.position = "none")+                            # Remove legend or change legend position
  theme(axis.text.x = element_text(angle = 45))
```

## 1.2 By poverty level
```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
  filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
  summarise (n = n(),
             a.pre_covid = sum(fi_cat2_pre, na.rm = T)/n, 
             b.current = sum(fi_cat2_crt, na.rm = T)/n) %>%
  pivot_longer (cols = c("a.pre_covid", "b.current"), names_to = "time", values_to = "prop")%>%
  mutate (count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

fi_pct %>%
  ggplot(mapping = aes (x = poverty_cat, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Based on FI Total Score")+
  theme(legend.position = "none")+
  facet_wrap (~time, ncol = 2)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi %>%
  filter (poverty_cat!= "NA")%>%
  group_by (Week, poverty_cat)%>%
  summarise (n = n(),
             prop = sum(fi_cat2_crt, na.rm = T)/n, 
             date = as.Date(min (StartDate))) %>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

fi_pct %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = poverty_cat)) +   
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  ggtitle (label = "Food Insecurity Trend during COVID-19")+
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
   filter (poverty_cat!= "NA")%>%
  group_by (poverty_cat)%>%
  summarise (n = n(),
             I1_food_not_last_pre = sum(FI.001.a_r, na.rm = T)/n, 
             I1_food_not_last_crt = sum(FI.001.b_r, na.rm = T)/n,
             I2_not_balanced_meal_pre = sum(FI.002.a_r, na.rm = T)/n, 
             I2_not_balanced_meal_crt = sum(FI.002.b_r, na.rm = T)/n,
             I3_cut_skip_meal_pre = sum(FI.003.a_r, na.rm = T)/n, 
             I3_cut_skip_meal_crt = sum(FI.003.b_r, na.rm = T)/n,
             I4_freq_cut_skip_pre = sum(FI.004.a_r, na.rm = T)/n, 
             I4_freq_cut_skip_crt = sum(FI.004.b_r, na.rm = T)/n,
             I5_eat_less_pre = sum(FI.005.a_r, na.rm = T)/n, 
             I5_eat_less_crt = sum(FI.005.b_r, na.rm = T)/n,
             I6_hungry_pre = sum(FI.006.a_r, na.rm = T)/n, 
             I6_hungry_crt = sum(FI.006.b_r, na.rm = T)/n) 

fi_pre <- fi_pct %>%
  select (n, poverty_cat, ends_with ("pre"))%>%
  rename(I1_food_not_last = I1_food_not_last_pre,
         I2_not_balanced_meal = I2_not_balanced_meal_pre,
         I3_cut_skip_meal = I3_cut_skip_meal_pre,
         I4_freq_cut_skip = I4_freq_cut_skip_pre,
         I5_eat_less = I5_eat_less_pre,
         I6_hungry = I6_hungry_pre)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "a.pre_COVID",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))
  

fi_crt <- fi_pct %>%
  select (n,poverty_cat, ends_with ("crt"))%>%
  rename(I1_food_not_last = I1_food_not_last_crt,
         I2_not_balanced_meal = I2_not_balanced_meal_crt,
         I3_cut_skip_meal = I3_cut_skip_meal_crt,
         I4_freq_cut_skip = I4_freq_cut_skip_crt,
         I5_eat_less = I5_eat_less_crt,
         I6_hungry = I6_hungry_crt)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "b.Current",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

  
fi_item_pct <- rbind (fi_pre, fi_crt)

fi_item_pct %>%
  ggplot(mapping = aes (x = poverty_cat, y = prop*100, fill = poverty_cat)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Item-Level Frequency")+
  facet_wrap (time~items, ncol = 6) +
  theme(legend.position = "none")+                            # Remove legend or change legend position
  theme(axis.text.x = element_text(angle = 45))
```

## 1.3 By Child Disability Status
```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
  filter (disability!= "NA")%>%
  group_by (disability)%>%
  summarise (n = n(),
             a.pre_covid = sum(fi_cat2_pre, na.rm = T)/n, 
             b.current = sum(fi_cat2_crt, na.rm = T)/n) %>%
  pivot_longer (cols = c("a.pre_covid", "b.current"), names_to = "time", values_to = "prop")%>%
  mutate (count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

fi_pct %>%
  ggplot(mapping = aes (x = disability, y = prop*100, fill = disability)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Based on FI Total Score")+
  theme(legend.position = "none")+
  facet_wrap (~time, ncol = 2)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi %>%
  filter (disability!= "NA")%>%
  group_by (Week, disability)%>%
  summarise (n = n(),
             prop = sum(fi_cat2_crt, na.rm = T)/n, 
             date = as.Date(min (StartDate))) %>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

fi_pct %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = disability)) +   
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  ggtitle (label = "Food Insecurity Trend during COVID-19")+
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
   filter (disability!= "NA")%>%
  group_by (disability)%>%
  summarise (n = n(),
             I1_food_not_last_pre = sum(FI.001.a_r, na.rm = T)/n, 
             I1_food_not_last_crt = sum(FI.001.b_r, na.rm = T)/n,
             I2_not_balanced_meal_pre = sum(FI.002.a_r, na.rm = T)/n, 
             I2_not_balanced_meal_crt = sum(FI.002.b_r, na.rm = T)/n,
             I3_cut_skip_meal_pre = sum(FI.003.a_r, na.rm = T)/n, 
             I3_cut_skip_meal_crt = sum(FI.003.b_r, na.rm = T)/n,
             I4_freq_cut_skip_pre = sum(FI.004.a_r, na.rm = T)/n, 
             I4_freq_cut_skip_crt = sum(FI.004.b_r, na.rm = T)/n,
             I5_eat_less_pre = sum(FI.005.a_r, na.rm = T)/n, 
             I5_eat_less_crt = sum(FI.005.b_r, na.rm = T)/n,
             I6_hungry_pre = sum(FI.006.a_r, na.rm = T)/n, 
             I6_hungry_crt = sum(FI.006.b_r, na.rm = T)/n) 

fi_pre <- fi_pct %>%
  select (n, disability, ends_with ("pre"))%>%
  rename(I1_food_not_last = I1_food_not_last_pre,
         I2_not_balanced_meal = I2_not_balanced_meal_pre,
         I3_cut_skip_meal = I3_cut_skip_meal_pre,
         I4_freq_cut_skip = I4_freq_cut_skip_pre,
         I5_eat_less = I5_eat_less_pre,
         I6_hungry = I6_hungry_pre)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "a.pre_COVID",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))
  

fi_crt <- fi_pct %>%
  select (n,disability, ends_with ("crt"))%>%
  rename(I1_food_not_last = I1_food_not_last_crt,
         I2_not_balanced_meal = I2_not_balanced_meal_crt,
         I3_cut_skip_meal = I3_cut_skip_meal_crt,
         I4_freq_cut_skip = I4_freq_cut_skip_crt,
         I5_eat_less = I5_eat_less_crt,
         I6_hungry = I6_hungry_crt)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "b.Current",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

  
fi_item_pct <- rbind (fi_pre, fi_crt)

fi_item_pct %>%
  ggplot(mapping = aes (x = disability, y = prop*100, fill = disability)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Item-Level Frequency")+
  facet_wrap (time~items, ncol = 6) +
  theme(legend.position = "none")+                            # Remove legend or change legend position
  theme(axis.text.x = element_text(angle = 45))
```


## 1.4 By Single Parent Status
```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
  filter (single!= "NA")%>%
  group_by (single)%>%
  summarise (n = n(),
             a.pre_covid = sum(fi_cat2_pre, na.rm = T)/n, 
             b.current = sum(fi_cat2_crt, na.rm = T)/n) %>%
  pivot_longer (cols = c("a.pre_covid", "b.current"), names_to = "time", values_to = "prop")%>%
  mutate (count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

fi_pct %>%
  ggplot(mapping = aes (x = single, y = prop*100, fill = single)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Based on FI Total Score")+
  theme(legend.position = "none")+
  facet_wrap (~time, ncol = 2)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi %>%
  filter (single!= "NA")%>%
  group_by (Week, single)%>%
  summarise (n = n(),
             prop = sum(fi_cat2_crt, na.rm = T)/n, 
             date = as.Date(min (StartDate))) %>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

fi_pct %>%
  ggplot(mapping = aes (x = date, y = prop*100, fill = single)) +   
  geom_point(stat = 'summary') +
  geom_ribbon(aes(ymin = ci_low*100, ymax = ci_high*100), alpha = .3) +
  geom_line() +
  ggtitle (label = "Food Insecurity Trend during COVID-19")+
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pct <- fi_rct %>%
   filter (single!= "NA")%>%
  group_by (single)%>%
  summarise (n = n(),
             I1_food_not_last_pre = sum(FI.001.a_r, na.rm = T)/n, 
             I1_food_not_last_crt = sum(FI.001.b_r, na.rm = T)/n,
             I2_not_balanced_meal_pre = sum(FI.002.a_r, na.rm = T)/n, 
             I2_not_balanced_meal_crt = sum(FI.002.b_r, na.rm = T)/n,
             I3_cut_skip_meal_pre = sum(FI.003.a_r, na.rm = T)/n, 
             I3_cut_skip_meal_crt = sum(FI.003.b_r, na.rm = T)/n,
             I4_freq_cut_skip_pre = sum(FI.004.a_r, na.rm = T)/n, 
             I4_freq_cut_skip_crt = sum(FI.004.b_r, na.rm = T)/n,
             I5_eat_less_pre = sum(FI.005.a_r, na.rm = T)/n, 
             I5_eat_less_crt = sum(FI.005.b_r, na.rm = T)/n,
             I6_hungry_pre = sum(FI.006.a_r, na.rm = T)/n, 
             I6_hungry_crt = sum(FI.006.b_r, na.rm = T)/n) 

fi_pre <- fi_pct %>%
  select (n, single, ends_with ("pre"))%>%
  rename(I1_food_not_last = I1_food_not_last_pre,
         I2_not_balanced_meal = I2_not_balanced_meal_pre,
         I3_cut_skip_meal = I3_cut_skip_meal_pre,
         I4_freq_cut_skip = I4_freq_cut_skip_pre,
         I5_eat_less = I5_eat_less_pre,
         I6_hungry = I6_hungry_pre)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "a.pre_COVID",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))
  

fi_crt <- fi_pct %>%
  select (n,single, ends_with ("crt"))%>%
  rename(I1_food_not_last = I1_food_not_last_crt,
         I2_not_balanced_meal = I2_not_balanced_meal_crt,
         I3_cut_skip_meal = I3_cut_skip_meal_crt,
         I4_freq_cut_skip = I4_freq_cut_skip_crt,
         I5_eat_less = I5_eat_less_crt,
         I6_hungry = I6_hungry_crt)%>%
  pivot_longer (cols = c("I1_food_not_last", "I2_not_balanced_meal", "I3_cut_skip_meal", "I4_freq_cut_skip", "I5_eat_less", "I6_hungry"), names_to = "items", values_to = "prop")%>%
  mutate (time = "b.Current",
          count = n*prop) %>%
  mutate (moe = map2_dbl(prop, n, moe.p))

  
fi_item_pct <- rbind (fi_pre, fi_crt)

fi_item_pct %>%
  ggplot(mapping = aes (x = single, y = prop*100, fill = single)) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (prop*100-moe*100), 
                    ymax = (prop*100+moe*100)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, color = "black", size =3, position = position_dodge(1))+
  ggtitle(label = "Item-Level Frequency")+
  facet_wrap (time~items, ncol = 6) +
  theme(legend.position = "none")+                            # Remove legend or change legend position
  theme(axis.text.x = element_text(angle = 45))
```

# 2. Association Between Food Insecurity & Mental Health

## 2.1 Caregivers' Mental Health
```{r, echo=FALSE, message = FALSE, warning = FALSE}
# Extract and Code Caregivers' Mental Health Problems
depress_pre = rowMeans(master[,find_items("PHQ.001.[a-b]$", master)], na.rm=T)
depress_crt= rowMeans(master[,find_items("PHQ.002.[a-b]$", master)], na.rm=T)
anxiety_pre = rowMeans(master[,find_items("GAD2.001.[a-b]$", master)], na.rm=T)
anxiety_crt = rowMeans(master[,find_items("GAD2.002.[a-b]$", master)], na.rm=T)
master <- master %>%
  rowwise %>%
  mutate (depress_pre = mean (PHQ.001.a, PHQ.001.b, na.rm = TRUE)/3*100,
          depress_crt = mean (PHQ.002.a, PHQ.002.b, na.rm = TRUE)/3*100,
          anxiety_pre = mean (GAD2.001.a, GAD2.001.b, na.rm = TRUE)/3*100,
          anxiety_crt = mean (GAD2.002.a, GAD2.002.b, na.rm = TRUE)/3*100)%>%
  ungroup () %>%
  mutate (stress_pre = STRESS.001/4*100,
          stress_crt = STRESS.002/4*100,
          lonely_pre = LONE.001.a/4*100,
          lonely_crt = LONE.001.b/4*100)%>%
  rowwise %>%
  mutate (total_pre = sum(depress_pre, anxiety_pre, stress_pre, lonely_pre, na.rm = TRUE)/4,
          total_crt = sum(depress_crt, anxiety_crt, stress_crt, lonely_crt, na.rm = TRUE)/4)

pmh <- master %>%
  select(CaregiverID,month, Week, baseline, contains ("depress"),contains ("anxiety"), stress_pre, stress_crt, lonely_pre, lonely_crt, contains ("total"))

pmh_pre <- pmh %>%
  group_by (CaregiverID) %>%
  summarise (depress_pre = mean(depress_pre, na.rm = T),
             anxiety_pre = mean(anxiety_pre, na.rm = T),
             stress_pre = mean(stress_pre, na.rm = T),
             lonely_pre = mean(lonely_pre, na.rm = T))%>%
  ungroup()%>%
  rowwise ()%>%
  mutate (total_pre = sum(depress_pre, anxiety_pre, stress_pre, lonely_pre, na.rm = TRUE)/4)

#Select pmh_crt only for weeks after 19 & those who had responses in food insecurity
fi_id <- fi_rct $ CaregiverID
pmh_crt <- pmh %>%
  select (CaregiverID, Week, month, baseline, depress_crt, anxiety_crt, stress_crt, lonely_crt, total_crt)%>%
  filter (Week >= 19 & baseline == 0 & CaregiverID %in% fi_id)

fi_pmh <- merge (x = fi, y = pmh_crt, by.x = c("CaregiverID", "Week"), by.y = c("CaregiverID", "Week"), all.x = T)
fi_pmh_rct <- fi_pmh %>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup()
fi_pmh <- merge (x = fi_pmh, y = pmh_pre, by.x = "CaregiverID",  by.y = "CaregiverID")
```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_pmh_m <- fi_pmh_rct %>%
  mutate (food_insecurity = case_when (fi_cat2_crt == 0 ~ "Low Food Insecurity",
                                       fi_cat2_crt == 1 ~ "High Food Insecurity"))%>%
  group_by (food_insecurity) %>%
  summarise (n = n(), depress = mean(depress_crt, na.rm = T), 
             anxiety = mean(anxiety_crt, na.rm = T), 
             stress = mean(stress_crt, na.rm = T), 
             lonely = mean(lonely_crt, na.rm = T), 
             total = mean(total_crt, na.rm = T))%>%
  pivot_longer (cols = c("depress", "anxiety", "stress", "lonely", "total"), names_to = "problems", values_to = "mean")
             
 fi_pmh_sd <- fi_pmh_rct %>%
  mutate (food_insecurity = case_when (fi_cat2_crt == 0 ~ "Low Food Insecurity",
                                       fi_cat2_crt == 1 ~ "High Food Insecurity"))%>%
  group_by (food_insecurity) %>%
  summarise (depress = sd(depress_crt, na.rm = T), 
             anxiety = sd(anxiety_crt, na.rm = T), 
             stress = sd(stress_crt, na.rm = T), 
             lonely = sd(lonely_crt, na.rm = T), 
             total = sd(total_crt, na.rm = T))%>%
  pivot_longer (cols = c("depress", "anxiety", "stress", "lonely", "total"), names_to = "problems", values_to = "sd")
              
fi_pmh_m <- merge (x = fi_pmh_m, y = fi_pmh_sd, by.x = c("problems", "food_insecurity"),  by.y = c("problems", "food_insecurity"))%>%
  mutate (moe = map2_dbl(sd, n, moe.m))

fi_pmh_m %>%
  filter (problems == "total")%>%
  ggplot(mapping = aes (x = food_insecurity, y = mean, fill = food_insecurity )) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (mean-moe), 
                    ymax = (mean+moe)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(mean,2)),vjust = -1, color = "black", size =3, position = position_dodge(1)) +
  ggtitle (label = "Total problems")

fi_pmh_m %>%
  filter (problems != "total")%>%
  ggplot(mapping = aes (x = food_insecurity, y = mean, fill = food_insecurity )) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (mean-moe), 
                    ymax = (mean+moe)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(mean,2)),vjust = -1, color = "black", size =3, position = position_dodge(1)) +
  ggtitle (label = "Specific problems")+
  facet_wrap (~problems)

```

## 2.2 Child Mental Health 

```{r, echo=FALSE, message = FALSE, warning = FALSE}
# Extract and Code Children' Mental Health Problems
master <- master %>%
  mutate (fussy_pre = CBCL.001.a/2*100,
          fussy_crt = CBCL.002.a/2*100,
          fear_pre = CBCL.001.b/2*100,
          fear_crt = CBCL.002.b/2*100)

cp <- master %>%
  select(CaregiverID,month,Week,  BaselineWeek, baseline, contains ("fussy"),contains ("fear"))%>%
  mutate (ctotal_pre = sum(fussy_pre,fear_pre, na.rm = T)/2,
          ctotal_crt = sum(fussy_crt,fear_crt, na.rm = T)/2)

#Select cp_crt only for weeks after 19 & those who had responses in food insecurity
cp_crt <- cp %>%
  select (CaregiverID, Week, baseline, fussy_crt, fear_crt, ctotal_crt )%>%
  filter (Week >= 19 & baseline == 0 & CaregiverID %in% fi_id)

fi_cp <- merge (x = fi, y = cp_crt, by.x = c("CaregiverID", "Week"), by.y = c("CaregiverID", "Week"), all.x = T)
fi_cp_rct <- fi_cp %>%
  group_by (CaregiverID)%>%
  filter (Week == max (Week))%>%
  ungroup()

```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
fi_cp_m <- fi_cp_rct %>%
  mutate (food_insecurity = case_when (fi_cat2_crt == 0 ~ "Low Food Insecurity",
                                       fi_cat2_crt == 1 ~ "High Food Insecurity"))%>%
  group_by (food_insecurity) %>%
  summarise (n = n(), 
             fussy = mean(fussy_crt, na.rm = T), 
             fear = mean(fear_crt, na.rm = T), 
             total = mean(ctotal_crt, na.rm = T))%>%
  pivot_longer (cols = c("fussy", "fear", "total"), names_to = "problems", values_to = "mean")
             
 fi_cp_sd <- fi_cp_rct %>%
  mutate (food_insecurity = case_when (fi_cat2_crt == 0 ~ "Low Food Insecurity",
                                       fi_cat2_crt == 1 ~ "High Food Insecurity"))%>%
  group_by (food_insecurity) %>%
  summarise (fussy = sd(fussy_crt, na.rm = T), 
             fear = sd(fear_crt, na.rm = T), 
             total = sd(ctotal_crt, na.rm = T))%>%
  pivot_longer (cols = c("fussy", "fear", "total"), names_to = "problems", values_to = "sd")
             
              
fi_cp_m <- merge (x = fi_cp_m, y = fi_cp_sd, by.x = c("problems", "food_insecurity"),  by.y = c("problems", "food_insecurity"))%>%
  mutate (moe = map2_dbl(sd, n, moe.m))

fi_cp_m %>%
  filter (problems == "total")%>%
  ggplot(mapping = aes (x = food_insecurity, y = mean, fill = food_insecurity )) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (mean-moe), 
                    ymax = (mean+moe)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(mean,2)),vjust = -1, color = "black", size =3, position = position_dodge(1)) +
  ggtitle (label = "Total problems")

fi_cp_m %>%
  filter (problems != "total")%>%
  ggplot(mapping = aes (x = food_insecurity, y = mean, fill = food_insecurity )) +
  geom_bar (stat = "identity", position = position_dodge(1))+
  geom_errorbar(aes(ymin = (mean-moe), 
                    ymax = (mean+moe)),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(mean,2)),vjust = -1, color = "black", size =3, position = position_dodge(1)) +
  ggtitle (label = "Specific problems")+
  facet_wrap (~problems)

```

