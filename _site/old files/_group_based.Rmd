---
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
params: 
  subset: "single"
  title: "Analysis of single-parent households"
  grp.name: "Single"
title: "`r params$title`"
---



```{r -group-based-1, echo = F, include = F}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width=10)
options(knitr.kable.NA = '')
library(lme4)
library(broom.mixed)
library(sjPlot)
library(ggpubr)
library(plotly)
library(here)
library(mediation)

conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("select", "dplyr")

is.poverty <- (params$subset == "poverty150")
```

```{r -group-based-2 }
source(here("Scripts/score data.R"))
source(here("Functions/core_funs.R"))

scored$group = scored[,params$subset]
scored = mutate(scored, 
                group_f = ifelse(group == 1, params$grp.name, "Everyone else"))

# score discrimination questions
concernvars = names(scored)[grepl("^riserconcern", names(scored))]
scored$composite_concern = rowMeans(scored[,concernvars], na.rm=T)

discrimvars = names(scored)[grepl("^discrim", names(scored))]
scored$discrimination = rowMeans(scored[,discrimvars], na.rm=T)
```

```{r -group-based-3 }
#identify open-ended responses that discuss loneliness

scored = scored %>%
  mutate(lonely_challenge = case_when(
    OPEN.001 == "" ~ NA_real_,
    str_detect(OPEN.001, "lonely") ~ 1,
    str_detect(OPEN.001, "lone") ~ 1,
    str_detect(OPEN.001, "lonesome") ~ 1,
    str_detect(OPEN.001, "alone") ~ 1,
    str_detect(OPEN.001, "isol") ~ 1,
    str_detect(OPEN.001, "solita") ~ 1,
    str_detect(OPEN.001, "abando") ~ 1,
    TRUE ~ 0
  ))
```


```{r -group-based-4 }
scored = scored %>%
  mutate(wellbeing = 100-mental_health,
         child_wellbeing = 100-child_mental,
         unemployed_cat = ifelse(unemployed == 1, "Unemployed", "Employed"))
```


# Participation

```{r -group-based-5 }
last_assessment = scored %>%
  group_by(CaregiverID) %>%
  filter(Week == max(Week)) %>%
  ungroup()
n_groups = table(last_assessment$group_f)
n_groups = n_groups[params$grp.name]

scored = scored %>%
   mutate(Week = case_when(
    Week < 17 ~ Week,
    Week %% 2 == 0 ~ NA_real_,
    TRUE ~ Week
  )) %>%
  filter(!is.na(Week)) 
```

Since the beginning of the survey, `r prettyNum(n_groups, big.mark = ",")` `r str_remove(params$grp.name, " caregivers")` caregivers have participated in RAPID. 

```{r -group-based-6 }
count_by_week(group, params$grp.name)
```

```{r policy-state-7 }
n_care = length(unique(scored$CaregiverID))
date.min = format(min(as.Date(scored$Date), na.rm = T), format = "%B %d, %Y")
date.max = format(max(as.Date(scored$Date), na.rm = T), format = "%B %d, %Y")
perc = scored %>%
  group_by(CaregiverID) %>%
  filter(Week == max(Week))
perc.black = 100*sum(perc$black, na.rm=T)/nrow(perc)
perc.latinx = 100*sum(perc$latinx, na.rm=T)/nrow(perc)
perc.fpl = 100*sum(perc$poverty150, na.rm=T)/nrow(perc)
```

These analyses are based on responses collected from `r papaja::printnum(n_care, format = "d")` caregivers between the dates of `r date.min` and `r date.max`. These caregivers represent a range of voices: `r papaja::printnum(perc.black)`\% are Black/African American, `r papaja::printnum(perc.latinx)`\% are LatinX, and `r papaja::printnum(perc.fpl)`\% live at or below 1.5 times the federal poverty line. Proportions/percentages are calculated based on the item-level response rates, not out of the total sample size. The data for these analyses are *not* weighted. 

# Demographics{.tabset}

## Age

```{r -group-based-7 }
dist_cat(age, data = filter(scored, group == 1))
```

## Income

Income is presented in thousands of dollars per year.

```{r -group-based-8 }
dist_cat_group(income.cat, group_f, scored)
```

```{r -group-based-9, results = 'asis'}
dist_cat_group_sig(income.cat, group_f, scored)
```

## Poverty

```{r -group-based-10 }
dist_cat_group(poverty_cat, group_f, scored)
```

```{r -group-based-11, results = 'asis', eval = !is.poverty}
dist_cat_group_sig(poverty_cat, group_f, scored)
```

## Employment

```{r -group-based-12 }
dist_cat_group(work_status, group_f, scored)
```

## Employment change

```{r -group-based-13 }
dist_cat_group(employment_change, group_f, scored)
```

```{r -group-based-14, results = 'asis'}
dist_cat_group_sig(employment_change, group_f, scored)
```
## Race

```{r -group-based-15 }
dist_cat_group(race_cat, group_f, scored)
```

```{r -group-based-16, results = 'asis', eval = FALSE}
dist_cat_group_sig(race_cat, group_f, scored)
```

## Ethnicity

```{r -group-based-17 }
dist_cat_group(latinx_cat, group_f, scored)
```

```{r -group-based-18, results = 'asis', eval = (params$subset != "latinx")}
dist_cat_group_sig(latinx_cat, group_f, scored)
```

## Single parent households

```{r -group-based-19 }
dist_cat_group(single_cat, group_f, scored)
```

```{r -group-based-20, results = 'asis', eval = (params$subset != "single")}
dist_cat_group_sig(single_cat, group_f, scored)
```


# Mental health (raw scores){.tabset} 

## Caregiver {.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.

### On average

```{r -group-based-21 }
average_by_group(mental_health, group_f, "mental health problems", last_assessment)
```

```{r -group-based-22 }
average_by_group_sig(mental_health, group_f, last_assessment)
```

### Over time

```{r -group-based-23 }
average_by_week(mental_health, group_f, "mental health problems")
```

```{r -group-based-24, eval = (params$subset == "single"), results = 'asis'}
spline.data = scored %>%
  mutate(
    SP1 = case_when(
      Week < 15 ~ Week-15,
      TRUE ~ 0),
    SP2 = case_when(
      Week >= 15 ~ Week-15,
      TRUE ~ 0)
  )

spline.model = lmer(mental_health ~ SP1*group_f + SP2*group_f + 
                      (1 | CaregiverID), data = spline.data)

tidy(spline.model) %>%
  mutate(p.value = map(statistic, ~pt(abs(.x), df = 20000, lower.tail = F)*2)) %>%
  mutate(p.value = papaja::printp(p.value)) %>%
  kable(., digits = 2) %>%
  kable_styling(full_width = T)

plot_model(spline.model, type = "pred", terms = c("SP1", "group_f"), 
           title = "Slope before July 13")
plot_model(spline.model, type = "pred", terms = c("SP2", "group_f"), 
           title = "Slope after July 13")

```



### Correlates of{.tabset}

#### Test 

```{r -group-based-25 }
correlates = c("material_hardship", "work_status", "single", "age")

correlates = correlates[correlates != params$subset]

if(!(params$subset %in% c("black", "latinx"))){
  correlates = c(correlates, "race_ethnic")
}
if(params$subset != "poverty150"){
  correlates = c(correlates, "income.cat", "poverty_cat")
}

test_data = last_assessment %>%
  filter(!is.na(group_f)) %>%
  filter(group_f != "Everyone else") %>%
  select(mental_health, all_of(correlates)) 

test.df = data.frame(correlates = correlates)
test.df = test.df %>%
  mutate(model = map(correlates, ~lm(as.formula(paste("mental_health~", .x)), 
                                     data = test_data))) %>%
  mutate(model_int = map(correlates, ~lm(as.formula(paste0("mental_health~", .x, "*group_f")), 
                                     data = last_assessment))) %>%
  mutate(summary = map(model, anova)) %>%
  mutate(summary_int = map(model_int, car::Anova, type = "III")) %>%
  mutate(p.value = map(summary, "Pr(>F)"),
         p.value = map_dbl(p.value, 1),
         p.value = map_dbl(p.value, p.adjust, method = "holm"),
         sig = map(p.value, ~ifelse(.x < .05, 1, 0)),
         p.value = map_chr(p.value, papaja::printp)) %>%
    mutate(p.value_int = map(summary_int, "Pr(>F)"),
         p.value_int = map_dbl(p.value_int, 3),
         p.value_int = map_dbl(p.value_int, p.adjust, method = "holm"),
         sig_int = map(p.value_int, ~ifelse(.x < .05, 1, 0)),
         p.value_int = map_chr(p.value_int, papaja::printp)) 
```

```{r -group-based-26, results = 'asis'}
test.df %>%
  select(correlates, p.value, p.value_int) %>%
  kable(., col.names = c("Variable", "Within group", "Difference between group and sample"),
        caption = paste("Significance of linear model using variable to predict mental health within", params$grp.name, "caregivers")) %>%
  kable_styling(full_width = T)
```

#### Figures (within sample)

```{r -group-based-27 }
test_within = test.df %>%
  filter(sig == 1)
if(nrow(test_within) > 0){
  lapply(test_within$model, FUN = plot_model, type = "pred")}
```

#### Figures (between sample)

```{r -group-based-28 }
test_within = test.df %>%
  filter(sig_int == 1)

if(nrow(test_within) > 0){
  lapply(test_within$model_int, FUN = plot_model, type = "int")}
```

## Anxiety{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-29 }
average_by_group(anxiety, group_f, "mental health problems", last_assessment)
```


```{r -group-based-30 }
average_by_group_sig(anxiety, group_f, last_assessment)
```

### Over time

```{r -group-based-31 }
average_by_week(anxiety, group_f, "mental health problems")
```


## Depression{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-32 }
average_by_group(depress, group_f, "mental health problems", last_assessment)
```


```{r -group-based-33 }
average_by_group_sig(depress, group_f, last_assessment)
```
### Over time

```{r -group-based-34 }
average_by_week(depress, group_f, "mental health problems")
```


## Stress{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-35 }
average_by_group(stress, group_f, "mental health problems", last_assessment)
```


```{r -group-based-36 }
average_by_group_sig(stress, group_f, last_assessment)
```

### Over time

```{r -group-based-37 }
average_by_week(stress, group_f, "mental health problems")
```


## Loneliness{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-38 }
average_by_group(lonely, group_f, "mental health problems", last_assessment)
```


```{r -group-based-39 }
average_by_group_sig(lonely, group_f, last_assessment)
```

### Over time

```{r -group-based-40 }
average_by_week(lonely, group_f, "mental health problems")
```

```{r -group-based-41 }
is.single <- params$subset == "single"

if(is.single){
  single_header = print("### Text-based (average)")
}else{single_header = ""}
```

`r single_header`

```{r -group-based-42, eval = is.single}
percent_by_group(lonely_challenge, group_f, last_assessment)
```

```{r -group-based-43 }
if(is.single){
  single_header = print("### Text-based (Over time)")
}else{single_header = ""}
```

`r single_header`

```{r -group-based-44, eval = is.single}
percent_by_week(lonely_challenge, group_f)
```

## Child{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-45 }
average_by_group(child_mental, group_f, "child mental health problems", last_assessment)
```


```{r -group-based-46 }
average_by_group_sig(child_mental, group_f, last_assessment)
```

### Over time

```{r -group-based-47 }
average_by_week(child_mental, group_f, "child mental health problems")
```

## Fussy{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-48 }
average_by_group(fussy, group_f, "child mental health problems", last_assessment)
```


```{r -group-based-49 }
average_by_group_sig(fussy, group_f,  last_assessment)
```

### Over time

```{r -group-based-50 }
average_by_week(fussy, group_f, "child mental health problems")
```

## Fear{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-51 }
average_by_group(fear, group_f, "child mental health problems", last_assessment)
```

```{r -group-based-52 }
average_by_group_sig(fear, group_f,  last_assessment)
```

### Over time

```{r -group-based-53 }
average_by_week(fear, group_f, "child mental health problems")
```


# Mental health (change scores){.tabset} 

```{r -group-based-54 }
wb_vars = c("mental_health", "child_mental",
            "anxiety", "depress", "stress", "lonely",
            "fussy", "fear")

# calculate each person's deviation from their pre-pandemic score

prepan = scored %>%
  filter(Week == 0) %>%
  select(CaregiverID, all_of(wb_vars)) %>%
  rename_at(all_of(wb_vars), ~paste0(.x, "_pre"))

scored = full_join(scored, prepan)

new_scores = scored %>%
  select(CaregiverID, Week, all_of(c(wb_vars, paste0(wb_vars, "_pre")))) %>%
  gather(variable, value, -CaregiverID, -Week) %>%
  mutate(time = ifelse(str_detect(variable, "_pre"), "pre", "post")) %>%
  mutate(variable = str_remove(variable, "_pre")) %>%
  spread(time, value) %>%
  mutate(value = map2_dbl(post, pre, ~.x-.y)) %>%
  select(-post, -pre) %>%
  spread(variable, value) 

new_scores = scored %>%
  select(-all_of(c(wb_vars, paste0(wb_vars, "_pre")))) %>%
  full_join(new_scores) %>%
  mutate(wellbeing = 100-mental_health,
         child_wellbeing = 100-child_mental,
         unemployed_cat = ifelse(unemployed == 1, "Unemployed", "Employed"))

new_last = new_scores %>%
  group_by(CaregiverID) %>%
  filter(Week == max(Week)) %>%
  ungroup()

```


## Caregiver {.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.

### On average

```{r -group-based-55 }
average_by_group(mental_health, group_f, "mental health problems", new_last)
```

```{r -group-based-56 }
average_by_group_sig(mental_health, group_f, new_last)
```

### Over time

```{r -group-based-57 }
average_by_week(mental_health, group_f, "mental health problems", new_scores)
```

```{r -group-based-58, eval = (params$subset == "single"), results = 'asis'}
spline.data = new_scores %>%
  mutate(
    SP1 = case_when(
      Week < 15 ~ Week-15,
      TRUE ~ 0),
    SP2 = case_when(
      Week >= 15 ~ Week-15,
      TRUE ~ 0)
  )

spline.model = lmer(mental_health ~ SP1*group_f + SP2*group_f + 
                      (1 | CaregiverID), data = spline.data)

tidy(spline.model) %>%
  mutate(p.value = map(statistic, ~pt(abs(.x), df = 20000, lower.tail = F)*2)) %>%
  mutate(p.value = papaja::printp(p.value)) %>%
  kable(., digits = 2) %>%
  kable_styling(full_width = T)

plot_model(spline.model, type = "pred", terms = c("SP1", "group_f"), 
           title = "Slope before July 13")
plot_model(spline.model, type = "pred", terms = c("SP2", "group_f"), 
           title = "Slope after July 13")

```



### Correlates of{.tabset}

#### Test 

```{r -group-based-59 }
correlates = c("material_hardship", "work_status", "single", "age")

correlates = correlates[correlates != params$subset]

if(!(params$subset %in% c("black", "latinx"))){
  correlates = c(correlates, "race_ethnic")
}
if(params$subset != "poverty150"){
  correlates = c(correlates, "income.cat", "poverty_cat")
}

test_data = new_last %>%
  filter(!is.na(group_f)) %>%
  filter(group_f != "Everyone else") %>%
  select(mental_health, all_of(correlates)) 

test.df = data.frame(correlates = correlates)
test.df = test.df %>%
  mutate(model = map(correlates, ~lm(as.formula(paste("mental_health~", .x)), 
                                     data = test_data))) %>%
  mutate(model_int = map(correlates, ~lm(as.formula(paste0("mental_health~", .x, "*group_f")), 
                                     data = last_assessment))) %>%
  mutate(summary = map(model, anova)) %>%
  mutate(summary_int = map(model_int, car::Anova, type = "III")) %>%
  mutate(p.value = map(summary, "Pr(>F)"),
         p.value = map_dbl(p.value, 1),
         p.value = map_dbl(p.value, p.adjust, method = "holm"),
         sig = map(p.value, ~ifelse(.x < .05, 1, 0)),
         p.value = map_chr(p.value, papaja::printp)) %>%
    mutate(p.value_int = map(summary_int, "Pr(>F)"),
         p.value_int = map_dbl(p.value_int, 3),
         p.value_int = map_dbl(p.value_int, p.adjust, method = "holm"),
         sig_int = map(p.value_int, ~ifelse(.x < .05, 1, 0)),
         p.value_int = map_chr(p.value_int, papaja::printp)) 
```

```{r -group-based-60, results = 'asis'}
test.df %>%
  select(correlates, p.value, p.value_int) %>%
  kable(., col.names = c("Variable", "Within group", "Difference between group and sample"),
        caption = paste("Significance of linear model using variable to predict mental health within", params$grp.name, "caregivers")) %>%
  kable_styling(full_width = T)
```

#### Figures (within sample)

```{r -group-based-61 }
test_within = test.df %>%
  filter(sig == 1)
if(nrow(test_within) > 0){
  lapply(test_within$model, FUN = plot_model, type = "pred")}
```

#### Figures (between sample)

```{r -group-based-62 }
test_within = test.df %>%
  filter(sig_int == 1)

if(nrow(test_within) > 0){
  lapply(test_within$model_int, FUN = plot_model, type = "int")}
```

## Anxiety{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-63 }
average_by_group(anxiety, group_f, "mental health problems", new_last)
```


```{r -group-based-64 }
average_by_group_sig(anxiety, group_f, new_last)
```

### Over time

```{r -group-based-65 }
average_by_week(anxiety, group_f, "mental health problems", new_scores)
```


## Depression{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-66 }
average_by_group(depress, group_f, "mental health problems", new_last)
```

```{r -group-based-67 }
average_by_group_sig(depress, group_f, new_last)
```
### Over time

```{r -group-based-68 }
average_by_week(depress, group_f, "mental health problems", new_scores)
```


## Stress{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-69 }
average_by_group(stress, group_f, "mental health problems", new_last)
```

```{r -group-based-70 }
average_by_group_sig(stress, group_f, new_last)
```
### Over time

```{r -group-based-71 }
average_by_week(stress, group_f, "mental health problems", new_scores)
```


## Loneliness{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-72 }
average_by_group(lonely, group_f, "mental health problems", new_last)
```

```{r -group-based-73 }
average_by_group_sig(stress, group_f,  new_last)
```

### Over time

```{r -group-based-74 }
average_by_week(lonely, group_f, "mental health problems", new_scores)
```

## Child{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-75 }
average_by_group(child_mental, group_f, "child mental health problems", new_last)
```

```{r -group-based-76 }
average_by_group_sig(child_mental, group_f, new_last)
```
### Over time

```{r -group-based-77 }
average_by_week(child_mental, group_f, "child mental health problems", new_scores)
```

## Fussy{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-78 }
average_by_group(fussy, group_f, "child mental health problems", new_last)
```


```{r -group-based-79 }
average_by_group_sig(fussy, group_f, new_last)
```

### Over time

```{r -group-based-80 }
average_by_week(fussy, group_f, "child mental health problems", new_scores)
```

## Fear{.tabset}

Values represent the difference between a caregiver's response for the past week and their "baseline" or retrospective report of this variable pre-pandemic.


### On average

```{r -group-based-81 }
average_by_group(fear, group_f, "child mental health problems", new_last)
```

```{r -group-based-82 }
average_by_group_sig(fear, group_f,  new_last)
```
### Over time

```{r -group-based-83 }
average_by_week(fear, group_f, "child mental health problems", new_scores)
```

# Material hardship{.tabset}



## Overall

```{r -group-based-84 }
percent_by_group(material_hardship, group_f, last_assessment)
```

## Types of hardship

```{r -group-based-85 }
plot = scored %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(material_hardship)) %>%
  group_by(CaregiverID) %>%
  dplyr::filter(Week == max(Week)) %>%
  ungroup() %>%
  select(group_f, starts_with("diff_pay")) %>%
  gather(category, response, starts_with("diff_pay")) %>%
  mutate(category = str_remove(category, "diff_pay_")) %>%
  dplyr::filter(!is.na(response)) %>%
  group_by(group_f, category) %>%
  summarize(
    n = n(),
    percent = mean(response)) %>%
  mutate(moe = map2_dbl(percent, n, moe.p)) %>%
  mutate_at(vars(percent, moe), ~100*.x) %>%
  ggplot(aes(
    x = reorder(category, desc(percent)), 
    y = percent, 
    fill = percent,
    text = paste0(round(percent,1), "%"))) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = percent-moe, 
                    ymax = percent + moe), 
                width = .2) +
  coord_flip() +
  labs(x = NULL, y = NULL, fill = NULL, title = "Percent of households having difficulty paying for:") +
  facet_wrap(~group_f, ncol = 2) +
  theme_pubr()

ggplotly(plot, tooltip = "text")
```

```{r -group-based-86, results = 'asis'}
scored %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(material_hardship)) %>%
  group_by(CaregiverID) %>%
  dplyr::filter(Week == max(Week)) %>%
  ungroup() %>%
  select(group_f, starts_with("diff_pay")) %>%
  gather(category, response, starts_with("diff_pay")) %>%
  mutate(category = str_remove(category, "diff_pay_")) %>%
  dplyr::filter(!is.na(response)) %>%
  group_by(category) %>%
  nest() %>%
  mutate(ttest = map(data, ~t.test(response~group_f, data = .x))) %>%
  mutate(ttest = map(ttest, broom::tidy)) %>%
  select(category, ttest) %>%
  unnest(cols = c(ttest)) %>%
  select(category, estimate, statistic, p.value, parameter) %>%
  rename(difference = estimate, 
         df = parameter) %>%
  mutate(p.value = p.adjust(p.value, method = "holm"),
         p.value = papaja::printp(p.value)) %>%
  kable(., caption = "t-tests comparing hardship across groups. p-values adjusted for multiple comparisons using a Holm correction.") %>%
  kable_styling(full_width = T)
```

## By Week

```{r -group-based-87 }
percent_by_week(material_hardship, group_f)
```

```{r -group-based-88 }
is.single <- params$subset == "single"

if(is.single){
  single_header = print("## Chain Reaction{.tabset}")
}else{single_header = ""}
```

`r single_header`

```{r -group-based-89, eval = is.single, results = 'asis'}
set.seed(1234)
full_data = last_assessment %>%
  select(material_hardship, mental_health, child_mental, group_f) %>%
  filter_all(~!is.na(.x))

mod.med_apath = lm(mental_health ~ material_hardship*group_f,
                     data = full_data)

mod.med_bpath = lm(child_mental ~ mental_health*group_f + material_hardship*group_f,
                     data = full_data)

Mod.Med_group <- mediation::mediate(mod.med_apath, mod.med_bpath,    
                         covariates = list(group_f = params$grp.name), 
                         boot = T,   
                         boot.ci.type = "bca",
                         treat="material_hardship", 
                         mediator="mental_health")

tidy(Mod.Med_group) %>%
  kable(., caption = "mediation model within group", digits = 3) %>%
  kable_styling(full_width = T)
```


```{r -group-based-90, eval = is.single}
set.seed(1234)
Mod.Med_test <- mediation::mediate(mod.med_apath, mod.med_bpath,    
                         boot = T,   
                         boot.ci.type = "bca",
                         treat="material_hardship", 
                         mediator="mental_health")

test.model = mediation::test.modmed(Mod.Med_test, 
                                    covariates.1 = list(group_f = "Everyone else"), 
            
                                    covariates.2 = list(group_f = params$grp.name), 
                                    sims = 100)

test.model
```


```{r -group-based-91}
if(is.single){
  single_header = "### Correlations

**Within `r params$grp.name` caregivers**"
}else{single_header = ""}
```

`r single_header`

```{r -group-based-92, eval = is.single}
la.df = as.data.frame(last_assessment)

Rmat = cor(la.df[la.df$group_f != "Everyone else", c("mental_health", "child_mental", "material_hardship")], use = "pairwise")

cor.plot(Rmat)
```



# Childcare{.tabset}

## On average

```{r -group-based-93 }
percent_by_group(cc2_nonparental, group_f, last_assessment)
```

## Type of childcare (average)

```{r -group-based-94 }
plot = scored %>%
  select(CaregiverID, Week, Date, group_f, starts_with("cc2_")) %>%
  dplyr::filter(Week != 13) %>%
  dplyr::filter(Week != 27) %>%
  dplyr::filter(Week != 29) %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(cc2_nonparental)) %>%
  select(-cc2_expected_change) %>%
  select(-cc2_nonparental) %>%
  gather(variable, value, starts_with("cc2_")) %>%
  mutate(variable = str_remove(variable, "cc2_")) %>%
  dplyr::filter(Week != 4) %>%
  group_by(CaregiverID, variable) %>% 
  filter(Week == max(Week)) %>%
  ungroup() %>%
  group_by(variable, group_f) %>%
  summarize(n = n(),
            percent = sum(value)/n) %>%
  mutate(moe = map2_dbl(percent, n, moe.p)) %>%
  mutate_at(vars(percent, moe), ~100*.x) %>%
  ggplot(aes(x = variable, 
             y = percent,
             group = variable,
             fill = variable,
             text = paste0(
               "N: ", n,
               "\nPercent: ", round(percent,1)
             ))) +
  geom_bar(stat = "identity")+
  geom_errorbar(aes(ymin = percent-moe, ymax = percent + moe), alpha = .2) +
  facet_wrap(~group_f, ncol = 1) +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

## Type of childcare (over time)

```{r -group-based-95 }
plot = scored %>%
  select(Week, Date, group_f, starts_with("cc2_")) %>%
  dplyr::filter(Week != 13) %>%
  dplyr::filter(Week != 27) %>%
  dplyr::filter(Week != 29) %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(cc2_nonparental)) %>%
  select(-cc2_expected_change) %>%
  gather(variable, value, starts_with("cc2_")) %>%
  mutate(variable = str_remove(variable, "cc2_")) %>%
  dplyr::filter(Week != 4 | variable == "cc2_nonparental") %>%
  group_by(Week, variable, group_f) %>%
  summarize(Date = min(Date,na.rm=T),
            n = n(),
            percent = sum(value)/n) %>%
  mutate(
    Date = case_when(
      Week == 0 ~ as.Date("2020-04-13"),
      TRUE ~ Date),
    label = case_when(
      Week == 0 ~ "Pre-pandemic",
      TRUE ~ format(Date, "%B %d")
    ),
    moe = map2_dbl(percent, n, moe.p)) %>%
  mutate_at(vars(percent, moe), ~100*.x) %>%
  ggplot(aes(x = Date, 
             y = percent,
             group = variable,
             fill = variable,
             text = paste0(
               "N: ", n,
               "\nPercent: ", round(percent,1),
               "\nDate: ", label
             ))) +
  geom_ribbon(aes(ymin = percent-moe, ymax = percent + moe), alpha = .2) +
  geom_line() +
  facet_wrap(~group_f, ncol = 1) +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```


## By week

```{r -group-based-96 }
percent_by_week(cc2_nonparental, group_f)
```


# Discrimination{.tabset}

## Concerns for children (average)

```{r -group-based-97 }
dist_cont_group(composite_concern, group_f)
```


```{r -group-based-98 }
average_by_group(composite_concern, group_f, 
                 "Concerns for children (RISER)", last_assessment)
```

## Concerns for children (over time)

```{r -group-based-99 }
average_by_week(composite_concern, group_f, "Concerns for children (RISER)")
```

## Caregiver well-being

```{r -group-based-100 }
model.wb.concern = lmer(wellbeing ~ group_f*composite_concern + (1|CaregiverID),
                        data = scored)
model.wb.concern.sig = broom.mixed::tidy(model.wb.concern)

model.wb.concern.sig = model.wb.concern.sig %>%
  filter(grepl(":",term))

model.wb.concern.sig = ifelse(abs(model.wb.concern.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between well-being and concerns for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between well-being and concerns for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.wb.concern.sig`

```{r -group-based-101 }
plot_model(model.wb.concern, 
           type = "pred", 
           terms = c("composite_concern", "group_f"),
           axis.title = c("Concerns for children", 
                          "Caregiver well-being"),
           legend.title = "Group") +
  theme_pubr()
```

## Child well-being

```{r -group-based-102 }
model.cwb.concern = lmer(child_wellbeing ~ group_f*composite_concern + (1|CaregiverID),
                        data = scored)
model.cwb.concern.sig = broom.mixed::tidy(model.cwb.concern)

model.cwb.concern.sig = model.cwb.concern.sig %>%
  filter(grepl(":",term))

model.cwb.concern.sig = ifelse(abs(model.cwb.concern.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between child well-being and concerns for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between child well-being and concerns for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.cwb.concern.sig`

```{r -group-based-103 }
plot_model(model.cwb.concern, 
           type = "pred", 
           terms = c("composite_concern", "group_f"),
           axis.title = c("Concerns for children", 
                          "Child well-being"),
           legend.title = "Group") +
  theme_pubr()
```


## Discrimination (average)

```{r -group-based-104 }
dist_cont_group(discrimination, group_f)
```


```{r -group-based-105 }
average_by_group(discrimination, group_f, 
                 "Concerns for children (RISER)", last_assessment)
```

## Discrimination (over time)

```{r -group-based-106 }
average_by_week(discrimination, group_f, "Concerns for children (RISER)")
```

## Caregiver well-being

```{r -group-based-107 }
model.wb.discrim = lmer(wellbeing ~ group_f*discrimination + (1|CaregiverID),
                        data = scored)
model.wb.discrim.sig = broom.mixed::tidy(model.wb.discrim)

model.wb.discrim.sig = model.wb.discrim.sig %>%
  filter(grepl(":",term))

model.wb.discrim.sig = ifelse(abs(model.wb.discrim.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between well-being and discrimination for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between well-being and discrimination for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.wb.discrim.sig`

```{r -group-based-108 }
plot_model(model.wb.discrim, 
           type = "pred", 
           terms = c("discrimination", "group_f"),
           axis.title = c("Experiences of discrimination", 
                          "Caregiver well-being"),
           legend.title = "Group") +
  theme_pubr()
```


## Child well-being

```{r -group-based-109 }
model.cwb.discrim = lmer(child_wellbeing ~ group_f*discrimination + (1|CaregiverID),
                        data = scored)
model.cwb.discrim.sig = broom.mixed::tidy(model.cwb.discrim)

model.cwb.discrim.sig = model.cwb.discrim.sig %>%
  filter(grepl(":",term))

model.cwb.discrim.sig = ifelse(abs(model.cwb.discrim.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between child well-being and discrimination for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between child well-being and discrimination for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.cwb.discrim.sig`

```{r -group-based-110 }
plot_model(model.cwb.discrim, 
           type = "pred", 
           terms = c("discrimination", "group_f"),
           axis.title = c("Experiences of discrimination", 
                          "Child well-being"),
           legend.title = "Group") +
  theme_pubr()
```


