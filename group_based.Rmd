---
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
params: 
  subset: "black_cat"
  title: "my title!"
  grp.name: "Test"
  
---


```{r usda-1, echo = F}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width=10)
options(knitr.kable.NA = '')
```

```{r}
source(here("Scripts/score data.R"))
source(here("Functions/core_funs.R"))
scored$group = scored[,params$subset]
scored = mutate(scored, 
                group_f = ifelse(group == 1, params$grp.name, "Everyone else"))
```

# Participation

```{r}
last_assessment = scored %>%
  group_by(CaregiverID) %>%
  filter(Week == max(Week)) %>%
  ungroup()
n_groups = table(last_assessment$group_f)
n_groups = n_groups[params$grp.name]

scored = scored %>%
   mutate(Week = case_when(
    Week < 17 ~ Week,
    Week %% 2 == 0 ~ NA_real_,
    TRUE ~ Week
  )) %>%
  filter(!is.na(Week))
```

Since the beginning of the survey, `r prettyNum(n_groups, big.mark = ",")` `r str_remove(params$grp.name, " caregivers")` caregivers have participated in RAPID. 

```{r}
count_by_week(group, params$grp.name)
```

# Demographics{.tabset}

## Age

```{r}
dist_cat(age, data = filter(scored, group == 1))
```

## Income

Income is presented in thousands of dollars per year.

```{r}
dist_cat_group(income.cat, group_f, scored)
```

## Poverty

```{r}
dist_cat_group(poverty_cat, group_f, scored)
```

## Race

```{r}
dist_cat_group(race_cat, group_f, scored)
```

## Ethnicity

```{r}
dist_cat_group(latinx_cat, group_f, scored)
```

# Well-being{.tabset} 
## Caregiver{.tabset}

### On average

```{r}
average_by_group(mental_health, group_f, "mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(mental_health, group_f, "mental health problems")
```


## Child{.tabset}

### On average

```{r}
average_by_group(child_mental, group_f, "child mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(child_mental, group_f, "child mental health problems")
```

# Material hardship{.tabset}

## Overall

```{r}
percent_by_group(material_hardship, group_f, last_assessment)
```

## Types of hardship

```{r}
plot = scored %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(material_hardship)) %>%
  group_by(CaregiverID) %>%
  dplyr::filter(Week == max(Week)) %>%
  ungroup() %>%
  select(group_f, starts_with("diff_pay")) %>%
  gather(category, response, starts_with("diff_pay")) %>%
  mutate(category = str_remove(category, "diff_pay_")) %>%
  dplyr::filter(!is.na(response)) %>%
  group_by(group_f, category) %>%
  summarize(
    n = n(),
    percent = mean(response)) %>%
  mutate(moe = map2_dbl(percent, n, moe.p)) %>%
  mutate_at(vars(percent, moe), ~100*.x) %>%
  ggplot(aes(
    x = reorder(category, desc(percent)), 
    y = percent, 
    fill = percent,
    text = paste0(round(percent,1), "%"))) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = percent-moe, 
                    ymax = percent + moe), 
                width = .2) +
  coord_flip() +
  labs(x = NULL, y = NULL, fill = NULL, title = "Percent of households having difficulty paying for:") +
  facet_wrap(~group_f, ncol = 2) +
  theme_pubr()

ggplotly(plot, tooltip = "text")
```


## By Week

```{r}
percent_by_week(material_hardship, group_f)
```


# Childcare

## On average

```{r}
percent_by_group(cc2_nonparental, group_f, last_assessment)
```

## By week

```{r}
percent_by_week(cc2_nonparental, group_f)
```




