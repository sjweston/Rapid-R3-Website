---
title: "Debt and Bills"
author: "Sihong"
date: "4/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include = FALSE}
library(here)
library(knitr)
library(readr)
library(haven)
library(tidyverse)
library(lavaan)
conflict_prefer("summarise", "dplyr")

```

```{r, echo=FALSE, message = FALSE}
#Define functions
moe.p = function(p, n){
  q = 1-p
  moe = 1.96*sqrt((p*q)/n)
  return(moe)
}

moe.m = function(sd,n){
  moe = 1.96*sd/sqrt(n)
  return(moe)}

combine.cat = function(x, cols, id, newvar.name){
  subset = x[,c(id, "Week", cols)]
  names(subset) = c("id", "Week", paste0("X",1:length(cols)))
  subset = suppressWarnings(gather(subset, "key", "value", -id, -Week))
  subset = filter(subset, !is.na(value))
  subset$key = gsub("X", "", subset$key)
  subset = group_by(subset, id, Week)
  subset = summarise(subset, newvar = paste(key, collapse = ",")) %>% ungroup()
  names(subset) = c(id,"Week", newvar.name)
  x = suppressMessages(full_join(x, subset))
  return(x)
}

find_items = function(string, data2){
  items = names(data2)
  locations = which(grepl(string, items))
  final = items[locations]
  return(final)
}

my.max = function(x) ifelse (!all(is.na(x)), max(x,na.rm = TRUE), NA)
my.min = function(x) ifelse (!all(is.na(x)), min(x,na.rm = TRUE), NA)
```

```{r, echo=FALSE, message = FALSE, warning = FALSE, include=FALSE}
master_2020 <- read_sav(here::here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2020.sav"))
master_2021 <- read_sav(here::here("../../Data Management R3/CC_Clean Survey Data/00_R3 MasterFile/MasterFile_groupings_2021.sav"))

master <- full_join (master_2020, master_2021)

# Remove cases should be excluded
master <- master %>%
  filter ( CaregiverID != "" & is.na(Exclude) == T)

master = master %>%
  group_by(CaregiverID, Week) %>%
  filter(row_number() == max(row_number())) %>%
  ungroup()

total_week <- my.max(master$Week)

```


```{r, echo=FALSE, message = FALSE, warning = FALSE}
#Code demographics
master <- master %>%
  mutate (month = case_when(
                  Week == 0 ~ "Pre-COVID",
                  Week >0 & Week <= 4 ~ "April",
                  Week >=5 & Week <=8 ~ "May",
                  Week >=9 & Week <=13 ~ "June",
                  Week >=14 & Week <=17 ~ "July",
                  Week >=18 & Week <=21 ~ "August",
                  Week >=22 & Week <=26 ~ "September",
                  Week >=27 ~ "October"), 
           baseline = case_when (Week - BaselineWeek == 1 ~ 1, 
                                 Week - BaselineWeek > 1 ~ 0))

##Race/ethnicity - 1 = black, 2 = latinx, 3 = white

master <- master %>%
  mutate (RaceGroup = na_if (RaceGroup, 99))%>%
    mutate(
      minority = ifelse(RaceGroup != 5, 1, 0),
      black = ifelse(RaceGroup == 3, 1, 0),
      native = ifelse(RaceGroup == 1, 1, 0),
      asian = ifelse(RaceGroup == 2, 1, 0),
      hawaii = ifelse(RaceGroup == 4, 1, 0),
      white = ifelse(RaceGroup == 5, 1, 0),
      other_race = ifelse(RaceGroup %in% c(6, 7), 1, 0))

master <- master %>%
      mutate(latinx = case_when(
        DEMO.008 == 1 ~ 1,
        DEMO.008 == 0 ~ 0,
        DEMO.008.2 == 0 ~ 0,
        DEMO.008.2 == 1 ~ 1,
        DEMO.008.2 == 2 ~ 1,
        DEMO.008.3_1 == 1 ~ 0,
        DEMO.008.3_2 == 1 ~ 1,
        DEMO.008.3_3 == 1 ~ 1,
        DEMO.008.3_4 == 1 ~ 1,
        DEMO.008.3_5 == 1 ~ 1,
        DEMO.008.3_6 == 1 ~ 1,
        DEMO.008.3_7 == 1 ~ 1,
        TRUE ~ NA_real_))

master <- master %>%
mutate (race_ethnic = case_when(
      black == 1 ~ "1",
      latinx == 1 ~ "2",
      !is.na(black) ~ "3",
      !is.na(latinx) ~ "3",
      TRUE ~ NA_character_))  

##Povertyline - 0 = high income, 1 = low income
master <- master %>%
  mutate (poverty_cat = FPL.2019.UM.150)

master <- master %>%
  mutate (FPL_line = case_when (STATE_CODED == 1 & JOB.002 == 1 ~ 12760,
                                STATE_CODED == 1 & JOB.002 == 2 ~ 17240,
                                STATE_CODED == 1 & JOB.002 == 3 ~ 21720,
                                STATE_CODED == 1 & JOB.002 == 4 ~ 26200,
                                STATE_CODED == 1 & JOB.002 == 5 ~ 30680,
                                STATE_CODED == 1 & JOB.002 == 6 ~ 35160,
                                STATE_CODED == 1 & JOB.002 == 7 ~ 39640,
                                STATE_CODED == 1 & JOB.002 == 8 ~ 44120,
                                STATE_CODED == 1 & JOB.002 == 9 ~ 48600,
                                STATE_CODED == 1 & JOB.002 == 10 ~ 53080,
                                STATE_CODED == 1 & JOB.002 == 11 ~ 57560,
                                STATE_CODED == 1 & JOB.002 == 12 ~ 62040,
                                STATE_CODED == 1 & JOB.002 == 13 ~ 66520,
                                STATE_CODED == 1 & JOB.002 == 14 ~ 71000,
                                STATE_CODED == 1 & JOB.002 == 15 ~ 75480,
                                STATE_CODED == 1 & JOB.002 == 16 ~ 79960,
                                STATE_CODED == 1 & JOB.002 == 17 ~ 84440,
                                STATE_CODED == 1 & JOB.002 == 18 ~ 88920,
                                STATE_CODED == 1 & JOB.002 == 19 ~ 93400,
                                STATE_CODED == 1 & JOB.002 == 20 ~ 97880,
                                STATE_CODED == 1 & JOB.002 == 21 ~ 102360, 
                                STATE_CODED == 2 & JOB.002 == 1 ~ 15950,
                                STATE_CODED == 2 & JOB.002 == 2 ~ 21550,
                                STATE_CODED == 2 & JOB.002 == 3 ~ 27150,
                                STATE_CODED == 2 & JOB.002 == 4 ~ 32750,
                                STATE_CODED == 2 & JOB.002 == 5 ~ 38350,
                                STATE_CODED == 2 & JOB.002 == 6 ~ 43950,
                                STATE_CODED == 2 & JOB.002 == 7 ~ 49550,
                                STATE_CODED == 2 & JOB.002 == 8 ~ 55150,
                                STATE_CODED == 2 & JOB.002 == 9 ~ 60750,
                                STATE_CODED == 2 & JOB.002 == 10 ~ 66350,
                                STATE_CODED == 2 & JOB.002 == 11 ~ 71950,
                                STATE_CODED == 2 & JOB.002 == 12 ~ 77550,
                                STATE_CODED == 2 & JOB.002 == 13 ~ 83150,
                                STATE_CODED == 2 & JOB.002 == 14 ~ 88750,
                                STATE_CODED == 2 & JOB.002 == 15 ~ 94350,
                                STATE_CODED == 2 & JOB.002 == 16 ~ 99950,
                                STATE_CODED == 2 & JOB.002 == 17 ~ 105550,
                                STATE_CODED == 2 & JOB.002 == 18 ~ 111150,
                                STATE_CODED == 2 & JOB.002 == 19 ~ 116750,
                                STATE_CODED == 2 & JOB.002 == 20 ~ 122350,
                                STATE_CODED == 2 & JOB.002 == 21 ~ 127950,
                                STATE_CODED == 3 & JOB.002 == 1 ~ 14680,
                                STATE_CODED == 3 & JOB.002 == 2 ~ 19830,
                                STATE_CODED == 3 & JOB.002 == 3 ~ 24980,
                                STATE_CODED == 3 & JOB.002 == 4 ~ 30130,
                                STATE_CODED == 3 & JOB.002 == 5 ~ 35280,
                                STATE_CODED == 3 & JOB.002 == 6 ~ 40430,
                                STATE_CODED == 3 & JOB.002 == 7 ~ 45580,
                                STATE_CODED == 3 & JOB.002 == 8 ~ 50730,
                                STATE_CODED == 3 & JOB.002 == 9 ~ 55880,
                                STATE_CODED == 3 & JOB.002 == 10 ~ 61030,
                                STATE_CODED == 3 & JOB.002 == 11 ~ 66180,
                                STATE_CODED == 3 & JOB.002 == 12 ~ 71330,
                                STATE_CODED == 3 & JOB.002 == 13 ~ 76480,
                                STATE_CODED == 3 & JOB.002 == 14 ~ 81630,
                                STATE_CODED == 3 & JOB.002 == 15 ~ 86780,
                                STATE_CODED == 3 & JOB.002 == 16 ~ 91930,
                                STATE_CODED == 3 & JOB.002 == 17 ~ 97080,
                                STATE_CODED == 3 & JOB.002 == 18 ~ 102230,
                                STATE_CODED == 3 & JOB.002 == 19 ~ 107380,
                                STATE_CODED == 3 & JOB.002 == 20 ~ 112530,
                                STATE_CODED == 3 & JOB.002 == 21 ~ 117680))


#Material hardship
master <- master %>%
  combine.cat(cols = find_items("FSTR.002_.{1}$", master), 
              id = "CaregiverID",
              newvar.name = "FSTR.002_cat")
  

master <- master %>%
  mutate (diff_pay_food = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("1", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_), 
          diff_pay_utilities = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("3", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_house = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("2", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_healthcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("4", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_social = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("5", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_emotional = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("6", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_childcare = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("7", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_),
          diff_pay_other = case_when(
                          FSTR.001 == 0 ~ 0, 
                          grepl("8", FSTR.002_cat) ~ 1,
                          TRUE ~ NA_real_))

master <- master %>%
  rowwise() %>%
  mutate(material_hardship = case_when(
    Week == 0 ~ NA_real_,
    TRUE ~ sum(c_across(starts_with("diff_pay_")), na.rm=T))) %>%
  ungroup() %>%
  mutate(num_hardship = material_hardship,
    material_hardship = ifelse(material_hardship > 0, 1, 0)) 

## Children with special needs
master <- combine.cat(x = master, 
                       cols = find_items("HEALTH.005_[0-9]{1}$", master), 
                       id = "CaregiverID",
                       newvar.name = "HEALTH.005_cat")
master <- master %>%
   mutate (disability = case_when (HEALTH.005_1 == 1 ~ 1,
                                   HEALTH.005_2 == 1 ~ 1,
                                   HEALTH.005_3 == 1 ~ 1,
                                   HEALTH.005_4 == 1 ~ 1,
                                   HEALTH.005_5 == 1 ~ 0,
                                   HEALTH.005_6 == 1 ~ 1,
                                   TRUE ~ NA_real_))


## Single parent status
master <- master %>%
  mutate (single = case_when (
                   DEMO.002 %in% c(3,4,5,7,8)~1, 
                   DEMO.011 %in% c(2,4)~1,
                   !is.na(DEMO.002)~0,
                   !is.na(DEMO.011)~0,
                   TRUE ~ NA_real_))
                     
## Employment status
master <- combine.cat (x = master,
                       cols = find_items ("JOB.010_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.010_cat")
  
master$JOB.010_cat = gsub("10", "0", master$JOB.010_cat)
master$working_pre = ifelse (grepl("[1,2,6]", master$JOB.010_cat), 1, 0)
master = combine.cat (x = master,
                       cols = find_items ("JOB.008_.{1,2}$", master), 
                       id = "CaregiverID",
                       newvar.name = "JOB.008_cat")
master$JOB.008_cat = gsub("10", "0", master$JOB.008_cat)
master <- master %>%
  mutate (work_status = case_when(
                        grepl ("1", JOB.008_cat) ~ "1", 
                        grepl ("2", JOB.008_cat) ~ "1", 
                        grepl ("3", JOB.008_cat) ~ "0", 
                        grepl ("4", JOB.008_cat) ~ "0", 
                        grepl ("5", JOB.008_cat) ~ "1", 
                        JOB.008.2 == 1 ~ "1",
                        JOB.008.2 %in% c(2,3) ~ "0",
                        TRUE~NA_character_),
          work_status_pre = case_when(
                        grepl ("1", JOB.010_cat) ~ "1", 
                        grepl ("2", JOB.010_cat) ~ "1", 
                        grepl ("3", JOB.010_cat) ~ "0", 
                        grepl ("4", JOB.010_cat) ~ "0", 
                        grepl ("5", JOB.010_cat) ~ "1", 
                        TRUE~NA_character_))
#1 = stable employed 2 = became unemployed 3 = became employed4 = stable unemployed

# Region
master <- master %>%
  mutate (region = na_if (DEMO.001.b, 5))

# Born US

master <- master %>%
  mutate (bornUS = ifelse (DEMO.012 == 1, 1, 0))

# expect stimulus

master <- master %>%
  mutate (expect_stimulus = ifelse (STIM.001%in%c(1,2) | STIM.002%in%c(1,2) | STIM.003%in%c(1,2), 1, 0))

master_dem <- master %>%
  group_by (CaregiverID) %>%
  summarise (BaselineWeek = my.max (BaselineWeek),
             race_ethnic = my.max(race_ethnic),
             poverty_150 = my.max(poverty_cat),
             FPL_line = my.min (FPL_line),
             income19 = my.min (allyearly2019),
             income20 = my.min(allyearly2020),
             material_hardship = my.max(material_hardship),
             disability = my.max (disability),
             single = my.max (single),
             work_status = my.max (work_status),
             work_status_pre = my.max (work_status_pre), 
             region = my.max(region), 
             bornUS = my.max(bornUS), 
             expect_stimulus = my.max (expect_stimulus))%>%
  mutate ( ep_change = case_when(
                        work_status == 1 & work_status_pre == 1 ~ "1", 
                        work_status == 1 & work_status_pre == 0 ~ "2", 
                        work_status == 0 & work_status_pre == 1 ~ "3", 
                        work_status == 0 & work_status_pre == 0 ~ "4", 
                        TRUE~NA_character_), 
           FPL_pct = income19/FPL_line, 
           poverty_3c = case_when (FPL_pct < 2 ~ "a.Below 200%FPL", 
                                   FPL_pct >=2 & FPL_pct < 4 ~ "b.200-400%FPL", 
                                   FPL_pct >=4 ~ "c.Above 400%FPL"))%>%
  mutate (race_ethnic = case_when (
                        race_ethnic == 1 ~ "Black", 
                        race_ethnic == 2 ~ "Latinx", 
                        race_ethnic == 3 ~ "White", 
                        TRUE~NA_character_),
          poverty_150 = case_when (
                        poverty_150 == 1 ~ "Below 150%FPL", 
                        poverty_150 == 0 ~ "Above 150%FPL", 
                        TRUE~NA_character_),
          material_hardship = case_when (
                        material_hardship == 1 ~ "With material hardship", 
                        material_hardship == 0 ~ "Without material hardship", 
                        TRUE~NA_character_),
          disability = case_when (
                        disability == 1 ~ "With disability", 
                        disability == 0 ~ "Without disability", 
                        TRUE~NA_character_),
          single = case_when (
                        single == 1 ~ "Single parent", 
                        single == 0 ~ "Dual parent", 
                        TRUE~NA_character_),
          work_status = case_when (
                        work_status == 1 ~ "Employed", 
                        work_status == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          work_status_pre = case_when (
                        work_status_pre == 1 ~ "Employed", 
                        work_status_pre == 0 ~ "Unemployed", 
                        TRUE~NA_character_),
          ep_change = case_when (
                        ep_change == 1 ~ "Stable employed", 
                        ep_change == 2 ~ "Became employed", 
                        ep_change == 3 ~ "Became unemployed",
                        ep_change == 4 ~ "Stable unemployed",
                        TRUE~NA_character_), 
          region = case_when (
                        region == 1 ~ "Northeast", 
                        region == 2 ~ "Midwest", 
                        region == 3 ~ "South", 
                        region == 4 ~ "West",
                        TRUE~NA_character_), 
          bornUS = case_when (bornUS == 1 ~ "Born US", 
                              bornUS == 0 ~ "Not Born US"), 
          expect_stimulus = case_when (expect_stimulus == 1 ~ "Expect to get stimulus", 
                              expect_stimulus == 0 ~ "Not expect to get stimulus"))

```

```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt <- master %>%
  select (CaregiverID, Week, StartDate, contains ("DEBT"))%>%
  filter (Week %in% c(53))

debt <- merge (x = debt, y = master_dem, by.x = "CaregiverID", by.y = "CaregiverID", all.x = T)

num_responses = function(x){length(which(!is.na(x)))}
debt.num <- debt %>%
  group_by(Week) %>%
  summarize_all(num_responses) %>%
  gather("Variable", "num_responses",-Week) %>%
  mutate(week = paste0("Week", Week),
         week = factor(Week, levels = paste0("Week", c(1:total_week)))) %>%
  spread(Week, num_responses)

#Save data to .csv file to clean string variables
#write.csv (debt, file = "debt.csv")
#Reload the debt dataset
#read.csv (file = "debt updated.csv", header = T )

debt <- debt%>%
  mutate (DEBT.002_1 = as.numeric (DEBT.002_1), 
          DEBT.002_2 = as.numeric (DEBT.002_2), 
          DEBT.002_3 = as.numeric (DEBT.002_3), 
          DEBT.002_4 = as.numeric (DEBT.002_4), 
          DEBT.002_5 = as.numeric (DEBT.002_5), 
          DEBT.002_6 = as.numeric (DEBT.002_6), 
          DEBT.002_7 = as.numeric (DEBT.002_7), 
          DEBT.002_8 = as.numeric (DEBT.002_8))%>%
  mutate (debt_rent =  na_if (DEBT.002_1, 0), 
          debt_mortgage = na_if (DEBT.002_2, 0),
          debt_medical = na_if (DEBT.002_3, 0),
          #debt_mortgage = na_if (na_if (DEBT.002_2, 0), 400000), 
          #debt_medical = na_if (na_if (DEBT.002_3, 0), 3500000), 
          debt_utility = na_if (DEBT.002_4, 0), 
          debt_credit_card = na_if (DEBT.002_5, 0), 
          #debt_student_loan = na_if (na_if (na_if (DEBT.002_6,0), 1020000), 400000),  
          debt_student_loan = na_if (DEBT.002_6,0),
          debt_family_friend_loan = na_if (DEBT.002_7, 0), 
          debt_other_bills = na_if (DEBT.002_8, 0))%>%
  mutate (debt_rent_b = ifelse (debt_rent > 0, 1, 0), 
             debt_mortgage_b= ifelse (debt_mortgage > 0, 1, 0), 
             debt_medical_b= ifelse (debt_medical > 0, 1, 0), 
             debt_utility_b= ifelse (debt_utility > 0, 1, 0), 
             debt_credit_card_b= ifelse (debt_credit_card > 0, 1, 0), 
             debt_student_loan_b= ifelse (debt_student_loan > 0, 1, 0), 
             debt_family_friend_loan_b= ifelse (debt_family_friend_loan > 0, 1, 0), 
             debt_other_bills_b= ifelse (debt_other_bills > 0, 1, 0))

debt_variable = c("debt_rent", "debt_mortgage", "debt_medical", "debt_utility", "debt_credit_card", "debt_student_loan", "debt_family_friend_loan", "debt_other_bills")
debt$debt_total_amount = rowMeans(debt[, debt_variable], na.rm = T)

```

# 0. Sample Disclaimer
  * This set of analyses is based on responses collected from 961 caregivers between the dates of April 14th 2021 and April 16th 2021 These caregivers represent a range of voices: 9.58% are non-Latinx Black/African American, 14.79% are Latinx, and 22.08% live at or below 1.5 times the federal poverty line.  Proportions/percentages are calculated based on the item-level response rates, not out of the total sample size. The data for these analyses are not weighted. \

# 1. Have debt and source of debt
  * Survey question: Do you currently have overdue bills and/or debt? By this we mean rent, mortgage, utility, medical, student loan, credit card, or other bills that are past due. Please also consider money you have borrowed from family or friends that you need to repay.\
    + Yes\
    + No\
  * How much do you owe for each of the following that is past due or unpaid? If you do not know the exact amount, please do your best to estimate to the nearest $1,000. If you do not have any debt in the category, please enter a 0. \
    + Rent (past due)\
    + Mortgage payments (past due)\
    + Medical bills (past due)\
    + Utility bills (past due)\
    + Credit card balances\
    + Student loan balances\
    + Loan from families or friends\
    + Other unpaid bills\

## 1.1 Overall
```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt_smy1 <- debt %>%
  filter (is.na(DEBT.001)==F)%>%
  summarise (n = n(), 
             prop = sum (DEBT.001, na.rm = T)/n, 
             )%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          debt = "a.overall_have_debt", 
          cat = "Overall have debt")

debt_smy2 <- debt %>%
  filter (is.na(DEBT.001)==F)%>%
  summarise (n = n(), 
             debt_rent = sum (debt_rent_b, na.rm = T)/n, 
             debt_mortgage = sum (debt_mortgage_b, na.rm = T)/n, 
             debt_medical = sum (debt_medical_b, na.rm = T)/n, 
             debt_utility = sum (debt_utility_b, na.rm = T)/n, 
             debt_credit_card = sum (debt_credit_card_b, na.rm = T)/n, 
             debt_student_loan = sum (debt_student_loan_b, na.rm = T)/n, 
             debt_family_friend_loan = sum (debt_family_friend_loan_b, na.rm = T)/n, 
             debt_other_bills = sum (debt_other_bills_b, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("debt_rent", "debt_mortgage", "debt_medical", "debt_utility", "debt_credit_card", "debt_student_loan", "debt_family_friend_loan", "debt_other_bills"), names_to = "debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe, 
          cat = "Source of debt")

debt_smy <- rbind (debt_smy1, debt_smy2)

debt_smy %>%
  ggplot(mapping = aes (y = reorder(debt, -prop), x = prop*100, fill = debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  facet_wrap (~cat, ncol = 2)+
  theme(legend.position = "none")+
  ylab ("Have debt and source of debt")+
  xlab ("Percentage")
```

## 1.2 Race/ethnicity
```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt_smy1 <- debt %>%
  filter (is.na(DEBT.001)==F & race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(), 
             prop = sum (DEBT.001, na.rm = T)/n, 
             )%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy1 %>%
  ggplot(mapping = aes (y = race_ethnic, x = prop*100, fill = race_ethnic)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("race/ethnicity")+
  xlab ("Percentage of people who currently have debt")+
  ggtitle ("People who have debt")

debt_smy2 <- debt %>%
  filter (is.na(DEBT.001)==F & race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  summarise (n = n(), 
             debt_rent = sum (debt_rent_b, na.rm = T)/n, 
             debt_mortgage = sum (debt_mortgage_b, na.rm = T)/n, 
             debt_medical = sum (debt_medical_b, na.rm = T)/n, 
             debt_utility = sum (debt_utility_b, na.rm = T)/n, 
             debt_credit_card = sum (debt_credit_card_b, na.rm = T)/n, 
             debt_student_loan = sum (debt_student_loan_b, na.rm = T)/n, 
             debt_family_friend_loan = sum (debt_family_friend_loan_b, na.rm = T)/n, 
             debt_other_bills = sum (debt_other_bills_b, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("debt_rent", "debt_mortgage", "debt_medical", "debt_utility", "debt_credit_card", "debt_student_loan", "debt_family_friend_loan", "debt_other_bills"), names_to = "debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)


debt_smy2 %>%
  ggplot(mapping = aes (y = reorder (debt, -prop), x = prop*100, fill = debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -0.2, hjust = 0, size = 2, color = "black",  position = position_dodge(1))+
  facet_wrap (~race_ethnic, ncol = 1)+
  theme(legend.position = "none")+
  ylab ("Source of debt")+
  xlab ("Percentage of poeple who have each category of debt")+
  ggtitle ("Source of debt")
 

```

## 1.3 Poverty level (200% and 400%FPL)
```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt_smy1 <- debt %>%
  filter (is.na(DEBT.001)==F & poverty_3c  != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(), 
             prop = sum (DEBT.001, na.rm = T)/n, 
             )%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy1 %>%
  ggplot(mapping = aes (y = poverty_3c, x = prop*100, fill = poverty_3c)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("race/ethnicity")+
  xlab ("Percentage of people who currently have debt")+
  ggtitle ("People who have debt")

debt_smy2 <- debt %>%
  filter (is.na(DEBT.001)==F & poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  summarise (n = n(), 
             debt_rent = sum (debt_rent_b, na.rm = T)/n, 
             debt_mortgage = sum (debt_mortgage_b, na.rm = T)/n, 
             debt_medical = sum (debt_medical_b, na.rm = T)/n, 
             debt_utility = sum (debt_utility_b, na.rm = T)/n, 
             debt_credit_card = sum (debt_credit_card_b, na.rm = T)/n, 
             debt_student_loan = sum (debt_student_loan_b, na.rm = T)/n, 
             debt_family_friend_loan = sum (debt_family_friend_loan_b, na.rm = T)/n, 
             debt_other_bills = sum (debt_other_bills_b, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("debt_rent", "debt_mortgage", "debt_medical", "debt_utility", "debt_credit_card", "debt_student_loan", "debt_family_friend_loan", "debt_other_bills"), names_to = "debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)


debt_smy2 %>%
  ggplot(mapping = aes (y = reorder (debt, -prop), x = prop*100, fill = debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -0.2, hjust = 0, size = 2, color = "black",  position = position_dodge(1))+
  facet_wrap (~poverty_3c, ncol = 1)+
  theme(legend.position = "none")+
  ylab ("Source of debt")+
  xlab ("Percentage of poeple who have each category of debt")+
  ggtitle ("Source of debt")
 

```

# 2. Amount of Debt Families Currently Have
  * Note: analyses done in the subset of 303 caregivers who reported currently having debt. Statistics were based on non-zero amount of debt reported by caregivers\
  * Note: Outliers are not presented for the clarify of the figures\
  
# 2.1 Debt/Income Ratio
  * Presented as the ratio of current debt/monthly income (= 2020 yearly income / 12)\

### 2.1.1 Overall
```{r, echo=FALSE, message = FALSE, warning = FALSE}

debt <- debt %>%
  mutate (income19_m = income19/12, 
          income20_m = income20/12, 
          debt_income19 = debt_total_amount/income19_m, 
          debt_income20 = debt_total_amount/income20_m, 
          debt_income19_c = case_when (debt_income19 <= 0.5 ~ "0-0.5 month income", 
                                       debt_income19 > 0.5 & debt_income19 <= 1 ~ "0.5 - 1 months income",
                                       debt_income19 > 1 & debt_income19 <= 2 ~ "1-2 months income",
                                       debt_income19 > 2 & debt_income19 <= 3 ~ "2-3 months income",
                                       debt_income19 > 3 & debt_income19 <= 6 ~ "3-6 months income",
                                       debt_income19 > 6 & debt_income19 <= 12 ~ "6-12 months income",
                                       debt_income19 > 12 & debt_income19 <= 24 ~ "12-24 months income",
                                       debt_income19 > 24  ~ "24+ months income"), 
          debt_income20_c = case_when (debt_income20 <= 0.5 ~ "0-0.5 month income", 
                                       debt_income20 > 0.5 & debt_income20 <= 1 ~ "0.5 - 1 months income",
                                       debt_income20 > 1 & debt_income20 <= 2 ~ "1-2 months income",
                                       debt_income20 > 2 & debt_income20 <= 3 ~ "2-3 months income",
                                       debt_income20 > 3 & debt_income20 <= 6 ~ "3-6 months income",
                                       debt_income20 > 6 & debt_income20 <= 12 ~ "6-12 months income",
                                       debt_income20 > 12 & debt_income20 <= 24 ~ "12-24 months income",
                                       debt_income20 > 24 ~ "24+ months income"))

debt_smy <- debt %>%
  filter (DEBT.001 == 1)%>%
  mutate (a.less_than_0.5 = ifelse (debt_income20 <= 0.5, 1, 0), 
          b.0.5_to_1 = ifelse (debt_income20 > 0.5 & debt_income20 <= 1 , 1, 0), 
          c.1_to_2 = ifelse (debt_income20 > 1 & debt_income20 <= 2, 1, 0), 
          d.2_to_3 = ifelse (debt_income20 > 2 & debt_income20 <= 3, 1, 0), 
          e.3_to_6 = ifelse (debt_income20 > 3 & debt_income20 <= 6, 1, 0), 
          f.6_to_12 = ifelse (debt_income20 > 6 & debt_income20 <= 12, 1, 0), 
          g.12_to_24 = ifelse (debt_income20 > 12 & debt_income20 <= 24, 1, 0), 
          h.more_than_24 = ifelse (debt_income20 > 24, 1, 0))%>%
  summarise (n = n(),
             a.less_than_0.5 = sum (a.less_than_0.5, na.rm = T)/n, 
             b.0.5_to_1 = sum (b.0.5_to_1, na.rm = T)/n, 
             c.1_to_2 = sum (c.1_to_2, na.rm = T)/n, 
             d.2_to_3 = sum (d.2_to_3, na.rm = T)/n, 
             e.3_to_6 = sum (e.3_to_6, na.rm = T)/n, 
             f.6_to_12 = sum (f.6_to_12, na.rm = T)/n, 
             g.12_to_24 = sum (g.12_to_24, na.rm = T)/n, 
             h.more_than_24 = sum (h.more_than_24, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.less_than_0.5", "b.0.5_to_1", "c.1_to_2", "d.2_to_3", "e.3_to_6", "f.6_to_12", "g.12_to_24", "h.more_than_24"), names_to = "ratio", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

my_colors <- RColorBrewer::brewer.pal(9, "Blues")[2:9]
          
 debt_smy %>%
  ggplot(mapping = aes (x =ratio, y = prop*100, fill = ratio)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(ymin = ci_low*100,                        # Error bar 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  xlab ("Debt to Monthly Income Ratio")+
  ylab ("Percentage")+
  scale_fill_manual(values = my_colors)+
  theme_bw()+
  theme(legend.position = "none")
          
```

### 2.1.2 By race/ethnicity

```{r, echo=FALSE, message = FALSE, warning = FALSE}

debt_smy <- debt %>%
  filter (DEBT.001 == 1 & race_ethnic != "NA")%>%
  mutate (a.less_than_0.5 = ifelse (debt_income20 <= 0.5, 1, 0), 
          b.0.5_to_1 = ifelse (debt_income20 > 0.5 & debt_income20 <= 1 , 1, 0), 
          c.1_to_2 = ifelse (debt_income20 > 1 & debt_income20 <= 2, 1, 0), 
          d.2_to_3 = ifelse (debt_income20 > 2 & debt_income20 <= 3, 1, 0), 
          e.3_to_6 = ifelse (debt_income20 > 3 & debt_income20 <= 6, 1, 0), 
          f.6_to_12 = ifelse (debt_income20 > 6 & debt_income20 <= 12, 1, 0), 
          g.12_to_24 = ifelse (debt_income20 > 12 & debt_income20 <= 24, 1, 0), 
          h.more_than_24 = ifelse (debt_income20 > 24, 1, 0))%>%
  group_by (race_ethnic)%>%
  summarise (n = n(),
             a.less_than_0.5 = sum (a.less_than_0.5, na.rm = T)/n, 
             b.0.5_to_1 = sum (b.0.5_to_1, na.rm = T)/n, 
             c.1_to_2 = sum (c.1_to_2, na.rm = T)/n, 
             d.2_to_3 = sum (d.2_to_3, na.rm = T)/n, 
             e.3_to_6 = sum (e.3_to_6, na.rm = T)/n, 
             f.6_to_12 = sum (f.6_to_12, na.rm = T)/n, 
             g.12_to_24 = sum (g.12_to_24, na.rm = T)/n, 
             h.more_than_24 = sum (h.more_than_24, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.less_than_0.5", "b.0.5_to_1", "c.1_to_2", "d.2_to_3", "e.3_to_6", "f.6_to_12", "g.12_to_24", "h.more_than_24"), names_to = "ratio", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

my_colors <- RColorBrewer::brewer.pal(9, "Blues")[2:9]
          
 debt_smy %>%
  ggplot(mapping = aes (x =ratio, y = prop*100, fill = ratio)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(ymin = ci_low*100,                        # Error bar 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -0.5, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  xlab ("Debt to Monthly Income Ratio")+
  ylab ("Percentage")+
  scale_fill_manual(values = my_colors)+
  theme_bw()+
  theme(legend.position = "none")+
   facet_wrap (~race_ethnic, ncol = 3)+
   theme(axis.text.x = element_text(angle = 90))
          
```

### 2.1.3 By poverty level (200% and 400% FPL)

```{r, echo=FALSE, message = FALSE, warning = FALSE}

debt_smy <- debt %>%
  filter (DEBT.001 == 1 & poverty_3c != "NA")%>%
  mutate (a.less_than_0.5 = ifelse (debt_income20 <= 0.5, 1, 0), 
          b.0.5_to_1 = ifelse (debt_income20 > 0.5 & debt_income20 <= 1 , 1, 0), 
          c.1_to_2 = ifelse (debt_income20 > 1 & debt_income20 <= 2, 1, 0), 
          d.2_to_3 = ifelse (debt_income20 > 2 & debt_income20 <= 3, 1, 0), 
          e.3_to_6 = ifelse (debt_income20 > 3 & debt_income20 <= 6, 1, 0), 
          f.6_to_12 = ifelse (debt_income20 > 6 & debt_income20 <= 12, 1, 0), 
          g.12_to_24 = ifelse (debt_income20 > 12 & debt_income20 <= 24, 1, 0), 
          h.more_than_24 = ifelse (debt_income20 > 24, 1, 0))%>%
  group_by (poverty_3c)%>%
  summarise (n = n(),
             a.less_than_0.5 = sum (a.less_than_0.5, na.rm = T)/n, 
             b.0.5_to_1 = sum (b.0.5_to_1, na.rm = T)/n, 
             c.1_to_2 = sum (c.1_to_2, na.rm = T)/n, 
             d.2_to_3 = sum (d.2_to_3, na.rm = T)/n, 
             e.3_to_6 = sum (e.3_to_6, na.rm = T)/n, 
             f.6_to_12 = sum (f.6_to_12, na.rm = T)/n, 
             g.12_to_24 = sum (g.12_to_24, na.rm = T)/n, 
             h.more_than_24 = sum (h.more_than_24, na.rm = T)/n)%>%
  pivot_longer (cols = c("a.less_than_0.5", "b.0.5_to_1", "c.1_to_2", "d.2_to_3", "e.3_to_6", "f.6_to_12", "g.12_to_24", "h.more_than_24"), names_to = "ratio", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

my_colors <- RColorBrewer::brewer.pal(9, "Blues")[2:9]
          
 debt_smy %>%
  ggplot(mapping = aes (x =ratio, y = prop*100, fill = ratio)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(ymin = ci_low*100,                        # Error bar 
                    ymax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -0.5, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  xlab ("Debt to Monthly Income Ratio")+
  ylab ("Percentage")+
  scale_fill_manual(values = my_colors)+
  theme_bw()+
  theme(legend.position = "none")+
   facet_wrap (~poverty_3c, ncol = 3)+
   theme(axis.text.x = element_text(angle = 90))
          
```

## 2.2 $ Amount of debt in total and by categories
### 2.2.1 Overall

```{r, echo=FALSE, message = FALSE, warning = FALSE}
library(plyr)
library(dplyr)

debt_amount <- debt %>%
  filter (DEBT.001 == 1)%>%
  select (CaregiverID, race_ethnic, poverty_3c, debt_rent, debt_mortgage, debt_medical, debt_utility, debt_credit_card, debt_student_loan, debt_family_friend_loan, debt_other_bills, debt_total_amount)%>%
  pivot_longer (cols =c("debt_rent", "debt_mortgage", "debt_medical", "debt_utility", "debt_credit_card", "debt_student_loan", "debt_family_friend_loan", "debt_other_bills", "debt_total_amount"), names_to = "debt_type", values_to = "amount")

debt_meds <- ddply(debt_amount, .(debt_type), summarise, med = median(amount, na.rm = T))

debt_meds_total <- debt_meds %>%
  filter (debt_type == "debt_total_amount")

debt_meds_specific <- debt_meds %>%
  filter (debt_type != "debt_total_amount" & debt_type != "debt_student_loan")

debt_meds_loan <- debt_meds %>%
  filter (debt_type == "debt_student_loan")

debt_amount %>%
  filter (debt_type == "debt_total_amount")%>%
  ggplot(mapping = aes (y = amount, x = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA)+ # outlier.shape = NA
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_total, aes(x = debt_type, y = med, label = med), size = 3, vjust = -1)+
  ggtitle ("Total amount of debt")+
  ylim (0, 25000)+
  theme(legend.position = "none")

debt_amount %>%
  filter (debt_type == "debt_student_loan")%>%
  ggplot(mapping = aes (y = amount, x = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA, fill = "gray")+ # outlier.shape = NA
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_loan, aes(x = debt_type, y = med, label = med), size = 3, vjust = -1)+
  ggtitle ("Amount of student loan")+
  ylim (0, 110000)+
  theme(legend.position = "none")

debt_amount %>%
  filter (debt_type != "debt_total_amount" & debt_type != "debt_student_loan" )%>%
  ggplot(mapping = aes (y = amount, x = debt_type, fill = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA)+ # 
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_specific, aes(x = debt_type, y = med, label = med), size = 3, vjust = -8)+
  ylim (0, 18000)+
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle ("Amount of other specific debt")

```

### 2.2.2 By race/ethnicity

```{r, echo=FALSE, message = FALSE, warning = FALSE}

debt_meds <- ddply(debt_amount, .(race_ethnic, debt_type), summarise, med = median(amount, na.rm = T))

debt_meds_total <- debt_meds %>%
  filter (debt_type == "debt_total_amount")

debt_meds_specific <- debt_meds %>%
  filter (debt_type != "debt_total_amount" & debt_type != "debt_student_loan")

debt_meds_loan <- debt_meds %>%
  filter (debt_type == "debt_student_loan")

debt_amount %>%
  filter (debt_type == "debt_total_amount" & race_ethnic != "NA")%>%
  ggplot(mapping = aes (y = amount, x = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA)+ # outlier.shape = NA
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_total, aes(x = debt_type, y = med, label = round(med, 0)), size = 3, vjust = 0, position = position_dodge(1))+
  ggtitle ("Total amount of debt")+
  ylim (0, 25000)+
  theme(legend.position = "none")+
  facet_wrap (~race_ethnic, ncol = 3)

debt_amount %>%
  filter (debt_type == "debt_student_loan")%>%
  ggplot(mapping = aes (y = amount, x = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA, fill = "gray")+ # outlier.shape = NA
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_loan, aes(x = debt_type, y = med, label = med), size = 3, vjust = -1)+
  ggtitle ("Amount of student loan")+
  ylim (0, 110000)+
  theme(legend.position = "none")+
  facet_wrap (~race_ethnic, ncol = 3)

debt_amount %>%
  filter (debt_type != "debt_total_amount" & debt_type != "debt_student_loan" )%>%
  ggplot(mapping = aes (y = amount, x = debt_type, fill = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA)+ # 
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_specific, aes(x = debt_type, y = med, label = round(med, 0)), size = 3, vjust = -6)+
  ylim (0, 18000)+
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle ("Amount of other specific debt")+
  facet_wrap (~race_ethnic, ncol = 3)


```

### 2.2.3 By poverty level (200% & 400% FPL)

```{r, echo=FALSE, message = FALSE, warning = FALSE}

debt_meds <- ddply(debt_amount, .(poverty_3c, debt_type), summarise, med = median(amount, na.rm = T))

debt_meds_total <- debt_meds %>%
  filter (debt_type == "debt_total_amount" & poverty_3c != "NA")

debt_meds_specific <- debt_meds %>%
  filter (debt_type != "debt_total_amount" & debt_type != "debt_student_loan" & poverty_3c != "NA")

debt_meds_loan <- debt_meds %>%
  filter (debt_type == "debt_student_loan" & poverty_3c != "NA")

debt_amount %>%
  filter (debt_type == "debt_total_amount" & poverty_3c != "NA")%>%
  ggplot(mapping = aes (y = amount, x = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA)+ # outlier.shape = NA
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_total, aes(x = debt_type, y = med, label = round(med, 0)), size = 3, vjust = 0, position = position_dodge(1))+
  ggtitle ("Total amount of debt")+
  ylim (0, 25000)+
  theme(legend.position = "none")+
  facet_wrap (~poverty_3c, ncol = 3)

debt_amount %>%
  filter (debt_type == "debt_student_loan" & poverty_3c != "NA")%>%
  ggplot(mapping = aes (y = amount, x = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA, fill = "gray")+ # outlier.shape = NA
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_loan, aes(x = debt_type, y = med, label = med), size = 3, vjust = -1)+
  ggtitle ("Amount of student loan")+
  ylim (0, 110000)+
  theme(legend.position = "none")+
  facet_wrap (~poverty_3c, ncol = 3)

debt_amount %>%
  filter (debt_type != "debt_total_amount" & debt_type != "debt_student_loan" & poverty_3c != "NA" )%>%
  ggplot(mapping = aes (y = amount, x = debt_type, fill = debt_type)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_boxplot (outlier.shape = NA)+ # 
  ylab ("Amount of debt (median presented)")+
  xlab ("")+
  geom_text(data = debt_meds_specific, aes(x = debt_type, y = med, label = round(med, 0)), size = 3, vjust = -6)+
  ylim (0, 18000)+
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle ("Amount of other specific debt")+
  facet_wrap (~poverty_3c, ncol = 3)

detach("package:plyr", unload=TRUE)
```


# 3. Debt compared to pre-COVID
  * Survey question: How does the amount of debt you have now compare to the amount of debt you had in February 2020 (before the pandemic)?\
    + Much lower\
    + Slightly lower\
    + About the same\
    + Slightly higher\
    + Much higher\
  * Note: analyses only done among 303 families who reported having debt\
    
## 3.1 Overall

```{r, echo=FALSE, message = FALSE, warning = FALSE}


debt_smy <- debt %>%
  filter (DEBT.001==1)%>%
  mutate (a.lower = ifelse (DEBT.004 %in% c(1,2), 1, 0), 
          b.same = ifelse (DEBT.004 == 3, 1, 0), 
          c.higher = ifelse (DEBT.004 %in% c(4,5), 1, 0)
          )%>%
  summarise (n = n(), 
             a.lower = sum (a.lower, na.rm = T)/n, 
             b.same = sum (b.same, na.rm = T)/n, 
             c.higher = sum (c.higher, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("a.lower", "b.same", "c.higher"), names_to = "debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy %>%
  ggplot(mapping = aes (y =debt, x = prop*100, fill = debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("Current debt compared to Feburary")+
  xlab ("Percentage")
```

## 3.2 By race/ethnicity

```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt_smy <- debt %>%
  filter (DEBT.001==1 & race_ethnic != "NA")%>%
  group_by (race_ethnic)%>%
  mutate (a.lower = ifelse (DEBT.004 %in% c(1,2), 1, 0), 
          b.same = ifelse (DEBT.004 == 3, 1, 0), 
          c.higher = ifelse (DEBT.004 %in% c(4,5), 1, 0)
          )%>%
  summarise (n = n(), 
             a.lower = sum (a.lower, na.rm = T)/n, 
             b.same = sum (b.same, na.rm = T)/n, 
             c.higher = sum (c.higher, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("a.lower", "b.same", "c.higher"), names_to = "debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy %>%
  ggplot(mapping = aes (y =debt, x = prop*100, fill = debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("Current debt compared to Feburary")+
  xlab ("Percentage")+
  facet_wrap (~race_ethnic, nrow = 3)
```

## 3.3 By poverty level (200% & 400% FPL)

```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt_smy <- debt %>%
  filter (DEBT.001==1 & poverty_3c != "NA")%>%
  group_by (poverty_3c)%>%
  mutate (a.lower = ifelse (DEBT.004 %in% c(1,2), 1, 0), 
          b.same = ifelse (DEBT.004 == 3, 1, 0), 
          c.higher = ifelse (DEBT.004 %in% c(4,5), 1, 0)
          )%>%
  summarise (n = n(), 
             a.lower = sum (a.lower, na.rm = T)/n, 
             b.same = sum (b.same, na.rm = T)/n, 
             c.higher = sum (c.higher, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("a.lower", "b.same", "c.higher"), names_to = "debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy %>%
  ggplot(mapping = aes (y =debt, x = prop*100, fill = debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("Current debt compared to Feburary")+
  xlab ("Percentage")+
  facet_wrap (~poverty_3c, nrow = 3)
```

# 4. How families reduce debt

  * Survey question: Have you used any of the following to reduce your debt in the last month? (select all that apply) \
    + Tax refund\
    + Stimulus payment\
    + Housing assistance\
    + Utility assistance\
    + Employment income\
    + Loans from family or friends\
    + Other\
    + NA\
  * Note: analyses only done among 303 families who reported having debt\
  
## 4.1 Overall

```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt$DEBT.003_8[is.na(debt$DEBT.003_8)] <- 0
debt_smy <- debt %>%
  filter (DEBT.001==1 & DEBT.003_8 == 0)%>%
  summarise (n = n(), 
             tax_refund = sum (DEBT.003_1, na.rm = T)/n, 
             stimulus_payment = sum (DEBT.003_2, na.rm = T)/n, 
             housing_assistance = sum (DEBT.003_3, na.rm = T)/n, 
             utility_assistance = sum (DEBT.003_4, na.rm = T)/n, 
             employment_income = sum (DEBT.003_5, na.rm = T)/n, 
             loans_family_friends = sum (DEBT.003_6, na.rm = T)/n, 
             other = sum (DEBT.003_7, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("tax_refund", "stimulus_payment", "housing_assistance", "utility_assistance", "employment_income", "loans_family_friends", "other", ), names_to = "pay_debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy %>%
  ggplot(mapping = aes (y = reorder(pay_debt, -prop), x = prop*100, fill = pay_debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("How families pay debt")+
  xlab ("Percentage")
```

## 4.2 By race/ethnicity

```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt_smy <- debt %>%
  filter (DEBT.001==1 & DEBT.003_8 == 0 & race_ethnic != "NA")%>%
  group_by(race_ethnic) %>%
  summarise (n = n(), 
             tax_refund = sum (DEBT.003_1, na.rm = T)/n, 
             stimulus_payment = sum (DEBT.003_2, na.rm = T)/n, 
             housing_assistance = sum (DEBT.003_3, na.rm = T)/n, 
             utility_assistance = sum (DEBT.003_4, na.rm = T)/n, 
             employment_income = sum (DEBT.003_5, na.rm = T)/n, 
             loans_family_friends = sum (DEBT.003_6, na.rm = T)/n, 
             other = sum (DEBT.003_7, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("tax_refund", "stimulus_payment", "housing_assistance", "utility_assistance", "employment_income", "loans_family_friends", "other", ), names_to = "pay_debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy %>%
  ggplot(mapping = aes (y = reorder(pay_debt, -prop), x = prop*100, fill = pay_debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("How families pay debt")+
  xlab ("Percentage")+
  facet_wrap (~race_ethnic, nrow = 3)
```

## 4.3 By poverty level (200% & 400%FPL)

```{r, echo=FALSE, message = FALSE, warning = FALSE}
debt_smy <- debt %>%
  filter (DEBT.001==1 & DEBT.003_8 == 0 & poverty_3c != "NA")%>%
  group_by(poverty_3c) %>%
  summarise (n = n(), 
             tax_refund = sum (DEBT.003_1, na.rm = T)/n, 
             stimulus_payment = sum (DEBT.003_2, na.rm = T)/n, 
             housing_assistance = sum (DEBT.003_3, na.rm = T)/n, 
             utility_assistance = sum (DEBT.003_4, na.rm = T)/n, 
             employment_income = sum (DEBT.003_5, na.rm = T)/n, 
             loans_family_friends = sum (DEBT.003_6, na.rm = T)/n, 
             other = sum (DEBT.003_7, na.rm = T)/n
             )%>%
  pivot_longer (cols = c("tax_refund", "stimulus_payment", "housing_assistance", "utility_assistance", "employment_income", "loans_family_friends", "other", ), names_to = "pay_debt", values_to = "prop")%>%
  mutate (count = prop * n, 
          moe = map2_dbl(prop, n, moe.p), 
          ci_low = prop-moe,
          ci_high = prop+moe)

debt_smy %>%
  ggplot(mapping = aes (y = reorder(pay_debt, -prop), x = prop*100, fill = pay_debt)) + # To order y axis by percentage: mapping = aes (y = reorder(XXX, -prop))
  geom_bar (stat = "identity", position = position_dodge(1))+ # stacked bar chart: position = "stack"
  geom_errorbar(aes(xmin = ci_low*100,                        # Error bar 
                    xmax = ci_high*100),
                    width = .3,
                    position = position_dodge(1)) +
  geom_text(aes(label = round(prop*100,2)),vjust = -1, hjust = 0, size = 2.5, color = "black",  position = position_dodge(1))+
  theme(legend.position = "none")+
  ylab ("How families pay debt")+
  xlab ("Percentage")+
  facet_wrap (~poverty_3c, nrow = 3)
```

