---
title: "Social support"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r social-support-1, echo = F}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE)
options(knitr.kable.NA = '')
#re-run all the machine learning models?
rerun = FALSE
dontrerun = !rerun
```

```{r social-support-2  }
library(conflicted)
library(here)
library(ggpubr)
library(knitr)
library(kableExtra)
conflict_prefer("group_rows", "kableExtra")
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
conflict_prefer("map", "purrr")
library(plotly)
```

```{r social-support-3 }
source(here("Scripts/score data.R")) 
```

```{r social-support-4 }
source(here("Functions/pomp.R"))
```

```{r social-support-5, results = 'asis'}
#score well-being
scored = scored %>%
  filter(Week < 18) %>%
  mutate_at(vars(anxiety, depress, stress, lonely, fussy, fear), pomp) %>%
  rowwise() %>%
  mutate(mental_health = mean(c(anxiety, depress, stress, lonely), na.rm=T)) %>%
  ungroup()
```

```{r social-support-6, results = 'asis'}
scored = filter(scored, Week == 15) 
```

```{r social-support-7, results = 'asis'}
scored = scored %>%
  mutate(poverty150 = factor(poverty150, levels = c(0,1), 
                             labels = c("High Income", "Low Income"))) %>%
  mutate(latinx = factor(latinx, levels = c(0,1), 
                             labels = c("Not Latinx", "Latinx"))) %>%
  mutate(race_cat = factor(race_cat))

contrasts(scored$race_cat) = contr.treatment(7)
```


```{r social-support-8, results = 'asis'}
scored = scored %>%
  mutate(current.support = rowMeans(select(., contains("SOCIALSUPP.001")), na.rm=T),
         prior.support = rowMeans(select(., contains("SOCIALSUPP.002")), na.rm=T)) %>%
  mutate(change.support = current.support-prior.support)
```


```{r function wellbeing by categorical predictor}
compare.support = function(outcome, predictor, data = scored, title = NULL){
  
  data = data %>%
    filter(!is.na({{outcome}})) %>%
    filter(!is.na({{predictor}})) %>%
    group_by({{predictor}}) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > 1) 
  
  plotdata = data %>%
    group_by({{predictor}}) %>%
    summarize(m = mean({{outcome}}),
              s = sd({{outcome}}),
              n = n()) %>%
    filter(n > 1) %>%
    mutate(se = s/sqrt(n),
           moe = se*qt(.975, df = n-1)) 
  
  plot = plotdata %>%
    ggplot(aes(x = {{predictor}}, y = m,
               group=1,
               text = paste("\nResponse:", {{predictor}},
                            "\nMental Health:", round(m,2),
                            "\nCount:", n))) +
    geom_bar(stat = "identity", fill = "grey") +
    geom_errorbar(aes(ymin = m-moe, ymax = m+moe), width = .3) +
    coord_flip() +
    labs(y = "Poor Mental Health", x = NULL, title = title) +
    theme_pubclean()

  plot = ggplotly(plot, tooltip = "text")

  data = as.data.frame(data)
  x = data[, deparse(substitute(outcome))]
  g = data[, deparse(substitute(predictor))]
  model = pairwise.t.test(x, g, p.adjust.method = "holm")
  model = broom::tidy(model) %>%
    mutate(p.value = map_chr(p.value, papaja::printp)) %>%
    kable() %>%
    kable_styling(full_width = T)
  
  return.list = list(plot = plot, 
                     summary = model)
  return(return.list)
}
```


```{r function wellbeing by continuous predictor}
wellbeing.con = function(predictor, data = scored, outcome = mental_health, title = NULL){
  
  data = data %>%
    filter(!is.na({{outcome}})) %>%
    filter(!is.na({{predictor}})) 
  
  plot = data %>%
    ggplot(aes(x = {{predictor}}, y = {{outcome}})) +
    geom_jitter(alpha = .3, size = .5)  +
    geom_smooth(method = lm, se = F)  +
    labs(y = "Poor Mental Health", title = title) +
    theme_pubclean()
  
  if(deparse(substitute(predictor)) %in% c("current.support", "prior.support")){
    plot = plot +
    scale_x_continuous("___ of the time", breaks = c(1:5), labels = c("None", "A little", "Some", "A lot", "Most"))
  } else {
    plot = plot +
    scale_x_continuous("", breaks = c(-2,0,2), 
                       labels = c("Lost support", "No change", "Gained support"))
  }
  
  formula = as.formula(paste(deparse(substitute(outcome)), "~", deparse(substitute(predictor))))
  
  model = lm(formula, data) %>%
    broom::tidy() %>%
    mutate(p.value = papaja::printp(p.value)) %>%
    kable(digits = 2) %>%
    kable_styling(full_width = T)
  
  return.list = list(plot = plot, summary = model)
  return(return.list)
}
```

```{r function wellbeing by continuous predictor moderated by categorical groups}
wellbeing.con.group = function(predictor, group, outcome = mental_health, data = scored, title = NULL){
  
  data = data %>%
    filter(!is.na({{outcome}})) %>%
    filter(!is.na({{predictor}})) %>%
    filter(!is.na({{group}}))
  
  plot = data %>%
    ggplot(aes(x = {{predictor}}, y = {{outcome}}, color = {{group}})) +
    geom_jitter(alpha = .3, size = .5)  +
    geom_smooth(method = lm, se = F) +
    scale_x_continuous("___ of the time", breaks = c(1:5), labels = c("None", "A little", "Some", "A lot", "Most")) +
    labs(y = "Poor Mental Health", title = title) +
    theme_pubclean()
  
  formula = as.formula(paste(deparse(substitute(outcome)), "~", deparse(substitute(group)), "*", deparse(substitute(predictor))))
  
  model = lm(formula, data) %>%
    broom::tidy() %>%
    mutate(p.value = papaja::printp(p.value)) %>%
    kable(digits = 2) %>%
    kable_styling(full_width = T)
  
  return.list = list(plot = plot, summary = model)
  return(return.list)
}
```

```{r function support by categorical predictor, eval = F}
support_by_group = function(predictor, timev, data = support, title = NULL){
  
  data = data %>%
    filter(!is.na({{predictor}})) 
  
  if(timev == "change"){
    data = data %>%
      spread(time, support) %>%
      mutate(support = `1`-`2`)
  }
  
  plotdata = data %>%
    group_by({{predictor}}, ) %>%
    summarize(m = mean({{outcome}}),
              s = sd({{outcome}}),
              n = n(),
              se = s/sqrt(n),
              moe = se*qt(.975, df = n-1)) 
  
  plot = plotdata %>%
    ggplot(aes(x = {{predictor}}, y = m,
               group=1,
               text = paste("\nResponse:", {{predictor}},
                            "\nMental Health:", round(m,2),
                            "\nCount:", n))) +
    geom_bar(stat = "identity", fill = "grey") +
    geom_errorbar(aes(ymin = m-moe, ymax = m+moe), width = .3) +
    coord_flip() +
    labs(y = "Poor Mental Health", x = NULL, title = title) +
    theme_pubclean()

  plot = ggplotly(plot, tooltip = "text")

  data = as.data.frame(data)
  x = data[, deparse(substitute(outcome))]
  g = data[, deparse(substitute(predictor))]
  model = pairwise.t.test(x, g, p.adjust.method = "holm")
  model = broom::tidy(model) %>%
    mutate(p.value = papaja::printp(p.value)) %>%
    kable() %>%
    kable_styling(full_width = T)
  
  return.list = list(plot = plot, summary = model)
  return(return.list)
}
```

# Current social support{.tabset}

## Distribution

```{r social-support-9, results = 'asis'}
scored %>%
  ggplot(aes(x = current.support)) +
  geom_density(fill = "grey") +
  scale_x_continuous(
    breaks = c(1:5), 
    labels = c("None", "A little", "Some", "A lot", "Most")) +
  labs(title = "Current levels of support", x = NULL) +
  theme_pubclean()
```

## By Income

```{r social-support-10, results = 'asis'}
mod = compare.support(current.support, poverty150)
mod$plot
```


```{r social-support-11, results = 'asis'}
mod$summary
```

## By Race

```{r social-support-12, results = 'asis'}
mod = compare.support(current.support, race_cat)
mod$plot
```


```{r social-support-13, results = 'asis'}
mod$summary
```

## By Ethnicity

```{r social-support-14, results = 'asis'}
mod = compare.support(current.support, latinx)
mod$plot
```


```{r social-support-15, results = 'asis'}
mod$summary
```


## Caregiver Wellbeing{.tabset}

### Overall

```{r social-support-16, results = 'asis'}
wellbeing.con(current.support)
```

### Income

```{r social-support-17, results = 'asis'}
wellbeing.con.group(predictor = current.support, group = poverty150)
```



### Race

```{r social-support-18, results = 'asis'}
wellbeing.con.group(current.support, race_cat)
```

### Ethnicity

```{r social-support-19, results = 'asis'}
wellbeing.con.group(current.support, latinx)
```


## Child Externalizing{.tabset}

### Overall

```{r social-support-20, results = 'asis'}
wellbeing.con(current.support, outcome = fussy)
```

### Income

```{r social-support-21, results = 'asis'}
wellbeing.con.group(current.support, poverty150, outcome = fussy)
```

### Race

```{r social-support-22, results = 'asis'}
wellbeing.con.group(current.support, race_cat, outcome = fussy)
```

### Ethnicity

```{r social-support-23, results = 'asis'}
wellbeing.con.group(current.support, latinx, outcome = fussy)
```

## Child Internalizing{.tabset}

### Overall

```{r social-support-24, results = 'asis'}
wellbeing.con(current.support, outcome = fear)
```

### Income

```{r social-support-25, results = 'asis'}
wellbeing.con.group(current.support, poverty150, outcome = fear)
```

### Race

```{r social-support-26, results = 'asis'}
wellbeing.con.group(current.support, race_cat, outcome = fear)
```

### Ethnicity

```{r social-support-27, results = 'asis'}
wellbeing.con.group(current.support, latinx, outcome = fear)
```

# Prior social support{.tabset}

## Distribution

```{r social-support-28, results = 'asis'}
scored %>%
  ggplot(aes(x = prior.support)) +
  geom_density(fill = "grey") +
  scale_x_continuous(
    breaks = c(1:5), 
    labels = c("None", "A little", "Some", "A lot", "Most")) +
  labs(title = "Current levels of support", x = NULL) +
  theme_pubclean()
```

## By Income

```{r social-support-29, results = 'asis'}
mod = compare.support(prior.support, poverty150)
mod$plot
```


```{r social-support-30, results = 'asis'}
mod$summary
```

## By Race

```{r social-support-31, results = 'asis'}
mod = compare.support(prior.support, race_cat)
mod$plot
```


```{r social-support-32, results = 'asis'}
mod$summary
```

## By Ethnicity

```{r social-support-33, results = 'asis'}
mod = compare.support(prior.support, latinx)
mod$plot
```


```{r social-support-34, results = 'asis'}
mod$summary
```


## Caregiver Wellbeing{.tabset}

### Overall

```{r social-support-35, results = 'asis'}
wellbeing.con(prior.support)
```

### Income

```{r social-support-36, results = 'asis'}
wellbeing.con.group(prior.support, poverty150)
```

### Race

```{r social-support-37, results = 'asis'}
wellbeing.con.group(prior.support, race_cat)
```

### Ethnicity

```{r social-support-38, results = 'asis'}
wellbeing.con.group(prior.support, latinx)
```

## Child Externalizing{.tabset}

### Overall

```{r social-support-39, results = 'asis'}
wellbeing.con(prior.support, outcome = fussy)
```

### Income

```{r social-support-40, results = 'asis'}
wellbeing.con.group(prior.support, poverty150, outcome = fussy)
```

### Race

```{r social-support-41, results = 'asis'}
wellbeing.con.group(prior.support, race_cat, outcome = fussy)
```

### Ethnicity

```{r social-support-42, results = 'asis'}
wellbeing.con.group(prior.support, latinx, outcome = fussy)
```

## Child Internalizing{.tabset}

### Overall

```{r social-support-43, results = 'asis'}
wellbeing.con(prior.support, outcome = fear)
```

### Income

```{r social-support-44, results = 'asis'}
mod = wellbeing.con.group(prior.support, poverty150, outcome = fear)
mod$plot
```
```{r social-support-45, results = 'asis'}
mod$summary
```

### Race

```{r social-support-46, results = 'asis'}
mod = wellbeing.con.group(prior.support, race_cat, outcome = fear)
mod$plot
```
```{r social-support-47, results = 'asis'}
mod$summary
```

### Ethnicity

```{r social-support-48, results = 'asis'}
mod = wellbeing.con.group(prior.support, latinx, outcome = fear)
mod$plot
```
```{r social-support-49, results = 'asis'}
mod$summary
```

# Change in social support{.tabset}

## Distribution

```{r social-support-50, results = 'asis'}
scored %>%
  ggplot(aes(x = change.support)) +
  geom_density(fill = "grey") +
  geom_vline(aes(xintercept = 0), linetype = "dashed") +
  scale_x_continuous(
    breaks = c(-2,0,2), 
    labels = c("Lost support", "No change", "Gained support")) +
  labs(title = "Current levels of support", x = NULL) +
  theme_pubclean()
```

```{r}
percent.plot = scored %>%
  mutate(change.support = case_when(
    change.support < 0 ~ "Lost",
    change.support > 0 ~ "Gained",
    change.support == 0 ~ "Stayed the same"
  )) %>%
  filter(!is.na(change.support)) %>%
  group_by(change.support) %>%
  summarize(C = n()) %>%
  mutate(Percent = round(C/sum(C)*100,2)) %>%
  ggplot(aes(x = change.support, y = Percent, 
             fill = change.support)) +
  geom_bar(stat = "identity") +
  coord_flip()+
  labs(x = NULL, fill = NULL) +
  guides(fill = F) +
  theme_pubr() 

ggplotly(percent.plot)
  
```


## By Income

```{r social-support-51, results = 'asis'}
mod = compare.support(change.support, poverty150)
mod$plot
```


```{r social-support-52, results = 'asis'}
mod$summary
```

## By Race

```{r social-support-53, results = 'asis'}
mod = compare.support(change.support, race_cat)
mod$plot
```


```{r social-support-54, results = 'asis'}
mod$summary
```

## By Ethnicity

```{r social-support-55, results = 'asis'}
mod = compare.support(change.support, latinx)
mod$plot
```


```{r social-support-56, results = 'asis'}
mod$summary
```

## Caregiver Wellbeing{.tabset}

### Overall

```{r social-support-57, results = 'asis'}
wellbeing.con(change.support)
```

### Income

```{r social-support-58, results = 'asis'}
wellbeing.con.group(change.support, poverty150)
```

### Race

```{r social-support-59, results = 'asis'}
wellbeing.con.group(change.support, race_cat)
```

### Ethnicity

```{r social-support-60, results = 'asis'}
wellbeing.con.group(change.support, latinx)
```

## Child Externalizing{.tabset}

### Overall

```{r social-support-61, results = 'asis'}
wellbeing.con(change.support, outcome = fussy)
```

### Income

```{r social-support-62, results = 'asis'}
wellbeing.con.group(change.support, poverty150, outcome = fussy)
```

### Race

```{r social-support-63, results = 'asis'}
wellbeing.con.group(change.support, race_cat, outcome = fussy)
```

### Ethnicity

```{r social-support-64, results = 'asis'}
wellbeing.con.group(change.support, latinx, outcome = fussy)
```

## Child Internalizing{.tabset}

### Overall

```{r social-support-65, results = 'asis'}
wellbeing.con(change.support, outcome = fear)
```

### Income

```{r social-support-66, results = 'asis'}
wellbeing.con.group(change.support, poverty150, outcome = fear)
```

### Race

```{r social-support-67, results = 'asis'}
wellbeing.con.group(change.support, race_cat, outcome = fear)
```

### Ethnicity

```{r social-support-68, results = 'asis'}
wellbeing.con.group(change.support, latinx, outcome = fear)
```

# Sources of support

_Note that for single caregivers, responses to "partner/spouse" support are removed._

```{r social-support-69}
#dataset of cleaned social support
support = scored %>%
  select(CaregiverID, race_cat, poverty150, latinx, single, contains("SOCIALSUPP.003")) %>%
  gather("key", "value", contains("SOCIALSUPP.003")) %>%
  mutate(key = gsub("SOCIALSUPP\\.003\\.", "", key)) %>%
  separate(key, into = c("source", "time")) %>% 
  spread(source, value) %>%
  mutate(answered = ceiling(rowMeans(select(., matches("^.{1}$")), na.rm=T))) %>%
  filter(!is.nan(answered)) %>%
  mutate_at(vars(matches("^.{1}$")), .funs = function(x) ifelse(is.na(x), 0, 1)) %>%
  gather("source", "support", matches("^.{1}$")) %>%
  filter(source != "l" & source != "m") %>%
  mutate(source = factor(source, 
                         labels = c("Partner/Spouse", "Child", "Parent",
                                    "Other relatives", "Friend", "Neighbor",
                                    "Co-worker", "Religious group", "Spiritual figure", 
                                    "Parent support group", "Health professional"))) %>%
  mutate(support = case_when(
    single == 1 & source == "Partner/Spouse" ~ NA_real_,
    TRUE ~ support
  ))
```


## Current{.tabset}

### Overall

```{r social-support-70}
plot = support %>%
  filter(time == 1) %>%
  filter(!is.na(support)) %>%
  group_by(source) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  ggplot(aes(x = reorder(source, percent), y = percent,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", n))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(x = "", y = "Percent", title = "Source of support in the last week") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```


### Income

```{r social-support-71}
plot = support %>%
  filter(time == 1) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(poverty150)) %>%
  group_by(source, poverty150) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  ungroup() %>%
  mutate(row = row_number(),
         group = cut_interval(row, length = 6)) %>%
  ggplot(aes(x = poverty150, y = percent,
             fill = poverty150,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", support))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~source) +
  scale_fill_brewer(palette = "Set2")+
  guides(fill = F)+
  labs(x = "", y = "Percent", title = "Source of support in the last week") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-72, results = 'asis'}
support %>%
  filter(time == 1) %>%
  filter(!is.na(poverty150)) %>%
  group_by(source) %>%
  nest() %>%
  mutate(ttest = map(data, .f = function(x) t.test(support~poverty150, data = x))) %>%
  select(source, ttest) %>%
  mutate(ttest = map(ttest, broom::tidy)) %>%
  unnest(cols = c(ttest)) %>%
  select(source, estimate, conf.low, conf.high, statistic, p.value) %>%
  ungroup() %>%
  mutate(p.value = p.adjust(p.value, method = "holm"))  %>%
  mutate(p.value = papaja::printp(p.value)) %>%
  kable(., 
        booktabs = T,
        digits = 2,
        col.names = c("Source", "Est", "Lower CI", "Upper CI", "t", "p")) %>%
  kable_styling(full_width = T) %>%
  add_header_above(c(" ", "Difference between groups" = 3, " " = 2))
```


### Race


```{r social-support-73}
plot = support %>%
  filter(time == 1) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(race_cat)) %>%
  group_by(source, race_cat) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  filter(n > 30) %>%
  ungroup() %>%
  mutate(row = row_number(),
         group = cut_interval(row, length = 6)) %>%
  ggplot(aes(x = race_cat, y = percent,
             fill = race_cat,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", support))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~source) +
  scale_fill_brewer(palette = "Set2")+
  guides(fill = F)+
  labs(x = "", y = "Percent", title = "Source of support in the last week") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-74, results = 'asis'}
support %>%
  filter(time == 1) %>%
  filter(race_cat %in% c(
    "Asian",
    "Black/African American",
    "Multiple races", 
    "Other race",
    "White/Caucasian"
  )) %>%
  group_by(source) %>%
  nest() %>%
  mutate(test = map(data, function(x) pairwise.t.test(x$support, x$race_cat, adjust = "none"))) %>%
  mutate(test = map(test, broom::tidy)) %>%
  select(source, test) %>%
  unnest(cols = c(test)) %>%
  ungroup() %>%
  mutate(p.value = p.adjust(p.value, method = "holm"),
         p.value = papaja::printp(p.value)) %>%
  mutate(group1 = str_extract(group1, ".{5}"),
         group2 = str_extract(group2, ".{5}")) %>%
  unite(group, group1, group2, sep = "-") %>%
  spread(group, p.value) %>%
  kable(caption = "p-values from pair-wise t-tests performed within source. All p-values adjusted with Holm correction") %>%
  kable_styling(full_width = T)
   
```

### Ethnicity

```{r social-support-75}
plot = support %>%
  filter(time == 1) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(latinx)) %>%
  group_by(source, latinx) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  ungroup() %>%
  mutate(row = row_number(),
         group = cut_interval(row, length = 6)) %>%
  ggplot(aes(x = latinx, y = percent,
             fill = latinx,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", support))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~source) +
  scale_fill_brewer(palette = "Set2")+
  guides(fill = F)+
  labs(x = "", y = "Percent", title = "Source of support in the last week") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-76, results = 'asis'}
support %>%
  filter(time == 1) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(latinx)) %>%
  group_by(source) %>%
  nest() %>%
  mutate(ttest = map(data, .f = function(x) t.test(support~latinx, data = x))) %>%
  select(source, ttest) %>%
  mutate(ttest = map(ttest, broom::tidy)) %>%
  unnest(cols = c(ttest)) %>%
  select(source, estimate, conf.low, conf.high, statistic, p.value) %>%
  ungroup() %>%
  mutate(p.value = p.adjust(p.value, method = "holm"))  %>%
  mutate(p.value = papaja::printp(p.value)) %>%
  kable(., 
        booktabs = T,
        digits = 2,
        col.names = c("Source", "Est", "Lower CI", "Upper CI", "t", "p")) %>%
  kable_styling(full_width = T) %>%
  add_header_above(c(" ", "Difference between groups" = 3, " " = 2))
```

## Prior{.tabset}

### Overall

```{r social-support-77}
plot = support %>%
  filter(time == 2) %>%
  filter(!is.na(support)) %>%
  group_by(source) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  ggplot(aes(x = reorder(source, percent), y = percent,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", n))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(x = "", y = "Percent", title = "Source of support prior to covid-19") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

### Income

```{r social-support-78}
plot = support %>%
  filter(time == 2) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(poverty150)) %>%
  group_by(source, poverty150) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  ungroup() %>%
  mutate(row = row_number(),
         group = cut_interval(row, length = 6)) %>%
  ggplot(aes(x = poverty150, y = percent,
             fill = poverty150,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", support))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~source) +
  scale_fill_brewer(palette = "Set2")+
  guides(fill = F)+
  labs(x = "", y = "Percent", title = "Source of support prior to covid-19") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-79, results = 'asis'}
support %>%
  filter(time == 2) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(poverty150)) %>%
  group_by(source) %>%
  nest() %>%
  mutate(ttest = map(data, .f = function(x) t.test(support~poverty150, data = x))) %>%
  select(source, ttest) %>%
  mutate(ttest = map(ttest, broom::tidy)) %>%
  unnest(cols = c(ttest)) %>%
  select(source, estimate, conf.low, conf.high, statistic, p.value) %>%
  ungroup() %>%
  mutate(p.value = p.adjust(p.value, method = "holm"))  %>%
  mutate(p.value = papaja::printp(p.value)) %>%
  kable(., 
        booktabs = T,
        digits = 2,
        col.names = c("Source", "Est", "Lower CI", "Upper CI", "t", "p")) %>%
  kable_styling(full_width = T) %>%
  add_header_above(c(" ", "Difference between groups" = 3, " " = 2))
```


### Race


```{r social-support-80}
plot = support %>%
  filter(time == 2) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(race_cat)) %>%
  group_by(source, race_cat) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  filter(n > 30) %>%
  ungroup() %>%
  mutate(row = row_number(),
         group = cut_interval(row, length = 6)) %>%
  ggplot(aes(x = race_cat, y = percent,
             fill = race_cat,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", support))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~source) +
  scale_fill_brewer(palette = "Set2")+
  guides(fill = F)+
  labs(x = "", y = "Percent", title = "Source of support prior to covid-19") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-81, results = 'asis'}
support %>%
  filter(time == 2) %>%
  filter(race_cat %in% c(
    "Asian",
    "Black/African American",
    "Multiple races", 
    "Other race",
    "White/Caucasian"
  )) %>%
  group_by(source) %>%
  nest() %>%
  mutate(test = map(data, function(x) pairwise.t.test(x$support, x$race_cat, adjust = "none"))) %>%
  mutate(test = map(test, broom::tidy)) %>%
  select(source, test) %>%
  unnest(cols = c(test)) %>%
  ungroup() %>%
  mutate(p.value = p.adjust(p.value, method = "holm"),
         p.value = papaja::printp(p.value)) %>%
  mutate(group1 = str_extract(group1, ".{5}"),
         group2 = str_extract(group2, ".{5}")) %>%
  unite(group, group1, group2, sep = "-") %>%
  spread(group, p.value) %>%
  kable(caption = "p-values from pair-wise t-tests performed within source. All p-values adjusted with Holm correction") %>%
  kable_styling(full_width = T)
   
```

### Ethnicity

```{r social-support-82}
plot = support %>%
  filter(time == 2) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(latinx)) %>%
  group_by(source, latinx) %>%
  summarize(n = n(),
            support = sum(support, na.rm=T)) %>%
  mutate(percent = 100*support/n) %>%
  mutate_at(vars(support, percent), round, 2) %>%
  ungroup() %>%
  mutate(row = row_number(),
         group = cut_interval(row, length = 6)) %>%
  ggplot(aes(x = latinx, y = percent,
             fill = latinx,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", support))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~source) +
  scale_fill_brewer(palette = "Set2")+
  guides(fill = F)+
  labs(x = "", y = "Percent", title = "Source of support prior to covid-19") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-83, results = 'asis'}
support %>%
  filter(time == 2) %>%
  filter(!is.na(support)) %>%
  filter(!is.na(latinx)) %>%
  group_by(source) %>%
  nest() %>%
  mutate(ttest = map(data, .f = function(x) t.test(support~latinx, data = x))) %>%
  select(source, ttest) %>%
  mutate(ttest = map(ttest, broom::tidy)) %>%
  unnest(cols = c(ttest)) %>%
  select(source, estimate, conf.low, conf.high, statistic, p.value) %>%
  ungroup() %>%
  mutate(p.value = p.adjust(p.value, method = "holm"))  %>%
  mutate(p.value = papaja::printp(p.value)) %>%
  kable(., 
        booktabs = T,
        digits = 2,
        col.names = c("Source", "Est", "Lower CI", "Upper CI", "t", "p")) %>%
  kable_styling(full_width = T) %>%
  add_header_above(c(" ", "Difference between groups" = 3, " " = 2))
```

## Change{.tabset}

### Overall


```{r social-support-84}
support = support %>%
  spread(time, support) %>%
  mutate(change = case_when(
    `2` == 0 & `1` == 0 ~ "No support, stable",
    `2` == 0 & `1` == 1 ~ "Gained support",
    `2` == 1 & `1` == 0 ~ "Lost support",
    `2` == 1 & `1` == 1 ~ "Support, stable",
    TRUE ~ NA_character_
  ))  

plot = support %>%
  filter(!is.na(support)) %>%
  group_by(source, change) %>%
  summarize(n = n()) %>%
  group_by(source) %>%
  mutate(percent = 100*n/sum(n)) %>%
  mutate_at(vars(percent), round, 2) %>%
  filter(!is.na(change)) %>%
  ggplot(aes(x = reorder(source, percent), y = percent,
             group=1,
               text = paste("\nPercent:", percent,
                            "Count:", n))) +
  geom_bar(stat = "identity") +
  coord_flip() +
  facet_wrap(~change)+
  labs(x = "", y = "Percent", title = "Source of support in the last week") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r}
gainsLosses = support %>%
  filter(!is.na(support)) %>%
  group_by(source, change) %>%
  summarize(n = n()) %>%
  group_by(source) %>%
  mutate(percent = 100*n/sum(n)) %>%
  mutate_at(vars(percent), round, 2) %>%
  filter(!is.na(change)) %>%
  filter(change %in% c("Gained support", "Lost support")) %>%
  mutate(percent = case_when(
    grepl("Lost", change) ~ -1*percent,
    TRUE ~ percent
  )) %>%
  mutate(loss = case_when(
    percent < 0 ~ percent, 
    percent >- 0 ~ 0
  )) %>%
  ggplot(aes(x = reorder(source, -loss),
             y = percent, fill = change)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_y_continuous(breaks = seq(-30,10,10), labels  = abs(seq(-30,10,10))) +
  labs(x = "", y = "Percent") +
  theme_pubr()

ggplotly(gainsLosses)

gainsLosses = support %>%
  filter(!is.na(support)) %>%
  group_by(source, change) %>%
  summarize(n = n()) %>%
  group_by(source) %>%
  mutate(percent = 100*n/sum(n)) %>%
  mutate_at(vars(percent), round, 2) %>%
  filter(!is.na(change)) %>%
  filter(change %in% c("Gained support", "Lost support")) %>%
  write.csv(file = here("figure data/08072020_changeSocialSupport.csv"))
```


### Income

```{r social-support-85}

plot = support %>%
  filter(!is.na(poverty150)) %>%
  group_by(source, change, poverty150) %>%
  summarize(n = n()) %>%
  group_by(source, poverty150) %>%
  mutate(percent = 100*n/sum(n)) %>%
  mutate_at(vars(percent), round, 2) %>%
  filter(!is.na(change)) %>%
  ggplot(aes(x = reorder(source, percent), y = percent,
             fill = poverty150,
               text = paste("Group:", poverty150,
                            "\nPercent:", percent,
                            "Count:", n))) +
  geom_bar(stat = "identity", position = position_dodge(1)) +
  coord_flip() +
  facet_wrap(~change)+
  labs(x = "", y = "Percent", title = "Source of support in the last week") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-86, results = 'asis'}
support %>%
  filter(!is.na(poverty150)) %>%
  group_by(source) %>%
  nest() %>%
  mutate(chisq = map(data, function(x) stats::chisq.test(x = x$change, y = x$poverty150))) %>%
  mutate(chisq = map(chisq, broom::tidy)) %>%
  select(source, chisq) %>%
  unnest(cols = c(chisq)) %>%
  ungroup() %>%
  select(source, statistic, p.value) %>%
  mutate(p.value = p.adjust(p.value, method = "holm"),
         p.value = papaja::printp(p.value)) %>%
  kable(digits = 2, booktabs = T, caption = "Chi-square test by source") %>%
  kable_styling(full_width = T)
```


### Race

```{r social-support-87}

plot = support %>%
  filter(race_cat %in% c(
    "Asian",
    "Black/African American",
    "Multiple races", 
    "Other race",
    "White/Caucasian"
  )) %>%
  group_by(source, change, race_cat) %>%
  summarize(n = n()) %>%
  group_by(source, race_cat) %>%
  mutate(percent = 100*n/sum(n)) %>%
  mutate_at(vars(percent), round, 2) %>%
  filter(!is.na(change)) %>%
  mutate(totaln = sum(n)) %>%
  filter(totaln > 30) %>%
  mutate(source.num = as.numeric(source)) %>%
  ggplot(aes(x = source.num, y = percent,
             fill = race_cat,
             group = race_cat,
               text = paste("Group:", race_cat,
                            "\nSupport:", source,
                            "\nPercent:", percent,
                            "\nCount:", n))) +
  geom_point()+
  geom_line(alpha = .3)+
  #coord_flip() +
  facet_wrap(~change, scales = "free_y")+
  scale_x_continuous(breaks = c(1:11), labels = levels(support$source)) +
  labs(x = "", y = "Percent", title = "Source of support in the last week",
       caption = "Summary statistics removed if fewer than 10 responses") +
  theme_pubclean() +
  theme(axis.text.x = element_text(angle = 90))

ggplotly(plot, tooltip = "text")
```

```{r social-support-88, results = 'asis'}
support %>%
  filter(!is.na(poverty150)) %>%
  group_by(source) %>%
  nest() %>%
  mutate(chisq = map(data, function(x) stats::chisq.test(x = x$change, y = x$poverty150))) %>%
  mutate(chisq = map(chisq, broom::tidy)) %>%
  select(source, chisq) %>%
  unnest(cols = c(chisq)) %>%
  ungroup() %>%
  select(source, statistic, p.value) %>%
  mutate(p.value = p.adjust(p.value, method = "holm"),
         p.value = papaja::printp(p.value)) %>%
  kable(digits = 2, booktabs = T, caption = "Chi-square test by source") %>%
  kable_styling(full_width = T)
```

### Ethnicity

```{r social-support-89}

plot = support %>%
  filter(!is.na(latinx)) %>%
  group_by(source, change, latinx) %>%
  summarize(n = n()) %>%
  group_by(source, latinx) %>%
  mutate(percent = 100*n/sum(n)) %>%
  mutate_at(vars(percent), round, 2) %>%
  filter(!is.na(change)) %>%
  ggplot(aes(x = reorder(source, percent), y = percent,
             fill = latinx,
               text = paste("Group:", latinx,
                            "\nPercent:", percent,
                            "Count:", n))) +
  geom_bar(stat = "identity", position = position_dodge(1)) +
  coord_flip() +
  facet_wrap(~change)+
  labs(x = "", y = "Percent", title = "Source of support in the last week") +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

```{r social-support-90, results = 'asis'}
support %>%
  filter(!is.na(latinx)) %>%
  group_by(source) %>%
  nest() %>%
  mutate(chisq = map(data, function(x) stats::chisq.test(x = x$change, y = x$latinx))) %>%
  mutate(chisq = map(chisq, broom::tidy)) %>%
  select(source, chisq) %>%
  unnest(cols = c(chisq)) %>%
  ungroup() %>%
  select(source, statistic, p.value) %>%
  mutate(p.value = p.adjust(p.value, method = "holm"),
         p.value = papaja::printp(p.value)) %>%
  kable(digits = 2, booktabs = T, caption = "Chi-square test by source") %>%
  kable_styling(full_width = T)
```
