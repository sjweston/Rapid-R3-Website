---
title: "Charting the curve"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r spline-final-1, echo = F}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = TRUE)
options(knitr.kable.NA = '')
#re-run all the machine learning models?
rerun = FALSE
dontrerun = !rerun
```

```{r spline-final-2 }
library(conflicted)
library(here)
library(ggpubr)
#library(tidymodels)
library(brolgar)
library(lme4)
#library(modelr)
library(caret)
library(knitr)
library(kableExtra)
conflict_prefer("group_rows", "kableExtra")
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
conflict_prefer("map", "purrr")
library(plotly)
library(sjPlot)
```

```{r spline-final-3 }
if(rerun) options(mc.cores = parallel::detectCores())
```


```{r spline-final-4 }
source(here("Scripts/score data.R")) 
```

```{r spline-final-5 }
source(here("Functions/pomp.R"))
source(here("Functions/splines.R"))
```

```{r spline-final-6}
#pomp scoring
scored = scored %>%
  mutate_at(vars(anxiety, depress, stress, lonely, fussy, fear), pomp)
```


```{r spline-final-7 }
#Center emotion variables on caregiver baseline (Week 0)
# identify "baseline" values
baseline = scored %>%
  filter(Week == 0) %>% # only Week 0
  select(CaregiverID, anxiety, depress, stress, lonely, fussy, fear) #only these variables
names(baseline)[-1] = paste(names(baseline)[-1], "pre", sep = "_")  # rename

emotion = scored %>%
  group_by(CaregiverID) %>%
  mutate(conflict_total = max(conflict_total,na.rm = T),
         conflict_parent = max(conflict_parent,na.rm = T),
         conflict_child = max(conflict_child,na.rm = T)) %>%
  ungroup() %>%
  select(CaregiverID, Week, anxiety, depress, stress, lonely, 
         fussy, fear, 
         lost_free_lunch, contains("conflict_")) %>% #only these variables
  filter(Week > 0 & Week <= 10) %>% # remove week 0 and any week after 10
  full_join(baseline) %>% # join with baseline data -- creates columns of "pre" variables
  gather(key, value, -CaregiverID, -Week) %>% 
  mutate(time = ifelse(grepl("_pre", key), "Pre", "Now"),
         key = gsub("_pre","",key)) %>%
  spread(time, value) %>% #now one row per emotion per week per caregiver
  #mutate(value = Now-Pre) %>% # subtract
  mutate(value = Now) %>% # subtract
  select(-Now, -Pre) %>% # remove extra variables
  spread(key, value) # now one row per week per caregiver
```

```{r spline-final-8 }
groups = scored %>%
  group_by(CaregiverID) %>%
  filter(Week == min(Week)) %>%
  ungroup() %>%
  mutate(child2 = ifelse(num_children_raw >= 2, 1, 0),
         child3 = ifelse(num_children_raw >= 3, 1, 0)) %>%
  select(CaregiverID, black, poverty150, single, latinx, disability,
         child2, child3) %>%
  mutate_at(vars(-CaregiverID),
            .funs = function(x) 1-x) %>%
  mutate_at(vars(-CaregiverID), factor)

emotion_g = full_join(emotion, groups)

contrasts(emotion_g$black) = contr.sum(2)
contrasts(emotion_g$poverty150) = contr.sum(2)
contrasts(emotion_g$single) = contr.sum(2)
contrasts(emotion_g$latinx) = contr.sum(2)
contrasts(emotion_g$child2) = contr.sum(2)
contrasts(emotion_g$child3) = contr.sum(2)
```

```{r spline-final-9}
# potential mediators
meds = c("insurance", 
         "child_insurance", 
         "support_decrease", 
         "lost_free_lunch", 
         "employment_decreased", 
         "losejob_sickleave", 
         "income_decreaed", 
         "difficulty_basics")

black_meds = c("support_decrease", 
               "employment_decreased", 
               "losejob_sickleave", 
               "difficulty_basics")

disability_meds = c( 
                 "employment_decreased", 
                 "losejob_sickleave", 
                 "difficulty_basics")

emotion_g = scored %>%
  select(CaregiverID, Week, all_of(meds)) %>%
  right_join(emotion_g)
```


# Representativeness disclaimer

```{r spline-final-10 }
n_care = length(unique(emotion$CaregiverID))
date.min = format(min(as.Date(scored$Date), na.rm = T), format = "%B %d, %Y")
date.max = format(max(as.Date(scored$Date), na.rm = T), format = "%B %d, %Y")
perc = scored %>%
  group_by(CaregiverID) %>%
  filter(Week == max(Week))
perc.black = 100*sum(perc$black, na.rm=T)/nrow(perc)
perc.latinx = 100*sum(perc$latinx, na.rm=T)/nrow(perc)
perc.fpl = 100*sum(perc$poverty150, na.rm=T)/nrow(perc)
```

These analyses are based on responses collected from `r papaja::printnum(n_care, format = "d")` caregivers between the dates of `r date.min` and `r date.max`. These caregivers represent a range of voices: `r papaja::printnum(perc.black)`\% are Black/African American, `r papaja::printnum(perc.latinx)`\% are LatinX, and `r papaja::printnum(perc.fpl)`\% live at or below 1.5 times the federal poverty line. Proportions/percentages are calculated based on the item-level response rates, not out of the total sample size. The data for these analyses are *not* weighted.

# Information about mediators

Black families are less likely to report that the feel they have less support during COVID, and more likely to report that their employment has decreased, that they're worried they might lose their jobs if they take sick leave, and that they have difficulty paying for basics. 

Caregivers of children with disabilities are more likley to report that their employment has decreased, that they're worried they might lose their jobs if they take sick leave, and that they have difficulty paying for basics.

# Descriptives

```{r spline-final-11 }
emotion_g %>%
  select_if(is.numeric) %>%
  psych::describeBy(group = emotion_g$Week, fast = T) 
```


# Spline models

Spline models are fit with nodes at Week 6; Week 7 is the week ending on May 25th, 2020.


## Anxiety{.tabset}

### Overall

```{r spline-final-12 }
fit = splines.overall(emotion_g, anxiety, 6)
fit$plot
```

```{r spline-final-13, results = 'asis'}
fit$summary
```

```{r spline-final-14}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0629_overall_anxiety.csv"))
#dots
fit$plotdata %>%
  select(Week, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0629_overall_anxiety_dots.csv"))
```

### Black/African American

```{r spline-final-15 }
fit = splines.groups(emotion_g, anxiety, black, 6)
fit$plot
```

```{r spline-final-16, results = 'asis'}
fit$summary
```

#### Can we explain this difference?

```{r spline-final-17, results = 'asis'}
emotion_g %>%
  gather("mediator", "m.value", all_of(black_meds)) %>%
  group_by(mediator) %>%
  nest() %>%
  mutate(model = map(data, 
                     .f = function(x) splines.mediation(
                       x, 
                       anxiety, 
                       black, 
                       m.value, 
                       6))) %>%
  select(mediator, model) %>%
  mutate(model = map(model, "change")) %>%
  unnest(cols = c(model)) %>%
  spread(statistic, value) %>%
  kable(., digits = c(0, 2,2,2,2,3,3,2,2)) %>%
  kable_styling(full_width = T)

```

```{r spline-final-18}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, black, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(black = ifelse(black == 0, "Black/African American", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_black_anxiety.csv"))
#dots
fit$plotdata %>%
  select(Week, black, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(black = ifelse(black == 0, "Black/African American", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_black_anxiety_dots.csv"))
```


### LatinX

```{r spline-final-19 }
fit = splines.groups(emotion_g, anxiety, latinx, 6)
fit$plot
```

```{r spline-final-20, results = 'asis'}
fit$summary
```

### Poverty

```{r spline-final-21 }
fit = splines.groups(emotion_g, anxiety, poverty150, 6)
fit$plot
```

```{r spline-final-22, results = 'asis'}
fit$summary
```

```{r spline-final-23}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, poverty150, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(poverty150 = ifelse(poverty150 == 0, "Low Income", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_lowincome_anxiety.csv"))
#dots
fit$plotdata %>%
  select(Week, poverty150, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(poverty150 = ifelse(poverty150 == 0, "Low Income", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_lowincome_anxiety_dots.csv"))
```

### Single Parents

```{r spline-final-24 }
fit = splines.groups(emotion_g, anxiety, single, 6)
fit$plot
```

```{r spline-final-25, results = 'asis'}
fit$summary
```

### Children with disabilites

```{r spline-final-26 }
fit = splines.groups(emotion_g, anxiety, disability, 6)
fit$plot
```

```{r spline-final-27, results = 'asis'}
fit$summary
```

#### Can we explain this difference?

```{r spline-final-28, results = 'asis'}
emotion_g %>%
  gather("mediator", "m.value", all_of(disability_meds)) %>%
  group_by(mediator) %>%
  nest() %>%
  mutate(model = map(data, 
                     .f = function(x) splines.mediation(
                       x, 
                       anxiety, 
                       disability, 
                       m.value, 
                       6))) %>%
  select(mediator, model) %>%
  mutate(model = map(model, "change")) %>%
  unnest(cols = c(model)) %>%
  spread(statistic, value) %>%
  kable(., digits = c(0, 2,2,2,2,3,3,2,2)) %>%
  kable_styling(full_width = T)

```

```{r spline-final-29}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, disability, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_anxiety.csv"))
#dots
fit$plotdata %>%
  select(Week, disability, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_anxiety_dots.csv"))
```

### 3+ Children

```{r spline-final-30 }
fit = splines.groups(emotion_g, anxiety, child3, 6)
fit$plot
```

```{r spline-final-31, results = 'asis'}
fit$summary
```

## Depression{.tabset}

### Overall

```{r spline-final-32 }
fit = splines.overall(emotion_g, depress, 6)
fit$plot
```

```{r spline-final-33, results = 'asis'}
fit$summary
```

```{r spline-final-34}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0629_overall_depress.csv"))
#dots
fit$plotdata %>%
  select(Week, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0629_overall_depress_dots.csv"))
```

### Black/African American

```{r spline-final-35 }
fit = splines.groups(emotion_g, depress, black, 6)
fit$plot
```

```{r spline-final-36, results = 'asis'}
fit$summary
```

#### Can we explain this difference?

```{r spline-final-37, results = 'asis'}
emotion_g %>%
  gather("mediator", "m.value", all_of(black_meds)) %>%
  group_by(mediator) %>%
  nest() %>%
  mutate(model = map(data, 
                     .f = function(x) splines.mediation(
                       x, 
                       depress, 
                       black, 
                       m.value, 
                       6))) %>%
  select(mediator, model) %>%
  mutate(model = map(model, "change")) %>%
  unnest(cols = c(model)) %>%
  spread(statistic, value) %>%
  kable(., digits = c(0, 2,2,2,2,3,3,2,2)) %>%
  kable_styling(full_width = T)

```

### LatinX

```{r spline-final-38 }
fit = splines.groups(emotion_g, depress, latinx, 6)
fit$plot
```

```{r spline-final-39, results = 'asis'}
fit$summary
```

### Poverty

```{r spline-final-40 }
fit = splines.groups(emotion_g, depress, poverty150, 6)
fit$plot
```

```{r spline-final-41, results = 'asis'}
fit$summary
```

```{r spline-final-42}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, poverty150, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(poverty150 = ifelse(poverty150 == 0, "Low Income", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_lowincome_depress.csv"))
#dots
fit$plotdata %>%
  select(Week, poverty150, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(poverty150 = ifelse(poverty150 == 0, "Low Income", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_lowincome_depress_dots.csv"))
```

### Single Parents

```{r spline-final-43 }
fit = splines.groups(emotion_g, depress, single, 6)
fit$plot
```

```{r spline-final-44, results = 'asis'}
fit$summary
```

### Children with disabilites

```{r spline-final-45 }
fit = splines.groups(emotion_g, depress, disability, 6)
fit$plot
```

```{r spline-final-46, results = 'asis'}
fit$summary
```

#### Can we explain this difference?

```{r spline-final-47, results = 'asis'}
emotion_g %>%
  gather("mediator", "m.value", all_of(disability_meds)) %>%
  group_by(mediator) %>%
  nest() %>%
  mutate(model = map(data, 
                     .f = function(x) splines.mediation(
                       x, 
                       depress, 
                       disability, 
                       m.value, 
                       6))) %>%
  select(mediator, model) %>%
   mutate(model = map(model, "change")) %>%
 unnest(cols = c(model)) %>%
  spread(statistic, value) %>%
  kable(., digits = c(0, 2,2,2,2,3,3,2,2)) %>%
  kable_styling(full_width = T)

```

```{r spline-final-48}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, disability, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_depress.csv"))
#dots
fit$plotdata %>%
  select(Week, disability, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_depress_dots.csv"))
```


### 3+ Children

```{r spline-final-49 }
fit = splines.groups(emotion_g, depress, child3, 6)
fit$plot
```

```{r spline-final-50, results = 'asis'}
fit$summary
```

```{r spline-final-51}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, child3, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(child3 = ifelse(child3 == 0, "3+ Children", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_child3_anxiety.csv"))
#dots
fit$plotdata %>%
  select(Week, child3, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(child3 = ifelse(child3 == 0, "3+ Children", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_child3_anxiety_dots.csv"))
```

## Stress{.tabset}

### Overall

```{r spline-final-52 }
fit = splines.overall(emotion_g, stress, 6)
fit$plot
```

```{r spline-final-53, results = 'asis'}
fit$summary
```

```{r spline-final-54}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0629_overall_stress.csv"))
#dots
fit$plotdata %>%
  select(Week, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0629_overall_stress_dots.csv"))
```

### Black/African American

```{r spline-final-55 }
fit = splines.groups(emotion_g, stress, black, 6)
fit$plot
```

```{r spline-final-56, results = 'asis'}
fit$summary
```

```{r spline-final-57}
group.diff(emotion_g, stress, black, 1)
```

```{r spline-final-58}
group.diff(emotion_g, stress, black, 10)
```

#### Can we explain this difference?

```{r spline-final-59, results = 'asis'}
emotion_g %>%
  gather("mediator", "m.value", all_of(black_meds)) %>%
  group_by(mediator) %>%
  nest() %>%
  mutate(model = map(data, 
                     .f = function(x) splines.mediation(
                       x, 
                       stress,
                       black, 
                       m.value, 
                       6))) %>%
  select(mediator, model) %>%
  mutate(model = map(model, "change")) %>%
  unnest(cols = c(model)) %>%
  spread(statistic, value) %>%
  kable(., digits = c(0, 2,2,2,2,3,3,2,2)) %>%
  kable_styling(full_width = T)

```

```{r spline-final-60}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, black, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(black = ifelse(black == 0, "Black/African American", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_black_stress.csv"))
#dots
fit$plotdata %>%
  select(Week, black, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(black = ifelse(black == 0, "Black/African American", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_black_stress_dots.csv"))
```

### LatinX

```{r spline-final-61 }
fit = splines.groups(emotion_g, stress, latinx, 6)
fit$plot
```

```{r spline-final-62, results = 'asis'}
fit$summary
```

```{r spline-final-63}
group.diff(emotion_g, stress, latinx, 1)
```

```{r spline-final-64}
group.diff(emotion_g, stress, latinx, 10)
```

### Poverty

```{r spline-final-65 }
fit = splines.groups(emotion_g, stress, poverty150, 6)
fit$plot
```

```{r spline-final-66, results = 'asis'}
fit$summary
```

```{r spline-final-67}
group.diff(emotion_g, stress, poverty150, 1)
```

```{r spline-final-68}
group.diff(emotion_g, stress, poverty150, 10)
```



### Single Parents

```{r spline-final-69 }
fit = splines.groups(emotion_g, stress, single, 6)
fit$plot
```

```{r spline-final-70, results = 'asis'}
fit$summary
```

```{r spline-final-71}
group.diff(emotion_g, stress, single, 1)
```

```{r spline-final-72}
group.diff(emotion_g, stress, single, 10)
```


### Children with disabilites

```{r spline-final-73 }
fit = splines.groups(emotion_g, stress, disability, 6)
fit$plot
```

```{r spline-final-74, results = 'asis'}
fit$summary
```

```{r spline-final-75}
group.diff(emotion_g, stress, disability, 1)
```

```{r spline-final-76}
group.diff(emotion_g, stress, disability, 10)
```

```{r spline-final-77}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, disability, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_stress.csv"))
#dots
fit$plotdata %>%
  select(Week, disability, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_stress_dots.csv"))
```

### 3+ Children

```{r spline-final-78 }
fit = splines.groups(emotion_g, stress, child3, 6)
fit$plot
```

```{r spline-final-79, results = 'asis'}
fit$summary
```

```{r spline-final-80}
group.diff(emotion_g, stress, child3, 1)
```

```{r spline-final-81}
group.diff(emotion_g, stress, child3, 10)
```

```{r spline-final-82}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, child3, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(child3 = ifelse(child3 == 0, "3+ Children", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_child3_stress.csv"))
#dots
fit$plotdata %>%
  select(Week, child3, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(child3 = ifelse(child3 == 0, "3+ Children", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_child3_stress_dots.csv"))
```


## Loneliness{.tabset}

### Overall

```{r spline-final-83 }
fit = splines.overall(emotion_g, lonely, 6)
fit$plot
```

```{r spline-final-84, results = 'asis'}
fit$summary
```

```{r spline-final-85}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0629_overall_lonely.csv"))
#dots
fit$plotdata %>%
  select(Week, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0629_overall_lonely_dots.csv"))
```

### Black/African American

```{r spline-final-86 }
fit = splines.groups(emotion_g, lonely, black, 6)
fit$plot
```

```{r spline-final-87, results = 'asis'}
fit$summary
```

### LatinX

```{r spline-final-88 }
fit = splines.groups(emotion_g, lonely, latinx, 6)
fit$plot
```

```{r spline-final-89, results = 'asis'}
fit$summary
```

### Poverty

```{r spline-final-90 }
fit = splines.groups(emotion_g, lonely, poverty150, 6)
fit$plot
```

```{r spline-final-91, results = 'asis'}
fit$summary
```

### Single Parents

```{r spline-final-92 }
fit = splines.groups(emotion_g, lonely, single, 6)
fit$plot
```

```{r spline-final-93, results = 'asis'}
fit$summary
```

### Children with disabilites

```{r spline-final-94 }
fit = splines.groups(emotion_g, lonely, disability, 6)
fit$plot
```

```{r spline-final-95, results = 'asis'}
fit$summary
```

#### Can we explain this difference?

```{r spline-final-96, results = 'asis'}
emotion_g %>%
  gather("mediator", "m.value", all_of(disability_meds)) %>%
  group_by(mediator) %>%
  nest() %>%
  mutate(model = map(data, 
                     .f = function(x) splines.mediation(
                       x, 
                       lonely, 
                       disability, 
                       m.value, 
                       6))) %>%
  select(mediator, model) %>%
  mutate(model = map(model, "change")) %>%
  unnest(cols = c(model)) %>%
  spread(statistic, value) %>%
  kable(., digits = c(0, 2,2,2,2,3,3,2,2)) %>%
  kable_styling(full_width = T)

```

```{r spline-final-97}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, disability, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_lonely.csv"))
#dots
fit$plotdata %>%
  select(Week, disability, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  mutate(disability = ifelse(disability == 0, "Caregivers of children with disabilities", "Entire Sample")) %>%
  write.csv(., file = here("figure data/0629_disability_lonely_dots.csv"))
```
### 3+ Children

```{r spline-final-98 }
fit = splines.groups(emotion_g, lonely, child3, 6)
fit$plot
```

```{r spline-final-99, results = 'asis'}
fit$summary
```

## Child Externalizing{.tabset}

### Overall

```{r spline-final-100 }
fit = splines.overall(emotion_g, fussy, 6)
fit$plot
```

```{r spline-final-101, results = 'asis'}
fit$summary
```

```{r spline-final-102}
fit$pdata %>%
  select(Week, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0623_overall_Ext.csv"))
#dots
fit$plotdata %>%
  select(Week, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0623_overall_Ext_dots.csv"))
```


### Black/African American

```{r spline-final-103 }
fit = splines.groups(emotion_g, fussy, black, 6)
fit$plot
```

```{r spline-final-104, results = 'asis'}
fit$summary
```

```{r spline-final-105}
group.diff(emotion_g, fussy, black, 1)
```

```{r spline-final-106}
group.diff(emotion_g, fussy, black, 10)
```

```{r spline-final-107}
# are group differences due to caregiver stress?
emotion_g_sL = emotion_g %>%
  mutate(SL1 = ifelse(Week <= 6, Week-6, 0),
           SL2 = ifelse(Week > 6, Week-6, 0))

mod.ext.black = lmer(fussy ~ black*SL1 + black*SL2 + 
                       stress*SL1 + stress*SL2 + (1|CaregiverID),
                     data = emotion_g_sL)

summary(mod.ext.black)
```

```{r spline-final-108}
# export data for soapbox
#lines
fit$pdata %>%
  select(Week, black, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0623_black_Ext.csv"))
#dots
fit$plotdata %>%
  select(Week, black, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0623_black_Ext_dots.csv"))
```


### LatinX

```{r spline-final-109 }
fit = splines.groups(emotion_g, fussy, latinx, 6)
fit$plot
```

```{r spline-final-110, results = 'asis'}
fit$summary
```


```{r spline-final-111}
group.diff(emotion_g, fussy, latinx, 1)
```

```{r spline-final-112}
group.diff(emotion_g, fussy, latinx, 10)
```

### Poverty

```{r spline-final-113 }
fit = splines.groups(emotion_g, fussy, poverty150, 6)
fit$plot
```

```{r spline-final-114, results = 'asis'}
fit$summary
```


```{r spline-final-115}
group.diff(emotion_g, fussy, poverty150, 1)
```

```{r spline-final-116}
group.diff(emotion_g, fussy, poverty150, 10)
```

```{r spline-final-117}
# are group differences due to caregiver stress?
mod.ext.poverty150 = lmer(fussy ~ poverty150*SL1 + poverty150*SL2 + 
                       stress*SL1 + stress*SL2 + (1|CaregiverID),
                     data = emotion_g_sL)

summary(mod.ext.poverty150)
```

```{r spline-final-118}
fit$pdata %>%
  select(Week, poverty150, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0623_lowIncome_Ext.csv"))
#dots
fit$plotdata %>%
  select(Week, poverty150, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0623_lowIncome_Ext_dots.csv"))
```

### Single Parents

```{r spline-final-119 }
fit = splines.groups(emotion_g, fussy, single, 6)
fit$plot
```

```{r spline-final-120, results = 'asis'}
fit$summary
```


```{r spline-final-121}
group.diff(emotion_g, fussy, single, 1)
```

```{r spline-final-122}
group.diff(emotion_g, fussy, single, 10)
```

```{r spline-final-123}
# are group differences due to caregiver stress?
mod.ext.single = lmer(fussy ~ single*SL1 + single*SL2 + 
                       stress*SL1 + stress*SL2 + (1|CaregiverID),
                     data = emotion_g_sL)

summary(mod.ext.single)
```

```{r spline-final-124}
fit$pdata %>%
  select(Week, single, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0623_single_Ext.csv"))
#dots
fit$plotdata %>%
  select(Week, single, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0623_single_Ext_dots.csv"))
```


### Children with disabilites

```{r spline-final-125 }
fit = splines.groups(emotion_g, fussy, disability, 6)
fit$plot
```

```{r spline-final-126, results = 'asis'}
fit$summary
```

```{r spline-final-127}
group.diff(emotion_g, fussy, disability, 1)
```

```{r spline-final-128}
group.diff(emotion_g, fussy, disability, 10)
```
### 3+ Children

```{r spline-final-129 }
fit = splines.groups(emotion_g, fussy, child3, 6)
fit$plot
```

```{r spline-final-130, results = 'asis'}
fit$summary
```

```{r spline-final-131}
group.diff(emotion_g, fussy, child3, 1)
```

```{r spline-final-132}
group.diff(emotion_g, fussy, child3, 10)
```
## Child Internalizing{.tabset}

### Overall

```{r spline-final-133 }
fit = splines.overall(emotion_g, fear, 6)
fit$plot
```

```{r spline-final-134, results = 'asis'}
fit$summary
```

```{r spline-final-135}
fit$pdata %>%
  select(Week, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0623_overall_Int.csv"))
#dots
fit$plotdata %>%
  select(Week, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0623_overall_Int_dots.csv"))
```

### Black/African American

```{r spline-final-136 }
fit = splines.groups(emotion_g, fear, black, 6)
fit$plot
```

```{r spline-final-137, results = 'asis'}
fit$summary
```

```{r spline-final-138}
group.diff(emotion_g, fear, black, 1)
```

```{r spline-final-139}
group.diff(emotion_g, fear, black, 10)
```

### LatinX

```{r spline-final-140 }
fit = splines.groups(emotion_g, fear, latinx, 6)
fit$plot
```

```{r spline-final-141, results = 'asis'}
fit$summary
```

```{r spline-final-142}
group.diff(emotion_g, fear, latinx, 1)
```

```{r spline-final-143}
group.diff(emotion_g, fear, latinx, 10)
```

### Poverty

```{r spline-final-144 }
fit = splines.groups(emotion_g, fear, poverty150, 6)
fit$plot
```

```{r spline-final-145, results = 'asis'}
fit$summary
```


```{r spline-final-146}
group.diff(emotion_g, fear, poverty150, 1)
```

```{r spline-final-147}
group.diff(emotion_g, fear, poverty150, 10)
```

```{r spline-final-148}
fit$pdata %>%
  select(Week, poverty150, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0623_lowIncome_Int.csv"))
#dots
fit$plotdata %>%
  select(Week, poverty150, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0623_lowIncome_Int_dots.csv"))
```


### Single Parents

```{r spline-final-149 }
fit = splines.groups(emotion_g, fear, single, 6)
fit$plot
```

```{r spline-final-150, results = 'asis'}
fit$summary
```


```{r spline-final-151}
group.diff(emotion_g, fear, single, 1)
```

```{r spline-final-152}
group.diff(emotion_g, fear, single, 10)
```

### Children with disabilites

```{r spline-final-153 }
fit = splines.groups(emotion_g, fear, disability, 6)
fit$plot
```

```{r spline-final-154, results = 'asis'}
fit$summary
```


```{r spline-final-155}
group.diff(emotion_g, fear, disability, 1)
```

```{r spline-final-156}
group.diff(emotion_g, fear, disability, 10)
```

```{r spline-final-157}
# are group differences due to caregiver stress?
mod.int.disability = lmer(fear ~ disability*SL1 + disability*SL2 + 
                       stress*SL1 + stress*SL2 + (1|CaregiverID),
                     data = emotion_g_sL)

summary(mod.int.disability)
```

```{r spline-final-158}
fit$pdata %>%
  select(Week, disability, fit) %>%
  mutate(fit = round(fit,2)) %>%
  rename(problems = fit) %>%
  write.csv(., file = here("figure data/0623_disability_Int.csv"))
#dots
fit$plotdata %>%
  select(Week, disability, m) %>%
  mutate(m = round(m,2)) %>%
  rename(problems = m) %>%
  write.csv(., file = here("figure data/0623_disability_Int_dots.csv"))
```

### 3+ Children

```{r spline-final-159 }
fit = splines.groups(emotion_g, fear, child3, 6)
fit$plot
```

```{r spline-final-160, results = 'asis'}
fit$summary
```


```{r spline-final-161}
group.diff(emotion_g, fear, child3, 1)
```

```{r spline-final-162}
group.diff(emotion_g, fear, child3, 10)
```

# Comparing change

## No modeling{.tabset}

### Overall

```{r spline-final-163}
emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  ggplot(aes(x = Week)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)", breaks = c(-2:3)) +
  theme_pubclean()
  
```

### Black/African American

```{r spline-final-164}
emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  mutate(black = factor(black, labels = c("Black", "Everyone else"))) %>%
  ggplot(aes(x = Week, group = black)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)") +
  facet_wrap(~black, ncol = 1) +
  theme_pubclean()
  
```

### Latinx

```{r spline-final-165}
emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  mutate(latinx = factor(latinx, labels = c("Latinx", "Everyone else"))) %>%
  filter(!is.na(latinx)) %>%
  ggplot(aes(x = Week, group = latinx)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)") +
  facet_wrap(~latinx, ncol = 1) +
  theme_pubclean()
  
```

### Poverty

```{r spline-final-166}
emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  mutate(poverty150 = factor(poverty150, labels = c("Low Income", "Everyone else"))) %>%
  filter(!is.na(poverty150)) %>%
  ggplot(aes(x = Week, group = poverty150)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)") +
  facet_wrap(~poverty150, ncol = 1) +
  theme_pubclean()
  
```


### Single Parents

```{r spline-final-167}
emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  mutate(single = factor(single, labels = c("Single Caregivers", "Everyone else"))) %>%
  filter(!is.na(single)) %>%
  ggplot(aes(x = Week, group = single)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)") +
  facet_wrap(~single, ncol = 1) +
  theme_pubclean()
  
```


### Children with disabilites

```{r spline-final-168}
emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  mutate(disability = factor(disability, labels = c("Chidlren with Disabilites", "Everyone else"))) %>%
  filter(!is.na(disability)) %>%
  ggplot(aes(x = Week, group = disability)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)") +
  facet_wrap(~disability, ncol = 1) +
  theme_pubclean()
  
```


### 3+ Children

```{r spline-final-169}
emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  mutate(child3 = factor(child3, labels = c("3+ children", "Everyone else"))) %>%
  filter(!is.na(child3)) %>%
  ggplot(aes(x = Week, group = child3)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)") +
  facet_wrap(~child3, ncol = 1) +
  theme_pubclean()
  
```


## Grouping 

This group represents the combination of Black, low income, and single caregivers. 

```{r spline-final-170}
emotion_g = emotion_g %>%
  mutate(newgroup = case_when(
    black == 0 ~ 1,
    poverty150 == 0 ~ 1,
    single == 0 ~ 1, 
    !is.na(black) ~ 0,
    !is.na(poverty150) ~ 0,
    !is.na(single) ~ 0,
    TRUE ~ NA_real_)) 

emotion_g %>%
  mutate_at(vars(fussy, fear, stress), scale, center = T, scale = F) %>%
  mutate(newgroup = factor(newgroup, labels = c("Everyone else", "New Group"))) %>%
  filter(!is.na(newgroup)) %>%
  ggplot(aes(x = Week, group = newgroup)) +
  geom_line(aes(y = fussy, 
                color = "Child Internalizing"), 
            stat = "summary", fun = "mean") + 
  geom_line(aes(y = fear, 
                color = "Child Externalizing"), 
            stat = "summary", 
            fun = "mean") + 
  geom_line(aes(y = stress, 
                color = "Caregiver Stress"), 
            stat = "summary", fun = "mean") +
  scale_x_continuous(breaks = c(1:10))+
  scale_y_continuous("Response (centered)") +
  facet_wrap(~newgroup, ncol = 1) +
  theme_pubclean()


```

