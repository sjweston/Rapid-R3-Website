---
title: "Open-ended responses"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---



```{r chunk 1, echo = F}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(knitr.kable.NA = '')
```

```{r packages}
library(here)
library(stm)
library(tidytext)
library(furrr)
library(ggpubr)
library(psych)
library(conflicted)
```

```{r}
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
#source(here("Scripts/score data.R")) 
load(here("data/scored.Rdata"))
source(here("Functions/pomp.R"))
conflict_prefer("map", "purrr")

```

```{r prep open-ended responses for tokenizing}
open_ended = scored %>%
  filter(language != "ES") %>%
  filter(language != "SPA") %>%
  select(-contains("OPEN.006")) %>%
  gather("question", "response", contains("OPEN")) %>%
  mutate(question = str_extract(question, ".$")) %>%
  filter(!is.na(response)) %>%
  group_by(question) %>%
  nest()
```

# Question 1{.tabset}

*What are the biggest challenges and concerns for you and your family right now?*

## How many topics

```{r prep q1, results='hide'}
processed1 <- textProcessor(open_ended$data[[1]]$response, metadata = open_ended$data[[1]])
out1 <- prepDocuments(processed1$documents, processed1$vocab, processed1$meta)
docs1 <- out1$documents
vocab1 <- out1$vocab
meta1 <- out1$meta

heldout1 = make.heldout(docs1, vocab1)
```

```{r models q1, eval = F}

set.seed(07312020)
plan(multiprocess)

many_models1 <- tibble(K = c(2, 3, 5, 10, 15, 20, 25, 30, 40, 50, 60, 70 , 80, 90)) %>%
  mutate(topic_model = future_map(K, ~stm(heldout1$documents, heldout1$vocab, K = .,
                                          verbose = FALSE)))
k_result1 <- many_models1 %>%
  mutate(exclusivity = map(topic_model, exclusivity),
         semantic_coherence = map(topic_model, semanticCoherence, heldout1$documents),
         eval_heldout = map(topic_model, eval.heldout, heldout1$missing),
         residual = map(topic_model, checkResiduals, heldout1$documents),
         bound =  map_dbl(topic_model, function(x) max(x$convergence$bound)),
         lfact = map_dbl(topic_model, function(x) lfactorial(x$settings$dim$K)),
         lbound = bound + lfact,
         iterations = map_dbl(topic_model, function(x) length(x$convergence$bound)))

save(many_models1, k_result1, file = here("../../Data Management R3/R Data/open1_many_models.Rdata"))
```

```{r}
load(here("../../Data Management R3/R Data/open1_many_models.Rdata"))
```



```{r}
k_result1 %>%
  transmute(K,
            `Lower bound` = lbound,
            Residuals = map_dbl(residual, "dispersion"),
            `Semantic coherence` = map_dbl(semantic_coherence, mean),
            `Held-out likelihood` = map_dbl(eval_heldout, "expected.heldout")) %>%
  gather(Metric, Value, -K) %>%
  ggplot(aes(K, Value, color = Metric)) +
  geom_line(size = 1.5, alpha = 0.7, show.legend = FALSE) +
  facet_wrap(~Metric, scales = "free_y") +
  scale_x_continuous(breaks = seq(0,90,10))+
  labs(x = "K (number of topics)",
       y = NULL,
       title = "Model diagnostics by number of topics",
       subtitle = "These diagnostics indicate that a good number of topics would around 25, 40, or 60") +
  theme_pubclean()
```

```{r}
k_result1 %>%
  select(K, exclusivity, semantic_coherence) %>%
  filter(K %in% c(25, 40, 60)) %>%
  unnest(cols = c(exclusivity, semantic_coherence)) %>%
  mutate(K = as.factor(K)) %>%
  ggplot(aes(semantic_coherence, exclusivity, color = K)) +
  stat_ellipse()+
  geom_point(size = 2, alpha = 0.7) +
  labs(x = "Semantic coherence",
       y = "Exclusivity",
       title = "Comparing exclusivity and semantic coherence",
       subtitle = "Decide to model 25 topics")+
  theme_pubr()
```

```{r, eval = F}
topics_rapid1 <- stm(documents = docs1, 
                    vocab = vocab1,
                    K = 25, 
                    prevalence =~ black + s(Week),
                    data = meta1, 
                    init.type = "Spectral")

prep1 = estimateEffect(1:25 ~ black + s(Week), 
                       topics_rapid1, 
                       meta = meta1)
save(topics_rapid1, prep1, file = here("../../Data Management R3/R Data/open1_fit.Rdata"))
```

```{r}
load(file = here("../../Data Management R3/R Data/open1_fit.Rdata"))
```

## Most common topics

```{r}
td_beta1 <- tidy(topics_rapid1)
td_gamma1 <- tidy(topics_rapid1, matrix = "gamma")

meta1 = meta1 %>%
  mutate(document = row_number())


top_terms <- td_beta1 %>%
  arrange(beta) %>%
  group_by(topic) %>%
  top_n(7, beta) %>%
  arrange(-beta) %>%
  select(topic, term) %>%
  summarise(terms = list(term)) %>%
  mutate(terms = map(terms, paste, collapse = ", ")) %>% 
  unnest(cols = c(terms))

gamma_terms <- td_gamma1 %>%
  group_by(topic) %>%
  summarise(gamma = mean(gamma)) %>%
  arrange(desc(gamma)) %>%
  left_join(top_terms, by = "topic") %>%
  mutate(topic = paste0("Topic ", topic),
         topic = reorder(topic, gamma))

gamma_terms %>%
  top_n(20, gamma) %>%
  ggplot(aes(topic, gamma, label = terms, fill = topic)) +
  geom_col(show.legend = FALSE) +
  geom_text(hjust = 0, nudge_y = 0.0005, size = 3) +
  scale_y_continuous(limits =c(0, .10))+
  coord_flip() +
  #theme_tufte(base_family = "IBMPlexSans", ticks = FALSE) +
  labs(x = NULL, y = expression(gamma),
       title = "Top 20 topics by prevalence response to Q1",
       subtitle = "With the top words that contribute to each topic") +
  theme_pubr()
```

## Identify topics{.tabset}

### All topics

```{r}
labelTopics(topics_rapid1)
```

### 2 - Paying the bills

```{r}
labelTopics(topics_rapid1, topics = 2)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 2, n = 5)
```

### 3 - Juggling obligations

```{r}
labelTopics(topics_rapid1, topics = 3)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 3, n = 5)
```

### 4 - Deciding what to do about school

```{r}
labelTopics(topics_rapid1, topics = 4)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 4, n = 5)
```

### 5 - Young children

```{r}
labelTopics(topics_rapid1, topics = 5)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 5, n = 5)
```
### 9 - Balancing WFM with childcare

```{r}
labelTopics(topics_rapid1, topics = 9)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 9, n = 5)
```

### 10 - Public spaces and community disengagement

```{r}
labelTopics(topics_rapid1, topics = 10)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 10, n = 5)
```

### 11 - Too much time together

```{r}
labelTopics(topics_rapid1, topics = 11)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 11, n = 5)
```

### 12 - Emotional and financial fear (Sp)

```{r}
labelTopics(topics_rapid1, topics = 12)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 12, n = 5)
```

### 14 - Managing family safety and sanity

```{r}
labelTopics(topics_rapid1, topics = 14)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 14, n = 5)
```


### 16 - Unable to visit family 

```{r}
labelTopics(topics_rapid1, topics = 16)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 16, n = 5)
```

### 19 - Trouble receiving unemployment

```{r}
labelTopics(topics_rapid1, topics = 19)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 19, n = 5)
```

### 21 - Fear about the unknown

```{r}
labelTopics(topics_rapid1, topics = 21)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 21, n = 5)
```

### 23 - Health and financial stability

```{r}
labelTopics(topics_rapid1, topics = 23)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 23, n = 5)
```

### 24 - Distance from others

```{r}
labelTopics(topics_rapid1, topics = 24)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 24, n = 8)
```

### 25 - Managing kids' behvaior

```{r}
labelTopics(topics_rapid1, topics = 25)
findThoughts(topics_rapid1, texts = out1$meta$response, topics = 25, n = 5)
```

## Topics by demographic{.tabset}

### Black/African American

```{r}

gamma_terms <- td_gamma1 %>%
  full_join(meta1) %>%
  group_by(topic, black) %>%
  summarise(gamma = mean(gamma)) %>%
  arrange(desc(gamma)) %>%
  left_join(top_terms, by = "topic") %>%
  mutate(topic = paste0("Topic ", topic),
         topic = reorder(topic, gamma))

gamma_terms %>%
  group_by(black) %>%
  top_n(15, gamma) %>%
  mutate(black = factor(black, levels = c(0,1), labels = c("Not Black", "Black"))) %>%
  ggplot(aes(reorder(topic,gamma), gamma, label = terms, fill = topic)) +
  geom_col(show.legend = FALSE) +
  geom_text(hjust = 0, nudge_y = 0.0005, size = 3) +
  scale_y_continuous(limits =c(0, .2))+
  coord_flip() +
  #theme_tufte(base_family = "IBMPlexSans", ticks = FALSE) +
  labs(x = NULL, y = expression(gamma),
       title = "Top 15 topics by prevalence response to Q1",
       subtitle = "With the top words that contribute to each topic") +
  facet_wrap(~black, scales = "free")+
  theme_pubr()
```

```{r}
big_diff = gamma_terms %>%
  filter(!is.na(black)) %>%
  select(-terms) %>%
  spread(black, gamma) %>%
  mutate(diff = `1`-`0`) %>%
  arrange(desc(abs(diff))) 

gamma_terms %>%
  filter(topic %in% big_diff$topic[1:5]) %>%
  filter(!is.na(black)) %>%
  group_by(black) %>%
  top_n(20, gamma) %>%
  mutate(black = factor(black, levels = c(0,1), labels = c("Not Black", "Black"))) %>%
  ggplot(aes(reorder(topic,gamma), gamma, label = terms, fill = black))+
  geom_col(position = "dodge") +
  coord_flip() +
  labs(x = NULL, y = expression(gamma), title = "Differences among income groups", fill = NULL)+
  theme_pubr()
```


### Poverty

```{r}

gamma_terms <- td_gamma1 %>%
  full_join(meta1) %>%
  group_by(topic, poverty150) %>%
  summarise(gamma = mean(gamma)) %>%
  arrange(desc(gamma)) %>%
  left_join(top_terms, by = "topic") %>%
  mutate(topic = paste0("Topic ", topic),
         topic = reorder(topic, gamma))

gamma_terms %>%
  filter(!is.na(poverty150)) %>%
  group_by(poverty150) %>%
  top_n(15, gamma) %>%
  mutate(poverty150 = factor(poverty150, levels = c(0,1), labels = c("High Income", "Low Income"))) %>%
  ggplot(aes(reorder(topic,gamma), gamma, label = terms, fill = topic)) +
  geom_col(show.legend = FALSE) +
  geom_text(hjust = 0, nudge_y = 0.0005, size = 3) +
  scale_y_continuous(limits =c(0, .2))+
  coord_flip() +
  #theme_tufte(base_family = "IBMPlexSans", ticks = FALSE) +
  labs(x = NULL, y = expression(gamma),
       title = "Top 15 topics by prevalence response to Q1",
       subtitle = "With the top words that contribute to each topic") +
  facet_wrap(~poverty150, scales = "free")+
  theme_pubr()
```


```{r}
big_diff = gamma_terms %>%
  filter(!is.na(poverty150)) %>%
  select(-terms) %>%
  spread(poverty150, gamma) %>%
  mutate(diff = `1`-`0`) %>%
  arrange(desc(abs(diff))) 

gamma_terms %>%
  filter(topic %in% big_diff$topic[1:5]) %>%
  filter(!is.na(poverty150)) %>%
  group_by(poverty150) %>%
  top_n(20, gamma) %>%
  mutate(poverty150 = factor(poverty150, levels = c(0,1), 
                             labels = c("High Income", "Low Income"))) %>%
  ggplot(aes(reorder(topic,gamma), gamma, label = terms, fill = poverty150))+
  geom_col(position = "dodge") +
  coord_flip() +
  labs(x = NULL, y = expression(gamma), 
       title = "Differences among income groups", fill = NULL)+
  theme_pubr()
```

## Topics by week

```{r}
library(brolgar)
gamma_terms <- td_gamma1 %>%
  full_join(meta1) %>%
  group_by(topic, Week) %>%
  summarise(gamma = mean(gamma)) %>%
  arrange(desc(gamma)) %>%
  left_join(top_terms, by = "topic") %>%
  mutate(topic = paste0("Topic ", topic),
         topic = reorder(topic, gamma)) %>%
  ungroup()

gamma_terms = as_tsibble(gamma_terms,
                         index = Week, 
                         key = topic)

gamma_terms %>%
  ggplot(aes(x = Week, y = gamma, color = topic)) +
  geom_line() + 
  facet_strata(n_strata = 6) +
  guides(colour = guide_legend(nrow = 3))+
  #guides(color = F)+
  theme_pubclean()

gamma_terms %>%
  #filter(grepl("(2[5-9])|(30)", topic)) %>%
#  filter(grepl("1[1-2]$", topic)) %>%
  filter(topic  %in% c("Topic 4", "Topic 9", "Topic 12")) %>%
  ggplot(aes(x = Week, y = gamma, color = topic)) +
  geom_line() + 
  guides(colour = guide_legend(nrow = 1))+
  theme_pubclean()

```

## Topic clusters{.tabset}

### Topic structure

```{r}
gamma_terms_wide <- td_gamma1 %>%
  full_join(meta1) %>%
  mutate(topic = paste0("Topic", topic)) %>%
  spread(topic, gamma) 

topics_only_wide = gamma_terms_wide %>%
  select(starts_with("Topic"))

iclust(topics_only_wide)
```

### Topic structure (Black respondants only)

```{r}
gamma_terms_wide <- td_gamma1 %>%
  full_join(meta1) %>%
  mutate(topic = paste0("Topic", topic)) %>%
  spread(topic, gamma) 

topics_only_wide = gamma_terms_wide %>%
  filter(black == 1) %>%
  select(starts_with("Topic"))

iclust(topics_only_wide)
```

### Cluster 1

```{r}
findThoughts(topics_rapid1, texts = out1$meta$response, 
             topics = c(17,1,6,24,22,13,4,21), n = 5)
```

### Cluster 2

```{r}
findThoughts(topics_rapid1, texts = out1$meta$response, 
             topics = c(5, 20, 2, 3, 25, 12, 9, 11), n = 5)
```

### Cluster 3

```{r}
findThoughts(topics_rapid1, texts = out1$meta$response, 
             topics = c(23,  18, 19, 15, 7), n = 5)
```

### Doublet 1

```{r}
findThoughts(topics_rapid1, texts = out1$meta$response, 
             topics = c(16, 10), n = 5)
```

### Doublet 2

```{r}
findThoughts(topics_rapid1, texts = out1$meta$response, 
             topics = c(8, 14), n = 5)
```

