---
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
params: 
  subset: "black_cat"
  title: "my title!"
  grp.name: "Test"
title: "`r params$title`"
---



```{r usda-1, echo = F, include = F}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width=10)
options(knitr.kable.NA = '')
library(lme4)
library(broom.mixed)
library(sjPlot)
library(ggpubr)
library(here)
```

```{r}
source(here("Scripts/score data.R"))
source(here("Functions/core_funs.R"))
scored$group = scored[,params$subset]
scored = mutate(scored, 
                group_f = ifelse(group == 1, params$grp.name, "Everyone else"))

# score discrimination questions
concernvars = names(scored)[grepl("^riserconcern", names(scored))]
scored$composite_concern = rowMeans(scored[,concernvars], na.rm=T)

discrimvars = names(scored)[grepl("^discrim", names(scored))]
scored$discrimination = rowMeans(scored[,discrimvars], na.rm=T)

```

# Participation

```{r}
last_assessment = scored %>%
  group_by(CaregiverID) %>%
  filter(Week == max(Week)) %>%
  ungroup()
n_groups = table(last_assessment$group_f)
n_groups = n_groups[params$grp.name]

scored = scored %>%
   mutate(Week = case_when(
    Week < 17 ~ Week,
    Week %% 2 == 0 ~ NA_real_,
    TRUE ~ Week
  )) %>%
  filter(!is.na(Week)) %>%
  mutate(wellbeing = 100-mental_health,
         child_wellbeing = 100-child_mental,
         unemployed_cat = ifelse(unemployed == 1, "Unemployed", "Employed"))
```

Since the beginning of the survey, `r prettyNum(n_groups, big.mark = ",")` `r str_remove(params$grp.name, " caregivers")` caregivers have participated in RAPID. 

```{r}
count_by_week(group, params$grp.name)
```

# Demographics{.tabset}

## Age

```{r}
dist_cat(age, data = filter(scored, group == 1))
```

## Income

Income is presented in thousands of dollars per year.

```{r}
dist_cat_group(income.cat, group_f, scored)
```

## Poverty

```{r}
dist_cat_group(poverty_cat, group_f, scored)
```

## Employment

```{r}
dist_cat_group(work_status, group_f, scored)
```

## Employment change

```{r}
dist_cat_group(employment_change, group_f, scored)
```

## Race

```{r}
dist_cat_group(race_cat, group_f, scored)
```

## Ethnicity

```{r}
dist_cat_group(latinx_cat, group_f, scored)
```

## Single parent households

```{r}
dist_cat_group(single_cat, group_f, scored)
```

# Well-being{.tabset} 

## Caregiver well-being{.tabset}

### On average

```{r}
average_by_group(mental_health, group_f, "mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(mental_health, group_f, "mental health problems")
```

## Anxiety{.tabset}

### On average

```{r}
average_by_group(anxiety, group_f, "mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(anxiety, group_f, "mental health problems")
```


## Depression{.tabset}

### On average

```{r}
average_by_group(depress, group_f, "mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(depress, group_f, "mental health problems")
```


## Stress{.tabset}

### On average

```{r}
average_by_group(stress, group_f, "mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(stress, group_f, "mental health problems")
```


## Loneliness{.tabset}

### On average

```{r}
average_by_group(lonely, group_f, "mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(lonely, group_f, "mental health problems")
```

## Child{.tabset}

### On average

```{r}
average_by_group(child_mental, group_f, "child mental health problems", last_assessment)
```

### Over time

```{r}
average_by_week(child_mental, group_f, "child mental health problems")
```

# Material hardship{.tabset}

## Overall

```{r}
percent_by_group(material_hardship, group_f, last_assessment)
```

## Types of hardship

```{r}
plot = scored %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(material_hardship)) %>%
  group_by(CaregiverID) %>%
  dplyr::filter(Week == max(Week)) %>%
  ungroup() %>%
  select(group_f, starts_with("diff_pay")) %>%
  gather(category, response, starts_with("diff_pay")) %>%
  mutate(category = str_remove(category, "diff_pay_")) %>%
  dplyr::filter(!is.na(response)) %>%
  group_by(group_f, category) %>%
  summarize(
    n = n(),
    percent = mean(response)) %>%
  mutate(moe = map2_dbl(percent, n, moe.p)) %>%
  mutate_at(vars(percent, moe), ~100*.x) %>%
  ggplot(aes(
    x = reorder(category, desc(percent)), 
    y = percent, 
    fill = percent,
    text = paste0(round(percent,1), "%"))) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = percent-moe, 
                    ymax = percent + moe), 
                width = .2) +
  coord_flip() +
  labs(x = NULL, y = NULL, fill = NULL, title = "Percent of households having difficulty paying for:") +
  facet_wrap(~group_f, ncol = 2) +
  theme_pubr()

ggplotly(plot, tooltip = "text")
```

```{r}

```



## By Week

```{r}
percent_by_week(material_hardship, group_f)
```


# Childcare{.tabset}

## On average

```{r}
percent_by_group(cc2_nonparental, group_f, last_assessment)
```

## Type of childcare (average)

```{r}
plot = scored %>%
  select(CaregiverID, Week, Date, group_f, starts_with("cc2_")) %>%
  dplyr::filter(Week != 13) %>%
  dplyr::filter(Week != 27) %>%
  dplyr::filter(Week != 29) %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(cc2_nonparental)) %>%
  select(-cc2_expected_change) %>%
  select(-cc2_nonparental) %>%
  gather(variable, value, starts_with("cc2_")) %>%
  mutate(variable = str_remove(variable, "cc2_")) %>%
  dplyr::filter(Week != 4) %>%
  group_by(CaregiverID, variable) %>% 
  filter(Week == max(Week)) %>%
  ungroup() %>%
  group_by(variable, group_f) %>%
  summarize(n = n(),
            percent = sum(value)/n) %>%
  mutate(moe = map2_dbl(percent, n, moe.p)) %>%
  mutate_at(vars(percent, moe), ~100*.x) %>%
  ggplot(aes(x = variable, 
             y = percent,
             group = variable,
             fill = variable,
             text = paste0(
               "N: ", n,
               "\nPercent: ", round(percent,1)
             ))) +
  geom_bar(stat = "identity")+
  geom_errorbar(aes(ymin = percent-moe, ymax = percent + moe), alpha = .2) +
  facet_wrap(~group_f, ncol = 1) +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```

## Type of childcare (over time)

```{r}
plot = scored %>%
  select(Week, Date, group_f, starts_with("cc2_")) %>%
  dplyr::filter(Week != 13) %>%
  dplyr::filter(Week != 27) %>%
  dplyr::filter(Week != 29) %>%
  dplyr::filter(!is.na(group_f)) %>%
  dplyr::filter(!is.na(cc2_nonparental)) %>%
  select(-cc2_expected_change) %>%
  gather(variable, value, starts_with("cc2_")) %>%
  mutate(variable = str_remove(variable, "cc2_")) %>%
  dplyr::filter(Week != 4 | variable == "cc2_nonparental") %>%
  group_by(Week, variable, group_f) %>%
  summarize(Date = min(Date,na.rm=T),
            n = n(),
            percent = sum(value)/n) %>%
  mutate(
    Date = case_when(
      Week == 0 ~ as.Date("2020-04-13"),
      TRUE ~ Date),
    label = case_when(
      Week == 0 ~ "Pre-pandemic",
      TRUE ~ format(Date, "%B %d")
    ),
    moe = map2_dbl(percent, n, moe.p)) %>%
  mutate_at(vars(percent, moe), ~100*.x) %>%
  ggplot(aes(x = Date, 
             y = percent,
             group = variable,
             fill = variable,
             text = paste0(
               "N: ", n,
               "\nPercent: ", round(percent,1),
               "\nDate: ", label
             ))) +
  geom_ribbon(aes(ymin = percent-moe, ymax = percent + moe), alpha = .2) +
  geom_line() +
  facet_wrap(~group_f, ncol = 1) +
  theme_pubclean()

ggplotly(plot, tooltip = "text")
```


## By week

```{r}
percent_by_week(cc2_nonparental, group_f)
```


# Discrimination{.tabset}

## Concerns for children (average)

```{r}
dist_cont_group(composite_concern, group_f)
```


```{r}
average_by_group(composite_concern, group_f, 
                 "Concerns for children (RISER)", last_assessment)
```

## Concerns for children (over time)

```{r}
average_by_week(composite_concern, group_f, "Concerns for children (RISER)")
```

## Caregiver well-being

```{r}
model.wb.concern = lmer(wellbeing ~ group_f*composite_concern + (1|CaregiverID),
                        data = scored)
model.wb.concern.sig = broom.mixed::tidy(model.wb.concern)

model.wb.concern.sig = model.wb.concern.sig %>%
  filter(grepl(":",term))

model.wb.concern.sig = ifelse(abs(model.wb.concern.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between well-being and concerns for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between well-being and concerns for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.wb.concern.sig`

```{r}
plot_model(model.wb.concern, 
           type = "pred", 
           terms = c("composite_concern", "group_f"),
           axis.title = c("Concerns for children", 
                          "Caregiver well-being"),
           legend.title = "Group") +
  theme_pubr()
```

## Child well-being

```{r}
model.cwb.concern = lmer(child_wellbeing ~ group_f*composite_concern + (1|CaregiverID),
                        data = scored)
model.cwb.concern.sig = broom.mixed::tidy(model.cwb.concern)

model.cwb.concern.sig = model.cwb.concern.sig %>%
  filter(grepl(":",term))

model.cwb.concern.sig = ifelse(abs(model.cwb.concern.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between child well-being and concerns for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between child well-being and concerns for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.cwb.concern.sig`

```{r}
plot_model(model.cwb.concern, 
           type = "pred", 
           terms = c("composite_concern", "group_f"),
           axis.title = c("Concerns for children", 
                          "Child well-being"),
           legend.title = "Group") +
  theme_pubr()
```


## Discrimination (average)

```{r}
dist_cont_group(discrimination, group_f)
```


```{r}
average_by_group(discrimination, group_f, 
                 "Concerns for children (RISER)", last_assessment)
```

## Discrimination (over time)

```{r}
average_by_week(discrimination, group_f, "Concerns for children (RISER)")
```

## Caregiver well-being

```{r}
model.wb.discrim = lmer(wellbeing ~ group_f*discrimination + (1|CaregiverID),
                        data = scored)
model.wb.discrim.sig = broom.mixed::tidy(model.wb.discrim)

model.wb.discrim.sig = model.wb.discrim.sig %>%
  filter(grepl(":",term))

model.wb.discrim.sig = ifelse(abs(model.wb.discrim.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between well-being and discrimination for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between well-being and discrimination for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.wb.discrim.sig`

```{r}
plot_model(model.wb.discrim, 
           type = "pred", 
           terms = c("discrimination", "group_f"),
           axis.title = c("Experiences of discrimination", 
                          "Caregiver well-being"),
           legend.title = "Group") +
  theme_pubr()
```


## Child well-being

```{r}
model.cwb.discrim = lmer(child_wellbeing ~ group_f*discrimination + (1|CaregiverID),
                        data = scored)
model.cwb.discrim.sig = broom.mixed::tidy(model.cwb.discrim)

model.cwb.discrim.sig = model.cwb.discrim.sig %>%
  filter(grepl(":",term))

model.cwb.discrim.sig = ifelse(abs(model.cwb.discrim.sig$statistic[[1]]) > 1.96, 
                              paste("The relationship between child well-being and discrimination for children is significantly different for", params$grp.name, "caregivers"),
                              paste("The relationship between child well-being and discrimination for children is NOT significantly different for", params$grp.name, "caregivers"))
```

`r model.cwb.discrim.sig`

```{r}
plot_model(model.cwb.discrim, 
           type = "pred", 
           terms = c("discrimination", "group_f"),
           axis.title = c("Experiences of discrimination", 
                          "Child well-being"),
           legend.title = "Group") +
  theme_pubr()
```


